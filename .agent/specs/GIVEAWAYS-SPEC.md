# üéÅ GIVEAWAYS SPECIFICATION

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 12.12.2025
**–°—Ç–∞—Ç—É—Å:** –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ

---

## üìñ –ö–û–ù–¶–ï–ü–¶–ò–Ø

**Giveaways (–†–æ–∑—ã–≥—Ä—ã—à–∏)** ‚Äî –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ —Å –ø–æ–∫—É–ø–∫–æ–π –±–∏–ª–µ—Ç–æ–≤ –∑–∞ –ø—Ä–µ–º–∏—É–º –≤–∞–ª—é—Ç—É **AR**.

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ë–∏–ª–µ—Ç—ã** ‚Äî –ø–æ–∫—É–ø–∞—é—Ç—Å—è –∑–∞ AR, –∫–∞–∂–¥—ã–π –±–∏–ª–µ—Ç = —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
2. **–î–∂–µ–∫–ø–æ—Ç** ‚Äî —Ä–∞—Å—Ç—ë—Ç –æ—Ç –ø—Ä–æ–¥–∞–∂ –±–∏–ª–µ—Ç–æ–≤
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã** ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
4. **Auto-Clone** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
5. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** ‚Äî –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∏–¥–Ω—ã –≤ LiveArena

---

## üé´ –ú–ï–•–ê–ù–ò–ö–ê –ë–ò–õ–ï–¢–û–í

### –ü–æ–∫—É–ø–∫–∞ –±–∏–ª–µ—Ç–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ (1, 5, 10, 50, ...)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å AR
3. –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –±–∏–ª–µ—Ç–æ–≤
4. AR —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å –±–∞–ª–∞–Ω—Å–∞
5. –ß–∞—Å—Ç—å AR –∏–¥—ë—Ç –≤ –¥–∂–µ–∫–ø–æ—Ç

### –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤
- –ù–æ–º–µ—Ä–∞ –±–∏–ª–µ—Ç–æ–≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã **–≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞**
- –§–æ—Ä–º–∞—Ç: `1, 2, 3, ..., N`
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –Ω–∞—á–∏–Ω–∞—è —Å `MAX(ticket_number) + 1`

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ú–∏–Ω–∏–º—É–º 1 –±–∏–ª–µ—Ç –∑–∞ —Ä–∞–∑
- –ú–∞–∫—Å–∏–º—É–º 100 –±–∏–ª–µ—Ç–æ–≤ –∑–∞ —Ä–∞–∑ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞)
- –ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç –ø–æ—Å–ª–µ `end_date` —Ä–æ–∑—ã–≥—Ä—ã—à–∞

---

## üí∞ –ú–ï–•–ê–ù–ò–ö–ê –î–ñ–ï–ö–ü–û–¢–ê

### –§–æ—Ä–º—É–ª–∞ –¥–∂–µ–∫–ø–æ—Ç–∞
```
jackpot += ticket_price_ar √ó count √ó (jackpot_percentage / 100)
```

**–ü—Ä–∏–º–µ—Ä:**
- –¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞: 10 AR
- –ö—É–ø–ª–µ–Ω–æ: 5 –±–∏–ª–µ—Ç–æ–≤
- `jackpot_percentage`: 80%
- –î–∂–µ–∫–ø–æ—Ç —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞: `10 √ó 5 √ó 0.8 = 40 AR`

### –û—Å—Ç–∞—Ç–æ–∫ AR
```
platform_fee = ticket_price_ar √ó count √ó (1 - jackpot_percentage / 100)
```

**–ü—Ä–∏–º–µ—Ä:**
- –¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞: 10 AR
- –ö—É–ø–ª–µ–Ω–æ: 5 –±–∏–ª–µ—Ç–æ–≤
- `jackpot_percentage`: 80%
- –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã: `10 √ó 5 √ó 0.2 = 10 AR`

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∂–µ–∫–ø–æ—Ç–∞
–î–∂–µ–∫–ø–æ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏ –ø–æ –º–µ—Å—Ç–∞–º:
- **1 –º–µ—Å—Ç–æ:** 50% –¥–∂–µ–∫–ø–æ—Ç–∞
- **2 –º–µ—Å—Ç–æ:** 30% –¥–∂–µ–∫–ø–æ—Ç–∞
- **3 –º–µ—Å—Ç–æ:** 20% –¥–∂–µ–∫–ø–æ—Ç–∞

**–ü—Ä–∏–º–µ—Ä:**
- –î–∂–µ–∫–ø–æ—Ç: 1000 AR
- 1 –º–µ—Å—Ç–æ: 500 AR
- 2 –º–µ—Å—Ç–æ: 300 AR
- 3 –º–µ—Å—Ç–æ: 200 AR

---

## üé≤ –ì–ï–ù–ï–†–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í

### –ê–ª–≥–æ—Ä–∏—Ç–º
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –±–∏–ª–µ—Ç—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞
2. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞—Ç—å 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–∞ –±–∏–ª–µ—Ç–æ–≤
3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –±–∏–ª–µ—Ç–æ–≤
4. –ù–∞—á–∏—Å–ª–∏—Ç—å –ø—Ä–∏–∑—ã –ø–æ —Ñ–æ—Ä–º—É–ª–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∂–µ–∫–ø–æ—Ç–∞
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü—É `giveaway_results`
6. –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π

### –ü—Å–µ–≤–¥–æ–∫–æ–¥
```sql
SELECT ticket_number, user_id
FROM giveaway_tickets
WHERE giveaway_id = p_giveaway_id
ORDER BY RANDOM()
LIMIT 3;

-- 1 –º–µ—Å—Ç–æ: user_1 ‚Üí jackpot * 0.5
-- 2 –º–µ—Å—Ç–æ: user_2 ‚Üí jackpot * 0.3
-- 3 –º–µ—Å—Ç–æ: user_3 ‚Üí jackpot * 0.2
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–µ–π (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—É–ø–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∏–ª–µ—Ç–æ–≤)
- –ï—Å–ª–∏ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∏–≥—Ä–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏–∑ –∑–∞ –∫–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ
- –ü—Ä–∏–º–µ—Ä: user_1 –≤—ã–∏–≥—Ä–∞–ª 1 –∏ 3 –º–µ—Å—Ç–∞ ‚Üí –ø–æ–ª—É—á–∏—Ç 70% –¥–∂–µ–∫–ø–æ—Ç–∞

---

## üîÑ AUTO-CLONE –ú–ï–•–ê–ù–ò–ö–ê

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–†–æ–∑—ã–≥—Ä—ã—à —Å —Ñ–ª–∞–≥–æ–º `is_recurring = true` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–ª–æ–Ω–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.

### –ê–ª–≥–æ—Ä–∏—Ç–º
1. –ü—Ä–æ–≤–µ—Ä–∫–∞: `end_date` –ø—Ä–æ—à–ª–∞?
2. –ü—Ä–æ–≤–µ—Ä–∫–∞: `is_recurring = true`?
3. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ø–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞:
   - –ù–æ–≤—ã–µ `start_date`, `end_date` (—Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ `duration_days`)
   - –î–∂–µ–∫–ø–æ—Ç –æ–±–Ω—É–ª—è–µ—Ç—Å—è –∏–ª–∏ –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
   - –ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –±–∏–ª–µ—Ç–∞ ‚Äî –∫–æ–ø–∏—Ä—É—é—Ç—Å—è

### RPC —Ñ—É–Ω–∫—Ü–∏—è: `clone_giveaway()`
```sql
CREATE OR REPLACE FUNCTION clone_giveaway(p_old_giveaway_id INT)
RETURNS INT AS $$
DECLARE
  v_new_id INT;
  v_duration_days INT;
BEGIN
  -- –ü–æ–ª—É—á–∏—Ç—å duration_days —Å—Ç–∞—Ä–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
  SELECT duration_days INTO v_duration_days
  FROM giveaways
  WHERE id = p_old_giveaway_id;

  -- –°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é
  INSERT INTO giveaways (
    name, prize_description, ticket_price_ar, jackpot_percentage,
    is_recurring, duration_days, start_date, end_date, jackpot
  )
  SELECT
    name,
    prize_description,
    ticket_price_ar,
    jackpot_percentage,
    is_recurring,
    duration_days,
    NOW(), -- –Ω–æ–≤—ã–π start_date
    NOW() + INTERVAL '1 day' * v_duration_days, -- –Ω–æ–≤—ã–π end_date
    0 -- –¥–∂–µ–∫–ø–æ—Ç –æ–±–Ω—É–ª—è–µ—Ç—Å—è
  FROM giveaways
  WHERE id = p_old_giveaway_id
  RETURNING id INTO v_new_id;

  RETURN v_new_id;
END;
$$ LANGUAGE plpgsql;
```

### –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ (pg_cron)
```sql
-- –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ recurring —Ä–æ–∑—ã–≥—Ä—ã—à–∏
SELECT cron.schedule(
  'auto-clone-giveaways',
  '*/10 * * * *',
  $$
  SELECT clone_giveaway(id)
  FROM giveaways
  WHERE end_date < NOW()
    AND is_recurring = true
    AND NOT EXISTS (
      SELECT 1 FROM giveaways g2
      WHERE g2.start_date > giveaways.end_date
        AND g2.name = giveaways.name
    );
  $$
);
```

---

## üìä RPC –§–£–ù–ö–¶–ò–ò

### 1. `buy_giveaway_ticket_v2()`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–∫—É–ø–∫–∞ –±–∏–ª–µ—Ç–æ–≤ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `p_telegram_id` (BIGINT) ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `p_giveaway_id` (INT) ‚Äî ID —Ä–æ–∑—ã–≥—Ä—ã—à–∞
- `p_count` (INT) ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** JSON
```json
{
  "success": true,
  "tickets": [1234, 1235, 1236],
  "new_balance": 450,
  "jackpot": 1200
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ `end_date` –Ω–µ –ø—Ä–æ—à–ª–∞
2. –ü–æ–ª—É—á–∏—Ç—å `user_id` –ø–æ `telegram_id`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å AR: `balance_ar >= ticket_price_ar * p_count`
4. –ü–æ–ª—É—á–∏—Ç—å `MAX(ticket_number)` –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
5. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä–∞: `max + 1, max + 2, ..., max + p_count`
6. –°–ø–∏—Å–∞—Ç—å AR: `balance_ar -= ticket_price_ar * p_count`
7. –£–≤–µ–ª–∏—á–∏—Ç—å –¥–∂–µ–∫–ø–æ—Ç: `jackpot += ticket_price_ar * p_count * (jackpot_percentage / 100)`
8. –í—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ `giveaway_tickets`
9. –í–µ—Ä–Ω—É—Ç—å JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

**SQL (–ø—Ä–∏–º–µ—Ä–Ω—ã–π):**
```sql
CREATE OR REPLACE FUNCTION buy_giveaway_ticket_v2(
  p_telegram_id BIGINT,
  p_giveaway_id INT,
  p_count INT
)
RETURNS JSON AS $$
DECLARE
  v_user_id INT;
  v_balance_ar DECIMAL;
  v_ticket_price DECIMAL;
  v_jackpot_pct DECIMAL;
  v_max_ticket INT;
  v_new_tickets INT[];
  v_i INT;
  v_total_cost DECIMAL;
  v_jackpot_increase DECIMAL;
BEGIN
  -- –ü–æ–ª—É—á–∏—Ç—å user_id
  SELECT id, balance_ar INTO v_user_id, v_balance_ar
  FROM users
  WHERE telegram_id = p_telegram_id;

  IF v_user_id IS NULL THEN
    RETURN json_build_object('success', false, 'error', 'User not found');
  END IF;

  -- –ü–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞
  SELECT ticket_price_ar, jackpot_percentage INTO v_ticket_price, v_jackpot_pct
  FROM giveaways
  WHERE id = p_giveaway_id AND end_date > NOW();

  IF v_ticket_price IS NULL THEN
    RETURN json_build_object('success', false, 'error', 'Giveaway not found or ended');
  END IF;

  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
  v_total_cost := v_ticket_price * p_count;
  IF v_balance_ar < v_total_cost THEN
    RETURN json_build_object('success', false, 'error', 'Insufficient AR balance');
  END IF;

  -- –ü–æ–ª—É—á–∏—Ç—å max ticket_number
  SELECT COALESCE(MAX(ticket_number), 0) INTO v_max_ticket
  FROM giveaway_tickets
  WHERE giveaway_id = p_giveaway_id;

  -- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä–∞ –±–∏–ª–µ—Ç–æ–≤
  v_new_tickets := ARRAY[]::INT[];
  FOR v_i IN 1..p_count LOOP
    v_new_tickets := array_append(v_new_tickets, v_max_ticket + v_i);
    INSERT INTO giveaway_tickets (giveaway_id, user_id, ticket_number)
    VALUES (p_giveaway_id, v_user_id, v_max_ticket + v_i);
  END LOOP;

  -- –°–ø–∏—Å–∞—Ç—å AR –∏ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–∂–µ–∫–ø–æ—Ç
  v_jackpot_increase := v_total_cost * (v_jackpot_pct / 100);
  UPDATE users SET balance_ar = balance_ar - v_total_cost WHERE id = v_user_id;
  UPDATE giveaways SET jackpot = jackpot + v_jackpot_increase WHERE id = p_giveaway_id;

  -- –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∏ –¥–∂–µ–∫–ø–æ—Ç
  SELECT balance_ar INTO v_balance_ar FROM users WHERE id = v_user_id;
  SELECT jackpot INTO v_jackpot_increase FROM giveaways WHERE id = p_giveaway_id;

  RETURN json_build_object(
    'success', true,
    'tickets', v_new_tickets,
    'new_balance', v_balance_ar,
    'jackpot', v_jackpot_increase
  );
END;
$$ LANGUAGE plpgsql;
```

---

### 2. `generate_giveaway_result()`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `p_giveaway_id` (INT) ‚Äî ID —Ä–æ–∑—ã–≥—Ä—ã—à–∞

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** JSON
```json
{
  "success": true,
  "winners": [
    { "place": 1, "telegram_id": 123456, "ticket_number": 42, "prize_ar": 500 },
    { "place": 2, "telegram_id": 789012, "ticket_number": 17, "prize_ar": 300 },
    { "place": 3, "telegram_id": 345678, "ticket_number": 99, "prize_ar": 200 }
  ]
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ `end_date` –ø—Ä–æ—à–ª–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
3. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –±–∏–ª–µ—Ç—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞
4. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞—Ç—å 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –±–∏–ª–µ—Ç–∞
5. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–∑—ã (50%, 30%, 20% –æ—Ç –¥–∂–µ–∫–ø–æ—Ç–∞)
6. –ù–∞—á–∏—Å–ª–∏—Ç—å AR –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º
7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `giveaway_results`
8. –í–µ—Ä–Ω—É—Ç—å JSON —Å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏

**SQL (–ø—Ä–∏–º–µ—Ä–Ω—ã–π):**
```sql
CREATE OR REPLACE FUNCTION generate_giveaway_result(p_giveaway_id INT)
RETURNS JSON AS $$
DECLARE
  v_jackpot DECIMAL;
  v_winners JSON;
  v_ticket RECORD;
  v_place INT := 1;
  v_prize DECIMAL;
  v_prizes DECIMAL[] := ARRAY[0.5, 0.3, 0.2]; -- 50%, 30%, 20%
BEGIN
  -- –ü–æ–ª—É—á–∏—Ç—å –¥–∂–µ–∫–ø–æ—Ç
  SELECT jackpot INTO v_jackpot
  FROM giveaways
  WHERE id = p_giveaway_id AND end_date < NOW();

  IF v_jackpot IS NULL THEN
    RETURN json_build_object('success', false, 'error', 'Giveaway not found or not ended');
  END IF;

  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
  IF EXISTS (SELECT 1 FROM giveaway_results WHERE giveaway_id = p_giveaway_id) THEN
    RETURN json_build_object('success', false, 'error', 'Results already generated');
  END IF;

  -- –í—ã–±—Ä–∞—Ç—å 3 —Å–ª—É—á–∞–π–Ω—ã—Ö –±–∏–ª–µ—Ç–∞
  FOR v_ticket IN
    SELECT user_id, ticket_number
    FROM giveaway_tickets
    WHERE giveaway_id = p_giveaway_id
    ORDER BY RANDOM()
    LIMIT 3
  LOOP
    v_prize := v_jackpot * v_prizes[v_place];

    -- –ù–∞—á–∏—Å–ª–∏—Ç—å –ø—Ä–∏–∑
    UPDATE users SET balance_ar = balance_ar + v_prize WHERE id = v_ticket.user_id;

    -- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    INSERT INTO giveaway_results (giveaway_id, user_id, place, prize_ar, ticket_number)
    VALUES (p_giveaway_id, v_ticket.user_id, v_place, v_prize, v_ticket.ticket_number);

    v_place := v_place + 1;
  END LOOP;

  -- –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
  SELECT json_agg(
    json_build_object(
      'place', place,
      'telegram_id', u.telegram_id,
      'ticket_number', ticket_number,
      'prize_ar', prize_ar
    )
  ) INTO v_winners
  FROM giveaway_results gr
  JOIN users u ON gr.user_id = u.id
  WHERE giveaway_id = p_giveaway_id;

  RETURN json_build_object('success', true, 'winners', v_winners);
END;
$$ LANGUAGE plpgsql;
```

---

### 3. `clone_giveaway()`
–°–º. —Ä–∞–∑–¥–µ–ª "AUTO-CLONE –ú–ï–•–ê–ù–ò–ö–ê" –≤—ã—à–µ.

---

## üóÑÔ∏è –°–¢–†–£–ö–¢–£–†–ê –¢–ê–ë–õ–ò–¶

### `giveaways`
```sql
CREATE TABLE giveaways (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  prize_description TEXT,
  ticket_price_ar DECIMAL(10, 2) NOT NULL,
  jackpot DECIMAL(10, 2) DEFAULT 0,
  jackpot_percentage DECIMAL(5, 2) DEFAULT 80, -- –Ω–∞–ø—Ä–∏–º–µ—Ä, 80%
  is_recurring BOOLEAN DEFAULT false,
  duration_days INT DEFAULT 7,
  start_date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### `giveaway_tickets`
```sql
CREATE TABLE giveaway_tickets (
  id SERIAL PRIMARY KEY,
  giveaway_id INT NOT NULL REFERENCES giveaways(id) ON DELETE CASCADE,
  user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  ticket_number INT NOT NULL,
  purchased_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (giveaway_id, ticket_number) -- —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞ –≤ —Ä–∞–º–∫–∞—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞
);

CREATE INDEX idx_tickets_giveaway ON giveaway_tickets(giveaway_id);
CREATE INDEX idx_tickets_user ON giveaway_tickets(user_id);
```

### `giveaway_results`
```sql
CREATE TABLE giveaway_results (
  id SERIAL PRIMARY KEY,
  giveaway_id INT NOT NULL REFERENCES giveaways(id) ON DELETE CASCADE,
  user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  place INT NOT NULL CHECK (place BETWEEN 1 AND 3),
  prize_ar DECIMAL(10, 2) NOT NULL,
  ticket_number INT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (giveaway_id, place) -- –æ–¥–Ω–æ –º–µ—Å—Ç–æ = –æ–¥–∏–Ω –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
);

CREATE INDEX idx_results_giveaway ON giveaway_results(giveaway_id);
CREATE INDEX idx_results_user ON giveaway_results(user_id);
```

---

## üé® UI/UX

### GiveawaysPage (—Å–ø–∏—Å–æ–∫)
- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
- –§–∏–ª—å—Ç—Ä: –ê–∫—Ç–∏–≤–Ω—ã–µ / –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ
- –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏:
  - –ù–∞–∑–≤–∞–Ω–∏–µ
  - –î–∂–µ–∫–ø–æ—Ç (—Ç–µ–∫—É—â–∏–π)
  - –¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞
  - –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (—Ç–∞–π–º–µ—Ä)
  - –ö–Ω–æ–ø–∫–∞ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"

### GiveawayPage (–¥–µ—Ç–∞–ª—å–Ω–∞—è)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–∑–∞—Ö
- –¢–µ–∫—É—â–∏–π –¥–∂–µ–∫–ø–æ—Ç (–±–æ–ª—å—à–∏–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏, –∑–æ–ª–æ—Ç–æ)
- –¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞
- –¢–∞–π–º–µ—Ä –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
- –ö–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã" (CTA, –∑–æ–ª–æ—Ç–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç)
- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∏–ª–µ—Ç–æ–≤ (1, 5, 10, 50, 100)
- –°–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### LiveArena (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ –≤—Å–µ—Ö –±–∏–ª–µ—Ç–æ–≤
- –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ (–∑–æ–ª–æ—Ç–æ–º)
- –°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:
  - –ú–µ—Å—Ç–æ (1, 2, 3)
  - Username
  - –ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞
  - –ü—Ä–∏–∑ (AR)

---

## üìö LEGACY REFERENCE

–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (vanilla JS):
```
~/Desktop/AR ARENA VANILA –í–ï–†–°–ò–Ø/
‚îú‚îÄ‚îÄ giveaway.html     ‚Üê –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îú‚îÄ‚îÄ livearena.html    ‚Üê –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
‚îî‚îÄ‚îÄ giveaways.html    ‚Üê –°–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
```

---

## üéØ –ò–¢–û–ì–û

1. **–ü–æ–∫—É–ø–∫–∞ –±–∏–ª–µ—Ç–æ–≤:** `buy_giveaway_ticket_v2(telegram_id, giveaway_id, count)`
2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:** `generate_giveaway_result(giveaway_id)` (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ —Ç–∞–π–º–µ—Ä—É)
3. **Auto-Clone:** `clone_giveaway(old_id)` (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ pg_cron)
4. **–î–∂–µ–∫–ø–æ—Ç:** –†–∞—Å—Ç—ë—Ç –æ—Ç –ø—Ä–æ–¥–∞–∂, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è 50/30/20%
5. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∏–¥–Ω—ã –≤ LiveArena

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
**–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:** –ê–ª–µ–∫—Å–∞–Ω–¥—Ä
**–î–∞—Ç–∞:** 12.12.2025
