<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AR ARENA - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="admin-section-header.js"></script>
    <style id="section-header-styles"></style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
            padding: 20px 16px 90px;
            margin: 0;
        }

        /* –ì–ª–∞–≤–Ω—ã–π —Ö–µ–¥–µ—Ä –∞–¥–º–∏–Ω–∫–∏ */
        .admin-main-header {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.25);
            border-radius: 18px;
            padding: 24px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .admin-header-icon {
            filter: drop-shadow(0 4px 12px rgba(255, 215, 0, 0.5));
        }

        .admin-header-title {
            font-size: 24px;
            font-weight: 800;
            color: #FFD700;
            margin: 0;
            text-shadow: 0 2px 12px rgba(255, 215, 0, 0.4);
        }

        @media (max-width: 360px) {
            .admin-main-header {
                padding: 20px 16px;
            }

            .admin-header-icon {
                /* Natural icon size */
            }

            .admin-header-title {
                font-size: 20px;
            }
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,215,0,0.3);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .card-icon {
            flex-shrink: 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-icon img {
            filter: drop-shadow(0 0 0 transparent);
        }

        .card-icon .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            font-size: 10px;
            font-weight: 800;
            padding: 3px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }

        .card-icon .badge.alert {
            background: #ef4444;
            color: white;
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .card-description {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            line-height: 1.4;
            margin: 0;
        }

        .card-stats {
            display: none;
        }

        .card-stat-value {
            font-size: 13px;
            font-weight: 700;
            color: #FFD700;
            white-space: nowrap;
        }

        .card-stat-label {
            display: none;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑–¥–µ–ª–æ–≤ */
        .section-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 8px;
            padding: 10px;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-box-value {
            font-size: 22px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 4px;
            line-height: 1;
        }

        .stat-box-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* –¢–∞–±–ª–∏—Ü—ã */
        .table-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .table-container h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #FFD700;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .compact-table {
            max-height: 260px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(255, 215, 0, 0.06);
            color: #FFD700;
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.15);
        }

        td {
            padding: 6px 8px;
            color: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 12px;
            height: 30px;
            text-align: left;
        }

        tr:hover {
            background: rgba(255, 215, 0, 0.03);
        }

        /* –ê–≤–∞—Ç–∞—Ä–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .user-avatar-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .avatar-placeholder-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .referrer-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .avatar-placeholder-mini {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º */
        .balance-controls {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .balance-btn {
            width: 22px;
            height: 22px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .balance-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-btn {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .action-btn.danger {
            border-color: rgba(255, 100, 100, 0.3);
            color: #ff6464;
        }

        .action-btn.danger:hover {
            background: rgba(255, 100, 100, 0.1);
        }

        /* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
        td button + button {
            margin-left: 5px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(20, 20, 28, 0.98), rgba(15, 15, 20, 0.98));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #FFD700;
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #FFD700;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .modal-body {
            margin: 20px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            font-size: 12px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-footer button {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-footer button:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .modal-footer button.danger {
            background: rgba(255, 100, 100, 0.1);
            border-color: rgba(255, 100, 100, 0.3);
            color: #ff6464;
        }

        .modal-footer button.danger:hover {
            background: rgba(255, 100, 100, 0.2);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        .notification.error {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 375px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .admin-info {
                flex-direction: column;
                width: 100%;
            }

            .card {
                padding: 14px 10px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–≤–∏–∑–æ–≤ */
        .quiz-card {
            background: rgba(25, 25, 35, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .quiz-card:hover {
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.1);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .quiz-title {
            color: #FFD700;
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }

        .quiz-toggle {
            position: relative;
            width: 46px;
            height: 24px;
        }

        .quiz-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .quiz-info {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .quiz-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quiz-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .quiz-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .quiz-btn-edit {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .quiz-btn-edit:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
        }

        .quiz-btn-delete {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.2);
        }

        .quiz-btn-delete:hover {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(10,10,10,0.95);
            border: 2px solid #FFD700;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #FFD700;
            margin: 0;
        }

        .close-modal {
            font-size: 28px;
            color: #FFD700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            transform: scale(1.2);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255,255,255,0.08);
        }

        .btn-add-question {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-add-question:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-save {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 12px 30px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        #questions-container {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∫–≤–∏–∑–æ–≤ -->
    <div id="quiz-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–≤–∏–∑–∞</h2>
                <span class="close-modal" onclick="closeQuizModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="quiz-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞" class="input-field">
                <textarea id="quiz-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="input-field"></textarea>
                <input type="number" id="quiz-reward" placeholder="–ù–∞–≥—Ä–∞–¥–∞ AR" value="50" class="input-field">

                <div id="questions-container">
                    <!-- –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                </div>

                <button onclick="addQuestion()" class="btn-add-question">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 6px;">
                        <path d="M12 5V19M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
                </button>

                <textarea id="quiz-completion" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è" class="input-field"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="saveQuizFromModal()" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–≤–∏–∑</button>
                <button onclick="closeQuizModal()" class="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ -->
        <div id="mainPage" class="section-content active">
            <!-- –ì–ª–∞–≤–Ω—ã–π —Ö–µ–¥–µ—Ä –∞–¥–º–∏–Ω–∫–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π) -->
            <div class="admin-main-header">
                <img src="icons/admin.png" class="admin-header-icon" alt="Admin">
                <h1 class="admin-header-title">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
            </div>

            <div class="cards-grid">
                <!-- –î–∞—à–±–æ—Ä–¥ -->
                <div class="card" onclick="openSection('dashboard')">
                    <div class="card-icon">
                        <img src="/icons/dashboard.png?v=20251023" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–î–∞—à–±–æ—Ä–¥</div>
                        <div class="card-description">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    </div>
                </div>

                <!-- –†–µ—Ñ–µ—Ä–∞–ª—ã -->
                <div class="card" onclick="openSection('referrals')">
                    <div class="card-icon">
                        <img src="/icons/users.png?v=20251023" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–†–µ—Ñ–µ—Ä–∞–ª—ã</div>
                        <div class="card-description">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏</div>
                    </div>
                </div>

                <!-- –ó–∞–¥–∞–Ω–∏—è -->
                <div class="card" onclick="window.location.href='admin-tasks.html'">
                    <div class="card-icon">
                        <img src="/icons/tasks.png?v=20251023" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–ó–∞–¥–∞–Ω–∏—è</div>
                        <div class="card-description">–ö–≤–∏–∑—ã –∏ –æ–±—É—á–µ–Ω–∏–µ</div>
                    </div>
                </div>

                <!-- –ú–∞–≥–∞–∑–∏–Ω -->
                <div class="card" onclick="openSection('shop')">
                    <div class="card-icon">
                        <img src="/icons/SHOP.png?v=20251023" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–ú–∞–≥–∞–∑–∏–Ω</div>
                        <div class="card-description">–¢–æ–≤–∞—Ä—ã –∏ –ø—Ä–æ–¥–∞–∂–∏</div>
                    </div>
                </div>

                <!-- –°—É–Ω–¥—É–∫–∏ -->
                <div class="card" onclick="openSection('chests')">
                    <div class="card-icon">
                        <img src="/icons/chest.png" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–°—É–Ω–¥—É–∫–∏</div>
                        <div class="card-description">–ù–∞–≥—Ä–∞–¥—ã –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è</div>
                    </div>
                </div>

                <!-- –†–æ–∑—ã–≥—Ä—ã—à–∏ -->
                <div class="card" onclick="window.location.href='admin-giveaways-list.html'">
                    <div class="card-icon">
                        <img src="/icons/lottery.png" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–†–æ–∑—ã–≥—Ä—ã—à–∏</div>
                        <div class="card-description">–õ–æ—Ç–µ—Ä–µ–∏ –∏ –∫–æ–Ω–∫—É—Ä—Å—ã</div>
                    </div>
                </div>

                <!-- –§–∏–Ω–∞–Ω—Å—ã -->
                <div class="card" onclick="openSection('finance')">
                    <div class="card-icon">
                        <img src="/icons/coins.png" alt="">
                        <span class="badge" id="financeStat">1 227 041</span>
                    </div>
                    <div class="card-content">
                        <div class="card-title">–§–∏–Ω–∞–Ω—Å—ã</div>
                        <div class="card-description">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –±–∞–ª–∞–Ω—Å</div>
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="card" onclick="openSection('settings')">
                    <div class="card-icon">
                        <img src="/icons/settings-gear.png" alt="">
                        <span class="badge">10</span>
                    </div>
                    <div class="card-content">
                        <div class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                        <div class="card-description">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</div>
                    </div>
                </div>

                <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
                <div class="card" onclick="openSection('analytics')">
                    <div class="card-icon">
                        <img src="/icons/analytics-chart.png" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                        <div class="card-description">–û—Ç—á–µ—Ç—ã –∏ –º–µ—Ç—Ä–∏–∫–∏</div>
                    </div>
                </div>

                <!-- –õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞ -->
                <div class="card" onclick="openSection('logs')">
                    <div class="card-icon">
                        <img src="/icons/admin.png" alt="">
                    </div>
                    <div class="card-content">
                        <div class="card-title">–õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞</div>
                        <div class="card-description">–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –†–∞–∑–¥–µ–ª: –î–∞—à–±–æ—Ä–¥ -->
        <div id="dashboard" class="section-content">
            <div id="dashboard-header"></div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - 4 –ø–ª–∞—à–∫–∏ -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px;" id="totalUsers">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">–í—Å–µ–≥–æ</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px;" id="onlineNow">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">–û–Ω–ª–∞–π–Ω</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s;" onclick="showNewUsersCalendar()">
                    <div style="font-size: 24px; font-weight: 700; color: #4CAF50; margin-bottom: 4px;" id="newToday">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">–ù–æ–≤—ã—Ö</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s;" onclick="showChurnedUsersCalendar()">
                    <div style="font-size: 24px; font-weight: 700; color: #FF5722; margin-bottom: 4px;" id="churnedToday">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">–û—Ç–≤–∞–ª–∏–ª–∏—Å—å</div>
                </div>
            </div>


            <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="table-container">
                <h3 style="font-size: 14px; margin-bottom: 15px; color: rgba(255, 255, 255, 0.8); font-weight: 500; padding-left: 5px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                <div id="usersList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- –†–∞–∑–¥–µ–ª: –†–µ—Ñ–µ—Ä–∞–ª—ã -->
        <div id="referrals" class="section-content">
            <div id="referrals-header"></div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                <div class="stat-box">
                    <div class="stat-box-value" id="totalReferrals">0</div>
                    <div class="stat-box-label">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="todayReferrals">0</div>
                    <div class="stat-box-label">–ó–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="orphanUsers">0</div>
                    <div class="stat-box-label">–ë–µ–∑ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞</div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; max-width: 400px;">
                <button onclick="showChangeReferrer()" style="
                    padding: 12px 20px;
                    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    color: #FFD700;
                    border-radius: 10px;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.1);
                    white-space: nowrap;
                ">
                    –°–º–µ–Ω–∏—Ç—å
                </button>
                <button onclick="showTop100Modal()" style="
                    padding: 12px 20px;
                    background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
                    border: 1px solid rgba(52, 152, 219, 0.3);
                    color: #3498db;
                    border-radius: 10px;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
                    white-space: nowrap;
                ">
                    –¢–û–ü 100
                </button>
            </div>

            <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏ -->
            <div class="table-container">
                <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <div id="referralUsersTable">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ -->
        <div id="changeReferrerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>–°–º–µ–Ω–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞</h3>
                    <button class="modal-close" onclick="closeChangeReferrerModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Telegram ID):</label>
                        <input type="text" id="changeUserId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>
                    <div class="form-group">
                        <label>ID –Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (Telegram ID):</label>
                        <input type="text" id="changeNewReferrer" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞">
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="executeChangeReferrer()" style="background: rgba(255, 215, 0, 0.2);">–°–º–µ–Ω–∏—Ç—å</button>
                    <button class="danger" onclick="closeChangeReferrerModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="singleReferrerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞</h3>
                    <button class="modal-close" onclick="closeSingleReferrerModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <input type="text" id="singleUserId" readonly style="opacity: 0.7;">
                    </div>
                    <div class="form-group">
                        <label>–¢–µ–∫—É—â–∏–π —Ä–µ—Ñ–µ—Ä–µ—Ä:</label>
                        <input type="text" id="currentSingleReferrer" readonly style="opacity: 0.7;">
                    </div>
                    <div class="form-group">
                        <label>–ù–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–µ—Ä (Telegram ID):</label>
                        <input type="text" id="newSingleReferrer" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID">
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="clearSingleReferrer()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞</button>
                    <button onclick="updateSingleReferrer()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button class="danger" onclick="closeSingleReferrerModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¢–û–ü 100 -->
        <div id="top100Modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3>–¢–û–ü 100 —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤</h3>
                    <button class="modal-close" onclick="closeTop100Modal()">√ó</button>
                </div>
                <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="top100Content">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="shop" class="section-content">
            <div id="shop-header"></div>
            <p style="color: rgba(255, 255, 255, 0.6);">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>

        <div id="chests" class="section-content">
            <div id="chests-header"></div>
            <p style="color: rgba(255, 255, 255, 0.6);">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>

        <div id="giveaways" class="section-content">
            <div id="giveaways-header"></div>
            <p style="color: rgba(255, 255, 255, 0.6);">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>

        <div id="finance" class="section-content">
            <div id="finance-header"></div>
            <p style="color: rgba(255, 255, 255, 0.6);">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>

        <div id="settings" class="section-content">
            <div id="settings-header"></div>
            <p style="color: rgba(255, 255, 255, 0.6);">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>

        <div id="analytics" class="section-content">
            <div id="analytics-header"></div>
            <p style="color: rgba(255, 255, 255, 0.6);">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
        </div>

        <!-- –†–∞–∑–¥–µ–ª: –õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞ -->
        <div id="logs" class="section-content">
            <div id="logs-header"></div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∞–º–∏ -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <button id="clearLogsBtn" class="action-button" style="background: linear-gradient(135deg, #FF6B6B, #FF4757); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
                </button>
                <button id="exportLogsBtn" class="action-button" style="background: linear-gradient(135deg, #667EEA, #764BA2); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤
                </button>
                <button id="autoRefreshBtn" class="action-button" style="background: linear-gradient(135deg, #11998E, #38EF7D); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í–´–ö–õ
                </button>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã –ª–æ–≥–æ–≤ -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px; color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                    <input type="checkbox" id="filterAuth" checked style="accent-color: #FFD700;">
                    <span style="color: #FFD700;">AUTH</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                    <input type="checkbox" id="filterReferral" checked style="accent-color: #4CAF50;">
                    <span style="color: #4CAF50;">REFERRAL</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                    <input type="checkbox" id="filterError" checked style="accent-color: #FF5722;">
                    <span style="color: #FF5722;">ERROR</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                    <input type="checkbox" id="filterGeneral" checked style="accent-color: #2196F3;">
                    <span style="color: #2196F3;">GENERAL</span>
                </label>
                <input type="text" id="searchLogs" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º..." style="padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: white; font-size: 14px; width: 200px;">
            </div>

            <!-- –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ª–æ–≥–æ–≤ -->
            <div id="logsConsole" style="background: #1a1a1a; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 20px; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; height: 500px; overflow-y: auto; color: #e0e0e0; line-height: 1.4;">
                <div style="color: #888; text-align: center; margin-top: 200px;">
                    <span style="font-size: 16px;">üîç</span><br>
                    –û–∂–∏–¥–∞–Ω–∏–µ –ª–æ–≥–æ–≤... –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ—Ç–ª–∞–¥–∫–∏.
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–≥–æ–≤ -->
            <div style="margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 8px; padding: 15px; min-width: 120px;">
                    <div style="color: #FFD700; font-size: 18px; font-weight: bold;" id="authLogsCount">0</div>
                    <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">AUTH –ª–æ–≥–∏</div>
                </div>
                <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.2); border-radius: 8px; padding: 15px; min-width: 120px;">
                    <div style="color: #4CAF50; font-size: 18px; font-weight: bold;" id="referralLogsCount">0</div>
                    <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">REFERRAL –ª–æ–≥–∏</div>
                </div>
                <div style="background: rgba(255, 87, 34, 0.1); border: 1px solid rgba(255, 87, 34, 0.2); border-radius: 8px; padding: 15px; min-width: 120px;">
                    <div style="color: #FF5722; font-size: 18px; font-weight: bold;" id="errorLogsCount">0</div>
                    <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">ERROR –ª–æ–≥–∏</div>
                </div>
                <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.2); border-radius: 8px; padding: 15px; min-width: 120px;">
                    <div style="color: #2196F3; font-size: 18px; font-weight: bold;" id="totalLogsCount">0</div>
                    <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">–í—Å–µ–≥–æ –ª–æ–≥–æ–≤</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SUPABASE_URL = 'https://syxjkircmiwpnpagznay.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5eGpraXJjbWl3cG5wYWd6bmF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjQ0MTEsImV4cCI6MjA3MzM0MDQxMX0.XUJWPrPOtsG_cynjfH38mJR2lJYThGTgEVMMu3MIw8g';
        const ADMIN_IDS = [190202791];

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase
        console.log('Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', !!supabase);
        console.log('–ú–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ë–î:', typeof supabase.from === 'function');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª–µ–π —Ö–µ–¥–µ—Ä–∞ —Ä–∞–∑–¥–µ–ª–æ–≤
            if (typeof sectionHeaderStyles !== 'undefined') {
                document.getElementById('section-header-styles').textContent = sectionHeaderStyles;
            }

            // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            // if (await checkAdmin()) {
                window.Telegram?.WebApp?.ready();
                window.Telegram?.WebApp?.expand();
                await loadMainStats();
            // }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function checkAdmin() {
            const initData = window.Telegram?.WebApp?.initData;
            if (!initData) {
                showNotification('–û—à–∏–±–∫–∞: –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram', 'error');
                return false;
            }

            const urlParams = new URLSearchParams(initData);
            const userParam = urlParams.get('user');
            if (!userParam) {
                showNotification('–û—à–∏–±–∫–∞: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return false;
            }

            const user = JSON.parse(decodeURIComponent(userParam));
            // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–º–∏–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            // if (!ADMIN_IDS.includes(user.id)) {
            //     document.body.innerHTML = '<div style="color: white; text-align: center; padding: 50px; font-size: 20px;">‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</div>';
            //     return false;
            // }

            currentUser = user || { first_name: 'Admin', id: 'admin' };
            // –£–±—Ä–∞–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–¥–º–∏–Ω–µ
            return true;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
        async function loadMainStats() {
            try {
                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const { count: totalUsers } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                const usersStatEl = document.getElementById('usersStat');
                if (usersStatEl) usersStatEl.textContent = totalUsers || 0;

                // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const { count: activeToday } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('last_active', today.toISOString());
                const dashboardStatEl = document.getElementById('dashboardStat');
                if (dashboardStatEl) dashboardStatEl.textContent = activeToday || 0;

                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                const { count: referrals } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .not('referred_by', 'is', null);
                const referralsStatEl = document.getElementById('referralsStat');
                if (referralsStatEl) referralsStatEl.textContent = referrals || 0;

                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç
                const { data: coinsData } = await supabase
                    .from('users')
                    .select('balance_ar');
                const totalCoins = coinsData?.reduce((sum, user) => sum + (user.balance_ar || 0), 0) || 0;
                const financeStatEl = document.getElementById('financeStat');
                if (financeStatEl) financeStatEl.textContent = totalCoins.toLocaleString();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞
        // –¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è
        let currentPeriod = '3days';
        let chartInstance = null;

        async function loadDashboard() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const { data: allUsers } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // 1. –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const totalUsersEl = document.getElementById('totalUsers');
                if (totalUsersEl) totalUsersEl.textContent = allUsers?.length || 0;

                // 2. –û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç)
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const onlineNow = allUsers?.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    return lastActive && new Date(lastActive) >= fiveMinutesAgo;
                }).length || 0;
                const onlineNowEl = document.getElementById('onlineNow');
                if (onlineNowEl) onlineNowEl.textContent = onlineNow;

                // 3. –ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è
                const newToday = allUsers?.filter(u => new Date(u.created_at) >= today).length || 0;
                const newTodayEl = document.getElementById('newToday');
                if (newTodayEl) newTodayEl.textContent = newToday;

                // 4. –û—Ç–≤–∞–ª–∏–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è (—Å—Ç–∞–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ 3+ –¥–Ω—è)
                const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
                const churnedToday = allUsers?.filter(u => {
                    const lastActive = new Date(u.last_seen_at || u.last_active || u.created_at);
                    const churnDate = new Date(lastActive.getTime() + 3 * 24 * 60 * 60 * 1000);
                    return churnDate >= today && churnDate < new Date(today.getTime() + 24 * 60 * 60 * 1000);
                }).length || 0;
                const churnedTodayEl = document.getElementById('churnedToday');
                if (churnedTodayEl) churnedTodayEl.textContent = churnedToday;

                // 4. –ö–æ–Ω–≤–µ—Ä—Å–∏—è
                const usersWithTasks = allUsers?.filter(u => u.balance_ar > 50).length || 0;
                const conversionRate = allUsers?.length > 0 ?
                    Math.round((usersWithTasks / allUsers.length) * 100) : 0;
                const conversionRateEl = document.getElementById('conversionRate');
                if (conversionRateEl) conversionRateEl.textContent = conversionRate + '%';

                // 5. –û—Ç–≤–∞–ª–∏–ª–∏—Å—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3+ –¥–Ω—è)
                updateChurnedUsers(allUsers, currentPeriod);

                // 6. –ë–µ–∑ –∑–∞–¥–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è
                const noTasksToday = allUsers?.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    return lastActive && new Date(lastActive) >= today && u.balance_ar <= 50;
                }).length || 0;
                const noTasksTodayEl = document.getElementById('noTasksToday');
                if (noTasksTodayEl) noTasksTodayEl.textContent = noTasksToday;

                // 7. –í—á–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω—ã
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayEnd = new Date(today);
                const yesterdayActive = allUsers?.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    if (!lastActive) return false;
                    const activeDate = new Date(lastActive);
                    return activeDate >= yesterday && activeDate < yesterdayEnd;
                }).length || 0;
                const yesterdayEl = document.getElementById('yesterdayActive');
                if (yesterdayEl) yesterdayEl.textContent = yesterdayActive;

                // 8. –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å
                const avgBalance = allUsers?.length > 0 ?
                    Math.round(allUsers.reduce((sum, u) => sum + (u.balance_ar || 0), 0) / allUsers.length) : 0;
                const avgBalanceEl = document.getElementById('avgBalance');
                if (avgBalanceEl) avgBalanceEl.textContent = avgBalance;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤
                window.dashboardUsers = allUsers;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —á—Ç–æ DOM –≥–æ—Ç–æ–≤
                setTimeout(async () => {
                    await loadUsers();
                }, 100);

                // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                const { data: recentUsers } = await supabase
                    .from('users')
                    .select('telegram_id, username, first_name, created_at, referred_by')
                    .order('created_at', { ascending: false })
                    .limit(10);

                const recentHtml = recentUsers?.length ?
                    `<table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–†–µ—Ñ–µ—Ä–µ—Ä</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentUsers.map(user => `
                                <tr>
                                    <td>${user.telegram_id}</td>
                                    <td>${user.first_name || user.username || '–ù–µ—Ç –∏–º–µ–Ω–∏'}</td>
                                    <td>${new Date(user.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</td>
                                    <td>${user.referred_by || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` :
                    '<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px;">–ù–µ—Ç –Ω–æ–≤—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π</p>';

                document.getElementById('recentRegistrations').innerHTML = recentHtml;

                // –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                const { data: problemUsers } = await supabase
                    .from('users')
                    .select('telegram_id, username, first_name, last_login, tasks_completed')
                    .or(`last_login.lt.${threeDaysAgo.toISOString()},tasks_completed.eq.0`)
                    .limit(10);

                const problemHtml = problemUsers?.length ?
                    `<table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                                <th>–ó–∞–¥–∞–Ω–∏–π</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${problemUsers.map(user => `
                                <tr>
                                    <td>${user.telegram_id}</td>
                                    <td>${user.first_name || user.username || '–ù–µ—Ç –∏–º–µ–Ω–∏'}</td>
                                    <td>${user.last_login ? new Date(user.last_login).toLocaleDateString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞'}</td>
                                    <td>${user.tasks_completed || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` :
                    '<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px;">–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';

                document.getElementById('problemUsers').innerHTML = problemHtml;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–≤–µ—Ç–∞ –∞–≤–∞—Ç–∞—Ä–∞ (–∫–∞–∫ –≤ index.html)
        function getAvatarColor(id) {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57',
                '#DDA0DD', '#98D8C8', '#FFD700', '#FF69B4', '#00CED1',
                '#FF7F50', '#6A5ACD', '#20B2AA', '#F4A460', '#FF6347'
            ];
            const numId = parseInt(id) || 0;
            return colors[numId % colors.length];
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –∞–≤–∞—Ç–∞—Ä–∞
        function createAvatar(user, size = 'normal') {
            const sizeClass = size === 'mini' ? 'avatar-placeholder-mini' : 'avatar-placeholder-small';
            const avatarClass = size === 'mini' ? 'referrer-avatar' : 'user-avatar';

            // –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω–∞) –±–µ—Ä–µ–º —Ñ–æ—Ç–æ –∏–∑ Telegram –Ω–∞–ø—Ä—è–º—É—é
            const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
            if (tgUser && tgUser.id == user.telegram_id && tgUser.photo_url) {
                return `<img src="${tgUser.photo_url}" class="${avatarClass}" alt="">`;
            }

            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º photo_url –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            if (user.photo_url) {
                return `<img src="${user.photo_url}" class="${avatarClass}" alt="">`;
            } else {
                // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–≤–µ—Ç–Ω–æ–π –∫—Ä—É–≥ —Å –±—É–∫–≤–æ–π
                const initial = (user.first_name || user.username || 'U').charAt(0).toUpperCase();
                const color = getAvatarColor(user.telegram_id);
                return `<div class="${sizeClass}" style="background: ${color}">${initial}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ –∫–∞–∫ –≤ loadReferrals
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', users?.length || 0);

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –±–∞–ª–∞–Ω—Å–æ–º
                const html = users?.length ?
                    `<table style="font-size: 11px; width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th style="text-align: center; padding: 10px;">ID</th>
                                <th style="text-align: center; padding: 10px;">–ë–∞–ª–∞–Ω—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 8px 10px;">
                                        <div class="user-avatar-wrapper" style="display: flex; align-items: center; gap: 10px;">
                                            ${createAvatar(user)}
                                            <div>
                                                <div style="color: rgba(255, 255, 255, 0.9);">${user.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                                ${user.username ? `<div style="font-size: 9px; color: rgba(255,255,255,0.5);">@${user.username}</div>` : ''}
                                            </div>
                                        </div>
                                    </td>
                                    <td style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 10px;">${user.telegram_id}</td>
                                    <td style="text-align: center;">
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            <button onclick="changeBalance('${user.telegram_id}', -10)" style="background: rgba(255,69,58,0.2); border: 1px solid rgba(255,69,58,0.3); color: #FF453A; padding: 3px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: bold;" title="–£–±—Ä–∞—Ç—å 10 AR">-10</button>
                                            <span style="font-weight: bold; color: #FFD700; min-width: 50px;">${user.balance_ar || 0} AR</span>
                                            <button onclick="changeBalance('${user.telegram_id}', 10)" style="background: rgba(52,199,89,0.2); border: 1px solid rgba(52,199,89,0.3); color: #34C759; padding: 3px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: bold;" title="–î–æ–±–∞–≤–∏—Ç—å 10 AR">+10</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` :
                    '<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px; padding: 20px;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';

                // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                const usersListEl = document.getElementById('usersList');
                if (usersListEl) {
                    usersListEl.innerHTML = html;
                    console.log('–¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                } else {
                    console.error('–≠–ª–µ–º–µ–Ω—Ç usersList –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                const usersListEl = document.getElementById('usersList');
                if (usersListEl) {
                    usersListEl.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        window.changeBalance = async function(userId, amount) {
            try {
                const { data: user } = await supabase
                    .from('users')
                    .select('balance_ar')
                    .eq('telegram_id', userId)
                    .single();

                const newBalance = (user.balance_ar || 0) + amount;

                if (newBalance < 0) {
                    showNotification('–ë–∞–ª–∞–Ω—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º', 'error');
                    return;
                }

                await supabase
                    .from('users')
                    .update({ balance_ar: newBalance })
                    .eq('telegram_id', userId);

                loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                showNotification(`–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ${amount > 0 ? '+' : ''}${amount} AR`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
        // changeBalance —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤—ã—à–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ +50/-50

        // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–∞–∑–¥–µ–ª–∞
        window.openSection = async function(section) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª
            document.getElementById(section).classList.add('active');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
            if (section === 'dashboard') {
                await loadDashboard();
            } else if (section === 'tasks') {
                await loadQuizzes();
            }
        };

        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        window.goHome = function() {
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('mainPage').classList.add('active');
            loadMainStats();
        };

        // –í—ã—Ö–æ–¥
        window.logout = function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                window.Telegram?.WebApp?.close();
            }
        };

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateChurnedUsers(users, period = '3days') {
            let daysAgo;
            let label;

            switch(period) {
                case '3days':
                    daysAgo = 3;
                    label = '–û—Ç–≤–∞–ª–∏–ª–∏—Å—å 3+ –¥–Ω–µ–π';
                    break;
                case '7days':
                    daysAgo = 7;
                    label = '–û—Ç–≤–∞–ª–∏–ª–∏—Å—å 7+ –¥–Ω–µ–π';
                    break;
                case '30days':
                    daysAgo = 30;
                    label = '–û—Ç–≤–∞–ª–∏–ª–∏—Å—å 30+ –¥–Ω–µ–π';
                    break;
                default:
                    daysAgo = 3;
                    label = '–û—Ç–≤–∞–ª–∏–ª–∏—Å—å 3+ –¥–Ω–µ–π';
            }

            const cutoffDate = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
            const churnedCount = users?.filter(u => {
                const lastActive = u.last_seen_at || u.last_active || u.last_login || u.created_at;
                return new Date(lastActive) < cutoffDate;
            }).length || 0;

            const displayEl = document.getElementById('churnedUsersDisplay');
            const labelEl = document.getElementById('churnedLabel');

            if (displayEl) displayEl.textContent = churnedCount;
            if (labelEl) labelEl.textContent = label;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
        window.changePeriod = function(period) {
            currentPeriod = period;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.style.background = 'rgba(255, 255, 255, 0.03)';
                btn.style.border = '1px solid rgba(255, 255, 255, 0.08)';
                btn.style.color = 'rgba(255, 255, 255, 0.7)';
            });

            const activeBtn = document.getElementById('period-' + period);
            if (activeBtn) {
                activeBtn.style.background = 'rgba(255, 215, 0, 0.15)';
                activeBtn.style.border = '1px solid rgba(255, 215, 0, 0.3)';
                activeBtn.style.color = '#FFD700';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            if (window.dashboardUsers) {
                updateChurnedUsers(window.dashboardUsers, period);
            }
        };

        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function createActivityCalendar(users) {
            const today = new Date();
            const calendarPreview = document.querySelector('#calendarPreview > div');
            const calendarView = document.getElementById('activityCalendar');

            if (!calendarPreview || !calendarView) return;

            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 30 –¥–Ω–µ–π
            const calendarData = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                const nextDay = new Date(date);
                nextDay.setDate(nextDay.getDate() + 1);

                const count = users?.filter(u => {
                    const created = new Date(u.created_at);
                    return created >= date && created < nextDay;
                }).length || 0;

                calendarData.push({
                    date: new Date(date),
                    count: count,
                    day: date.getDate(),
                    month: date.toLocaleDateString('ru-RU', { month: 'short' }),
                    weekday: date.toLocaleDateString('ru-RU', { weekday: 'short' })
                });
            }

            // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏-–ø—Ä–µ–≤—å—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π)
            calendarPreview.innerHTML = calendarData.slice(-14).map(d => {
                const intensity = d.count === 0 ? 0 : Math.min(1, d.count / 5);
                const color = d.count === 0
                    ? 'rgba(255, 255, 255, 0.03)'
                    : `rgba(255, 215, 0, ${0.2 + intensity * 0.8})`;

                return `
                    <div style="
                        width: 20px;
                        height: 20px;
                        background: ${color};
                        border: 1px solid rgba(255, 255, 255, 0.08);
                        border-radius: 4px;
                        cursor: pointer;
                        position: relative;
                    " title="${d.day} ${d.month}: ${d.count} –Ω–æ–≤—ã—Ö">
                    </div>
                `;
            }).join('');

            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            const weeks = [];
            let currentWeek = [];

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
            const firstDay = calendarData[0].date.getDay();
            const startPadding = firstDay === 0 ? 6 : firstDay - 1;
            for (let i = 0; i < startPadding; i++) {
                currentWeek.push(null);
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            calendarData.forEach(d => {
                if (currentWeek.length === 7) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentWeek.push(d);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
            if (currentWeek.length > 0) {
                while (currentWeek.length < 7) {
                    currentWeek.push(null);
                }
                weeks.push(currentWeek);
            }

            calendarView.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                        ${['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => `
                            <div style="
                                text-align: center;
                                font-size: 10px;
                                color: rgba(255, 255, 255, 0.4);
                                padding: 4px;
                            ">${day}</div>
                        `).join('')}
                    </div>
                    ${weeks.map(week => `
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px;">
                            ${week.map(day => {
                                if (!day) return '<div></div>';

                                const intensity = day.count === 0 ? 0 : Math.min(1, day.count / 5);
                                const color = day.count === 0
                                    ? 'rgba(255, 255, 255, 0.03)'
                                    : `rgba(255, 215, 0, ${0.2 + intensity * 0.8})`;

                                const isToday = day.date.toDateString() === today.toDateString();

                                return `
                                    <div style="
                                        aspect-ratio: 1;
                                        background: ${color};
                                        border: 1px solid ${isToday ? '#FFD700' : 'rgba(255, 255, 255, 0.08)'};
                                        border-radius: 6px;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        justify-content: center;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        position: relative;
                                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="font-size: 11px; color: ${day.count > 0 ? '#000' : 'rgba(255, 255, 255, 0.6)'}; font-weight: 600;">
                                            ${day.day}
                                        </div>
                                        ${day.count > 0 ? `
                                            <div style="font-size: 9px; color: ${intensity > 0.5 ? '#000' : '#FFD700'}; margin-top: 2px;">
                                                +${day.count}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                    <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">–ú–µ–Ω—å—à–µ</span>
                    <div style="display: flex; gap: 4px;">
                        ${[0, 0.2, 0.4, 0.6, 0.8, 1].map(intensity => `
                            <div style="
                                width: 14px;
                                height: 14px;
                                background: ${intensity === 0 ? 'rgba(255, 255, 255, 0.03)' : `rgba(255, 215, 0, ${0.2 + intensity * 0.8})`};
                                border: 1px solid rgba(255, 255, 255, 0.08);
                                border-radius: 3px;
                            "></div>
                        `).join('')}
                    </div>
                    <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">–ë–æ–ª—å—à–µ</span>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        window.toggleCalendar = function() {
            const calendarView = document.getElementById('calendarView');
            const calendarPreview = document.getElementById('calendarPreview');
            const toggleBtn = document.getElementById('calendarToggle');

            if (calendarView.style.display === 'none') {
                calendarView.style.display = 'block';
                calendarPreview.style.display = 'none';
                toggleBtn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤';
            } else {
                calendarView.style.display = 'none';
                calendarPreview.style.display = 'block';
                toggleBtn.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº';
            }
        };

        // –ü—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ Canvas –±–µ–∑ Chart.js
        function drawSimpleChart(canvas, data) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // –û—á–∏—â–∞–µ–º canvas
            ctx.clearRect(0, 0, width, height);

            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const maxValue = Math.max(...data.map(d => d.count), 1);

            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (height - 20) * (1 - i / 4) + 10;
                ctx.beginPath();
                ctx.moveTo(30, y);
                ctx.lineTo(width - 10, y);
                ctx.stroke();
            }

            // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
            if (data.length > 0) {
                const stepX = (width - 40) / (data.length - 1);

                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.beginPath();

                data.forEach((point, index) => {
                    const x = 30 + index * stepX;
                    const y = (height - 20) * (1 - point.count / maxValue) + 10;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();

                // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
                data.forEach((point, index) => {
                    const x = 30 + index * stepX;
                    const y = (height - 20) * (1 - point.count / maxValue) + 10;

                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();

                    // –ü–æ–¥–ø–∏—Å–∏
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(point.date, x, height - 2);
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –†–µ—Ñ–µ—Ä–∞–ª—ã
        async function loadReferrals() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                // –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ id -> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                const userById = {};
                users.forEach(u => userById[u.id] = u);

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - referred_by —ç—Ç–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –Ω–µ telegram_id
                const totalReferrals = users.filter(u => u.referred_by || u.referrer_id).length;
                const activeReferrals = users.filter(u => (u.referred_by || u.referrer_id) &&
                    (u.last_seen_at || u.last_active) &&
                    new Date(u.last_seen_at || u.last_active) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;
                const orphans = users.filter(u => !u.referred_by && !u.referrer_id).length;

                // –ü–æ–¥—Å—á–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const referralCounts = {};
                users.forEach(user => {
                    const referrerId = user.referred_by || user.referrer_id;
                    if (referrerId) {
                        // –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –ø–æ ID –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ telegram_id –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
                        const referrer = userById[referrerId];
                        if (referrer) {
                            referralCounts[referrer.telegram_id] = (referralCounts[referrer.telegram_id] || 0) + 1;
                        }
                    }
                });

                // –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä
                let topReferrer = { id: '-', count: 0 };
                for (const [id, count] of Object.entries(referralCounts)) {
                    if (count > topReferrer.count) {
                        topReferrer = { id, count };
                    }
                }

                // –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                const referrers = Object.keys(referralCounts).length;
                const avgReferrals = referrers > 0 ? Math.round(totalReferrals / referrers) : 0;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const totalReferralsEl = document.getElementById('totalReferrals');
                if (totalReferralsEl) totalReferralsEl.textContent = totalReferrals;

                const todayReferralsEl = document.getElementById('todayReferrals');
                if (todayReferralsEl) {
                    // –°—á–∏—Ç–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayRefs = users.filter(u => {
                        const hasRef = u.referred_by || u.referrer_id;
                        const createdAt = new Date(u.created_at);
                        return hasRef && createdAt >= today;
                    }).length;
                    todayReferralsEl.textContent = todayRefs;
                }

                const orphanUsersEl = document.getElementById('orphanUsers');
                if (orphanUsersEl) orphanUsersEl.textContent = orphans;

                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏
                let usersTableHtml = `
                    <table style="font-size: 11px;">
                        <thead>
                            <tr>
                                <th style="width: 200px; text-align: left; padding-left: 10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th style="width: 80px; text-align: center;">ID</th>
                                <th style="width: 120px; text-align: center;">–ü—Ä–∏–≥–ª–∞—Å–∏–ª</th>
                                <th style="width: 100px; text-align: center;">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</th>
                                <th style="width: 100px; text-align: center;">–ë–∞–ª–∞–Ω—Å</th>
                                <th style="width: 100px; text-align: center;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                                <th style="width: 100px; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>`;

                for (const user of users) {
                    // –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –ø–æ ID
                    const referrerId = user.referred_by || user.referrer_id;
                    const referrer = referrerId ? userById[referrerId] : null;
                    // –°—á–∏—Ç–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                    const refCount = users.filter(u => {
                        const refId = u.referred_by || u.referrer_id;
                        return refId && userById[refId] && userById[refId].telegram_id === user.telegram_id;
                    }).length;

                    usersTableHtml += `
                        <tr>
                            <td style="padding: 8px 10px;">
                                <div class="user-avatar-wrapper" style="display: flex; align-items: center; gap: 10px;">
                                    ${createAvatar(user)}
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.9);">${user.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                        ${user.username ? `<div style="font-size: 9px; color: rgba(255,255,255,0.5);">@${user.username}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 10px;">${user.telegram_id}</td>
                            <td style="text-align: center; color: rgba(255, 255, 255, 0.8);">
                                ${referrer ? referrer.first_name || referrer.telegram_id : '–ë–µ–∑ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞'}
                            </td>
                            <td style="text-align: center; font-weight: bold; color: #FFD700;">${refCount}</td>
                            <td style="text-align: center;">${user.balance_ar || 0} AR</td>
                            <td style="text-align: center; font-size: 10px;">${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
                            <td style="text-align: center;">
                                <button class="action-btn" onclick="showReferralTree('${user.telegram_id}')"
                                        style="background: none; border: none; padding: 5px; cursor: pointer; margin-right: 5px;"
                                        title="–î–µ—Ä–µ–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
                                        <path d="M12 2v6m0 0a3 3 0 1 0 0 6m0-6a3 3 0 1 1 0 6m0 0v2m0 0a3 3 0 1 0 0 6m0-6a3 3 0 1 1 0 6"></path>
                                        <path d="M9 8H3m6 8H3m18-8h-6m6 8h-6"></path>
                                    </svg>
                                </button>
                                <button class="action-btn" onclick="openSingleReferrerModal('${user.telegram_id}', '${user.referred_by || ''}')"
                                        style="background: none; border: none; padding: 5px; cursor: pointer;"
                                        title="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>`;
                }

                usersTableHtml += `
                        </tbody>
                    </table>`;

                document.getElementById('referralUsersTable').innerHTML = usersTableHtml;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤', 'error');
            }
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≥–ª—É–±–∏–Ω—ã —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏
        function calculateMaxReferralDepth(users) {
            let maxDepth = 0;
            const userMap = {};
            users.forEach(u => userMap[u.telegram_id] = u);

            function getDepth(userId, visited = new Set()) {
                if (visited.has(userId)) return 0;
                visited.add(userId);

                const referrals = users.filter(u => u.referred_by === userId);
                if (referrals.length === 0) return 0;

                let max = 0;
                for (const ref of referrals) {
                    const depth = 1 + getDepth(ref.telegram_id, visited);
                    if (depth > max) max = depth;
                }
                return max;
            }

            users.forEach(user => {
                if (!user.referred_by) {
                    const depth = getDepth(user.telegram_id);
                    if (depth > maxDepth) maxDepth = depth;
                }
            });

            return maxDepth;
        }

        // –ú–∞—Å—Å–æ–≤–∞—è —Å–º–µ–Ω–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
        window.showMassReferrerChange = function() {
            document.getElementById('massReferrerModal').classList.add('active');
        };

        window.closeMassReferrerModal = function() {
            document.getElementById('massReferrerModal').classList.remove('active');
        };

        window.checkMassReferrals = async function() {
            const fromId = document.getElementById('massFromReferrer').value.trim();
            if (!fromId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞', 'error');
                return;
            }

            try {
                const { count } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('referred_by', fromId);

                document.getElementById('massReferralCount').textContent = count || 0;

                if (count === 0) {
                    showNotification('–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤', 'error');
                } else {
                    showNotification(`–ù–∞–π–¥–µ–Ω–æ ${count} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤', 'error');
            }
        };

        window.executeMassReferrerChange = async function() {
            const fromId = document.getElementById('massFromReferrer').value.trim();
            const toId = document.getElementById('massToReferrer').value.trim();

            if (!fromId || !toId) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è', 'error');
                return;
            }

            if (fromId === toId) {
                showNotification('ID –¥–æ–ª–∂–Ω—ã –æ—Ç–ª–∏—á–∞—Ç—å—Å—è', 'error');
                return;
            }

            if (!confirm(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –æ—Ç ${fromId} –∫ ${toId}?`)) {
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                const { data: newReferrer } = await supabase
                    .from('users')
                    .select('telegram_id')
                    .eq('telegram_id', toId)
                    .single();

                if (!newReferrer) {
                    showNotification('–ù–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                // –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                const { error } = await supabase
                    .from('users')
                    .update({ referrer_id: toId })
                    .eq('referrer_id', fromId);

                if (error) throw error;

                showNotification('–†–µ—Ñ–µ—Ä–∞–ª—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã');
                closeMassReferrerModal();
                loadReferrals();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤', 'error');
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¢–û–ü 100
        window.showTop100Modal = async function() {
            document.getElementById('top100Modal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                // –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                const userById = {};
                users.forEach(u => userById[u.id] = u);

                // –ü–æ–¥—Å—á–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userStats = {};

                users.forEach(user => {
                    userStats[user.telegram_id] = {
                        user: user,
                        level1: 0,
                        level2: 0,
                        totalReferrals: 0
                    };
                });

                // –°—á–∏—Ç–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è
                users.forEach(user => {
                    const referrerId = user.referred_by || user.referrer_id;
                    if (referrerId) {
                        const referrer = userById[referrerId];
                        if (referrer && userStats[referrer.telegram_id]) {
                            userStats[referrer.telegram_id].level1++;
                            userStats[referrer.telegram_id].totalReferrals++;
                        }
                    }
                });

                // –°—á–∏—Ç–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è
                users.forEach(user => {
                    const referrerId = user.referred_by || user.referrer_id;
                    if (referrerId) {
                        const referrer = userById[referrerId];
                        if (referrer) {
                            // –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            const userReferrals = users.filter(u => {
                                const refId = u.referred_by || u.referrer_id;
                                return refId === user.id;
                            });

                            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ –≤—Ç–æ—Ä–æ–º—É —É—Ä–æ–≤–Ω—é —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                            userReferrals.forEach(() => {
                                const grandReferrerId = referrer.telegram_id;
                                if (userStats[grandReferrerId]) {
                                    userStats[grandReferrerId].level2++;
                                    userStats[grandReferrerId].totalReferrals++;
                                }
                            });
                        }
                    }
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: 1 —É—Ä–æ–≤–µ–Ω—å, –ø–æ—Ç–æ–º 2 —É—Ä–æ–≤–µ–Ω—å, –ø–æ—Ç–æ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
                const sortedUsers = Object.values(userStats)
                    .filter(stat => stat.totalReferrals > 0)
                    .sort((a, b) => {
                        if (a.level1 !== b.level1) {
                            return b.level1 - a.level1;
                        }
                        if (a.level2 !== b.level2) {
                            return b.level2 - a.level2;
                        }
                        // –ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
                        const nameA = a.user.first_name || a.user.telegram_id;
                        const nameB = b.user.first_name || b.user.telegram_id;
                        return nameA.localeCompare(nameB);
                    })
                    .slice(0, 100);

                // –°–æ–∑–¥–∞–µ–º HTML —Ç–∞–±–ª–∏—Ü—É
                let tableHtml = `
                    <table style="width: 100%; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="width: 50px; text-align: center;">–ú–µ—Å—Ç–æ</th>
                                <th style="width: 250px; text-align: left; padding-left: 10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th style="width: 100px; text-align: center;">ID</th>
                                <th style="width: 120px; text-align: center;">–†–µ—Ñ–µ—Ä–∞–ª—ã 1 —É—Ä.</th>
                                <th style="width: 120px; text-align: center;">–†–µ—Ñ–µ—Ä–∞–ª—ã 2 —É—Ä.</th>
                                <th style="width: 100px; text-align: center;">–í—Å–µ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody>`;

                sortedUsers.forEach((stat, index) => {
                    const placeStyle = index < 3 ? 'color: #FFD700; font-weight: bold; font-size: 16px;' : '';
                    const placeIcon = index === 0 ? '1' : index === 1 ? '2' : index === 2 ? '3' : `${index + 1}`;

                    tableHtml += `
                        <tr>
                            <td style="text-align: center; ${placeStyle}">${placeIcon}</td>
                            <td style="padding: 8px 10px;">
                                <div class="user-avatar-wrapper" style="display: flex; align-items: center; gap: 10px;">
                                    ${createAvatar(stat.user)}
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.9);">${stat.user.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                        ${stat.user.username ? `<div style="font-size: 9px; color: rgba(255,255,255,0.5);">@${stat.user.username}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 10px;">${stat.user.telegram_id}</td>
                            <td style="text-align: center; font-weight: bold; color: #2ecc71;">${stat.level1}</td>
                            <td style="text-align: center; font-weight: bold; color: #3498db;">${stat.level2}</td>
                            <td style="text-align: center; font-weight: bold; color: #FFD700;">${stat.totalReferrals}</td>
                        </tr>`;
                });

                tableHtml += `
                        </tbody>
                    </table>`;

                document.getElementById('top100Content').innerHTML = tableHtml;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–û–ü 100:', error);
                document.getElementById('top100Content').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        };

        window.closeTop100Modal = function() {
            document.getElementById('top100Modal').classList.remove('active');
        };

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–º–µ–Ω—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
        window.showChangeReferrer = function() {
            document.getElementById('changeReferrerModal').classList.add('active');
        };

        window.closeChangeReferrerModal = function() {
            document.getElementById('changeReferrerModal').classList.remove('active');
            document.getElementById('changeUserId').value = '';
            document.getElementById('changeNewReferrer').value = '';
        };

        // –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–º–µ–Ω—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
        window.executeChangeReferrer = async function() {
            const userId = document.getElementById('changeUserId').value.trim();
            const newReferrerId = document.getElementById('changeNewReferrer').value.trim();

            if (!userId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            try {
                // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
                const { data: user } = await supabase
                    .from('users')
                    .select('*')
                    .eq('telegram_id', userId)
                    .single();

                if (!user) {
                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–µ—Ä, –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ
                let newReferrerDbId = null;
                if (newReferrerId) {
                    const { data: referrer } = await supabase
                        .from('users')
                        .select('*')
                        .eq('telegram_id', newReferrerId)
                        .single();

                    if (!referrer) {
                        showNotification('–†–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                        return;
                    }
                    newReferrerDbId = referrer.id;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                const { error } = await supabase
                    .from('users')
                    .update({ referrer_id: newReferrerDbId })
                    .eq('telegram_id', userId);

                if (error) throw error;

                showNotification('–†–µ—Ñ–µ—Ä–µ—Ä —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω', 'success');
                closeChangeReferrerModal();
                await loadReferrals(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞', 'error');
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ä–µ–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–æ–±—â–∞—è, –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        window.showReferralTree = async function(referrerId) {
            // –ï—Å–ª–∏ referrerId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ ID
            if (!referrerId) {
                const userId = prompt('–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ä–µ–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:');
                if (!userId) return;
                referrerId = userId.trim();
            }
            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                const userById = {};
                users.forEach(u => userById[u.id] = u);

                // –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const mainUser = users.find(u => u.telegram_id === referrerId);
                if (!mainUser) {
                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                // –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                const referrals = users.filter(u => {
                    const refId = u.referred_by || u.referrer_id;
                    return refId && userById[refId] && userById[refId].telegram_id === referrerId;
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ä–µ–≤–æ–º
                let treeHtml = `
                    <div style="padding: 20px;">
                        <h4 style="color: #FFD700; margin-bottom: 20px;">–î–µ—Ä–µ–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: ${mainUser.first_name || mainUser.telegram_id}</h4>
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 10px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                ${createAvatar(mainUser)}
                                <div>
                                    <div style="font-weight: 600; color: #FFD700;">${mainUser.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.5);">ID: ${mainUser.telegram_id}</div>
                                </div>
                            </div>`;

                if (referrals.length > 0) {
                    treeHtml += '<div style="border-left: 2px solid rgba(255, 215, 0, 0.2); margin-left: 20px; padding-left: 20px;">';
                    referrals.forEach((ref, index) => {
                        const isLast = index === referrals.length - 1;
                        treeHtml += `
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                <div style="width: 20px; height: 2px; background: rgba(255, 215, 0, 0.2);"></div>
                                ${createAvatar(ref, 'mini')}
                                <div>
                                    <div style="font-size: 13px; font-weight: 500;">${ref.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                    <div style="font-size: 10px; color: rgba(255,255,255,0.5);">ID: ${ref.telegram_id} | ${ref.balance_ar || 0} AR</div>
                                </div>
                            </div>`;
                    });
                    treeHtml += '</div>';
                } else {
                    treeHtml += '<div style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 10px;">–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>';
                }

                treeHtml += `
                        </div>
                    </div>`;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const modal = document.getElementById('treeModal');
                if (!modal) {
                    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ä–µ–≤–∞
                    const modalDiv = document.createElement('div');
                    modalDiv.id = 'treeModal';
                    modalDiv.className = 'modal active';
                    modalDiv.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>–î–µ—Ä–µ–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</h3>
                                <button class="modal-close" onclick="document.getElementById('treeModal').classList.remove('active')">√ó</button>
                            </div>
                            <div class="modal-body" id="treeContent">
                                ${treeHtml}
                            </div>
                        </div>`;
                    document.body.appendChild(modalDiv);
                } else {
                    modal.classList.add('active');
                    document.getElementById('treeContent').innerHTML = treeHtml;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ä–µ–≤–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ä–µ–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤', 'error');
            }
        };

        window.transferAllReferrals = function(fromId) {
            document.getElementById('massFromReferrer').value = fromId;
            showMassReferrerChange();
        };

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.openSingleReferrerModal = async function(userId, currentReferrerDbId) {
            console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', { userId, currentReferrerDbId });

            const modalElement = document.getElementById('singleReferrerModal');
            if (!modalElement) {
                console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
                showNotification('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }

            const userIdInput = document.getElementById('singleUserId');
            if (!userIdInput) {
                console.error('–ü–æ–ª–µ singleUserId –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
                showNotification('–û—à–∏–±–∫–∞: –ø–æ–ª–µ ID –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }

            userIdInput.value = userId;

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ—Ñ–µ—Ä–µ—Ä, –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ telegram_id –ø–æ id –≤ –ë–î
            if (currentReferrerDbId && currentReferrerDbId !== 'null' && currentReferrerDbId !== '') {
                try {
                    const { data: referrer, error } = await supabase
                        .from('users')
                        .select('telegram_id, first_name')
                        .eq('id', currentReferrerDbId)
                        .single();

                    console.log('–¢–µ–∫—É—â–∏–π —Ä–µ—Ñ–µ—Ä–µ—Ä:', referrer, '–û—à–∏–±–∫–∞:', error);

                    if (referrer && !error) {
                        document.getElementById('currentSingleReferrer').value =
                            `${referrer.first_name || 'ID'}: ${referrer.telegram_id}`;
                    } else {
                        document.getElementById('currentSingleReferrer').value = '–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞:', error);
                    document.getElementById('currentSingleReferrer').value = '–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞';
                }
            } else {
                document.getElementById('currentSingleReferrer').value = '–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä–∞';
            }

            document.getElementById('newSingleReferrer').value = '';
            modalElement.classList.add('active');
        };

        window.closeSingleReferrerModal = function() {
            document.getElementById('singleReferrerModal').classList.remove('active');
        };

        window.updateSingleReferrer = async function() {
            const userIdEl = document.getElementById('singleUserId');
            const newReferrerIdEl = document.getElementById('newSingleReferrer');

            if (!userIdEl || !newReferrerIdEl) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è –≤–≤–æ–¥–∞!', { userIdEl, newReferrerIdEl });
                showNotification('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è –≤–≤–æ–¥–∞', 'error');
                return;
            }

            const userId = userIdEl.value;
            const newReferrerId = newReferrerIdEl.value.trim();

            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞:', { userId, newReferrerId });

            if (!userId) {
                showNotification('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            if (!newReferrerId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞', 'error');
                return;
            }

            if (userId === newReferrerId) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º —Å–∞–º —Å–µ–±–µ', 'error');
                return;
            }

            try {
                // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –∏ –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ id (–Ω–µ telegram_id!)
                const { data: referrer, error: refError } = await supabase
                    .from('users')
                    .select('id, telegram_id, first_name')
                    .eq('telegram_id', newReferrerId)
                    .single();

                console.log('–ù–∞–π–¥–µ–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä:', referrer, '–û—à–∏–±–∫–∞:', refError);

                if (refError || !referrer) {
                    showNotification(`–†–µ—Ñ–µ—Ä–µ—Ä —Å ID ${newReferrerId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ`, 'error');
                    return;
                }

                // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –º–µ–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                const { data: userToUpdate, error: userError } = await supabase
                    .from('users')
                    .select('id, telegram_id')
                    .eq('telegram_id', userId)
                    .single();

                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', userToUpdate, '–û—à–∏–±–∫–∞:', userError);

                if (userError || !userToUpdate) {
                    showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${userId} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                    return;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º referrer.id, –∞ –Ω–µ telegram_id!
                const { data: updateData, error } = await supabase
                    .from('users')
                    .update({ referrer_id: referrer.id })
                    .eq('id', userToUpdate.id)
                    .select();

                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', updateData, '–û—à–∏–±–∫–∞:', error);

                if (error) throw error;

                showNotification(`‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${referrer.first_name || newReferrerId}`, 'success');
                closeSingleReferrerModal();

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                if (document.getElementById('referrals').classList.contains('active')) {
                    await loadReferrals();
                }
            } catch (error) {
                console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
                showNotification(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            }
        };

        window.clearSingleReferrer = async function() {
            const userId = document.getElementById('singleUserId').value;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ referrer_id: null })
                    .eq('telegram_id', userId);

                if (error) throw error;

                showNotification('–†–µ—Ñ–µ—Ä–µ—Ä –æ—á–∏—â–µ–Ω');
                closeSingleReferrerModal();

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                if (document.getElementById('referrals').classList.contains('active')) {
                    loadReferrals();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞', 'error');
            }
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é openSection
        const originalOpenSection = window.openSection;
        window.openSection = async function(section) {
            await originalOpenSection(section);

            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ö–µ–¥–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
            const sectionTitles = {
                'dashboard': '–î–∞—à–±–æ—Ä–¥',
                'referrals': '–†–µ—Ñ–µ—Ä–∞–ª—ã',
                'shop': '–ú–∞–≥–∞–∑–∏–Ω',
                'chests': '–°—É–Ω–¥—É–∫–∏',
                'giveaways': '–†–æ–∑—ã–≥—Ä—ã—à–∏',
                'finance': '–§–∏–Ω–∞–Ω—Å—ã',
                'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                'logs': '–õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞'
            };

            const headerContainer = document.getElementById(`${section}-header`);
            if (headerContainer && typeof createSectionHeader !== 'undefined') {
                headerContainer.innerHTML = createSectionHeader(sectionTitles[section] || section);
            }

            if (section === 'referrals') {
                await loadReferrals();
            } else if (section === 'dashboard') {
                await loadDashboard();
            }
        };

        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        window.editUser = function(id) {
            showNotification(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${id} –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏`);
        };

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        window.showNewUsersCalendar = async function() {
            document.getElementById('newUsersCalendarModal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞ 30 –¥–Ω–µ–π
                const today = new Date();
                const calendarData = [];
                let selectedDayUsers = [];

                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    const nextDay = new Date(date);
                    nextDay.setDate(nextDay.getDate() + 1);

                    const dayUsers = users?.filter(u => {
                        const created = new Date(u.created_at);
                        return created >= date && created < nextDay;
                    }) || [];

                    calendarData.push({
                        date: new Date(date),
                        count: dayUsers.length,
                        users: dayUsers,
                        day: date.getDate(),
                        month: date.toLocaleDateString('ru-RU', { month: 'short' }),
                        weekday: date.toLocaleDateString('ru-RU', { weekday: 'short' })
                    });
                }

                // –§—É–Ω–∫—Ü–∏—è –∫–ª–∏–∫–∞ –ø–æ –¥–Ω—é
                window.selectNewUsersDay = function(dayIndex) {
                    selectedDayUsers = calendarData[dayIndex].users;
                    renderNewUsersList();
                };

                // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é —Å–µ—Ç–∫—É
                const weeks = [];
                let currentWeek = [];

                const firstDay = calendarData[0].date.getDay();
                const startPadding = firstDay === 0 ? 6 : firstDay - 1;
                for (let i = 0; i < startPadding; i++) {
                    currentWeek.push(null);
                }

                calendarData.forEach((d, index) => {
                    if (currentWeek.length === 7) {
                        weeks.push(currentWeek);
                        currentWeek = [];
                    }
                    currentWeek.push({...d, index});
                });

                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) {
                        currentWeek.push(null);
                    }
                    weeks.push(currentWeek);
                }

                let html = `
                    <div style="padding: 20px;">
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: #4CAF50;">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 8px;">
                            ${['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => `
                                <div style="text-align: center; font-size: 11px; color: rgba(255, 255, 255, 0.4); padding: 4px;">${day}</div>
                            `).join('')}
                        </div>
                        ${weeks.map(week => `
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 6px;">
                                ${week.map(day => {
                                    if (!day) return '<div></div>';

                                    const intensity = day.count === 0 ? 0 : Math.min(1, day.count / 5);
                                    const color = day.count === 0
                                        ? 'rgba(255, 255, 255, 0.03)'
                                        : `rgba(76, 175, 80, ${0.2 + intensity * 0.8})`;

                                    const isToday = day.date.toDateString() === today.toDateString();

                                    return `
                                        <div style="
                                            aspect-ratio: 1;
                                            background: ${color};
                                            border: 1px solid ${isToday ? '#4CAF50' : 'rgba(255, 255, 255, 0.08)'};
                                            border-radius: 8px;
                                            display: flex;
                                            flex-direction: column;
                                            align-items: center;
                                            justify-content: center;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            position: relative;
                                            padding: 4px;
                                        " title="${day.day} ${day.month}: ${day.count} –Ω–æ–≤—ã—Ö"
                                          onclick="selectNewUsersDay(${day.index})"
                                          onmouseover="this.style.transform='scale(1.05)'"
                                          onmouseout="this.style.transform='scale(1)'">
                                            <div style="font-size: 12px; color: ${day.count > 0 ? '#000' : 'rgba(255, 255, 255, 0.6)'}; font-weight: 600;">
                                                ${day.day}
                                            </div>
                                            ${day.count > 0 ? `
                                                <div style="font-size: 10px; color: ${intensity > 0.5 ? '#000' : '#4CAF50'}; margin-top: 2px; font-weight: 700;">
                                                    +${day.count}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}

                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">–ú–µ–Ω—å—à–µ</span>
                            <div style="display: flex; gap: 4px;">
                                ${[0, 0.2, 0.4, 0.6, 0.8, 1].map(intensity => `
                                    <div style="
                                        width: 16px;
                                        height: 16px;
                                        background: ${intensity === 0 ? 'rgba(255, 255, 255, 0.03)' : `rgba(76, 175, 80, ${0.2 + intensity * 0.8})`};
                                        border: 1px solid rgba(255, 255, 255, 0.08);
                                        border-radius: 3px;
                                    "></div>
                                `).join('')}
                            </div>
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">–ë–æ–ª—å—à–µ</span>
                        </div>
                    </div>`;

                document.getElementById('newUsersCalendarContent').innerHTML = html;

                // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                window.renderNewUsersList = function() {
                    if (selectedDayUsers.length === 0) {
                        document.getElementById('newUsersListContent').innerHTML = `
                            <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">
                                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                            </div>`;
                        return;
                    }

                    const listHtml = `
                        <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #4CAF50; font-size: 14px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${selectedDayUsers.length})</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">ID</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">–ò–º—è</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">–î–∞—Ç–∞</th>
                                            <th style="text-align: right; padding: 8px; color: rgba(255, 255, 255, 0.7);">–ë–∞–ª–∞–Ω—Å</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${selectedDayUsers.map(user => `
                                            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.8);">${user.telegram_id}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.9);">${user.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.6);">${new Date(user.created_at).toLocaleDateString()}</td>
                                                <td style="padding: 8px; text-align: right; color: #FFD700;">${user.balance || 0}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;

                    document.getElementById('newUsersListContent').innerHTML = listHtml;
                };

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
                renderNewUsersList();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                document.getElementById('newUsersContent').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        };

        window.closeNewUsersCalendarModal = function() {
            document.getElementById('newUsersCalendarModal').classList.remove('active');
        };

        // –§—É–Ω–∫—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        window.showChurnedUsersCalendar = async function() {
            document.getElementById('churnedUsersCalendarModal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('last_seen_at', { ascending: true, nullsFirst: false });

                const today = new Date();
                const calendarData = [];
                let selectedDayUsers = [];

                // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞ 30 –¥–Ω–µ–π –¥–ª—è –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    const nextDay = new Date(date);
                    nextDay.setDate(nextDay.getDate() + 1);

                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–≤–∞–ª–∏–ª–∏—Å—å –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å (–Ω–µ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã 3+ –¥–Ω—è –æ—Ç —ç—Ç–æ–π –¥–∞—Ç—ã)
                    const dayChurnedUsers = users?.filter(u => {
                        const lastActive = new Date(u.last_seen_at || u.last_active || u.created_at);
                        const threeDaysFromDate = new Date(date.getTime() + 3 * 24 * 60 * 60 * 1000);

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±—ã–ª–∞ —Ä–∞–Ω—å—à–µ —á–µ–º 3 –¥–Ω—è –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
                        // –ò —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª —Å–æ–∑–¥–∞–Ω —Ä–∞–Ω—å—à–µ —á–µ–º 3 –¥–Ω—è –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
                        return lastActive < date && lastActive >= new Date(date.getTime() - 24 * 60 * 60 * 1000);
                    }) || [];

                    calendarData.push({
                        date: new Date(date),
                        count: dayChurnedUsers.length,
                        users: dayChurnedUsers,
                        day: date.getDate(),
                        month: date.toLocaleDateString('ru-RU', { month: 'short' }),
                        weekday: date.toLocaleDateString('ru-RU', { weekday: 'short' })
                    });
                }

                // –§—É–Ω–∫—Ü–∏—è –∫–ª–∏–∫–∞ –ø–æ –¥–Ω—é
                window.selectChurnedUsersDay = function(dayIndex) {
                    selectedDayUsers = calendarData[dayIndex].users;
                    renderChurnedUsersList();
                };

                // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é —Å–µ—Ç–∫—É
                const weeks = [];
                let currentWeek = [];

                const firstDay = calendarData[0].date.getDay();
                const startPadding = firstDay === 0 ? 6 : firstDay - 1;
                for (let i = 0; i < startPadding; i++) {
                    currentWeek.push(null);
                }

                calendarData.forEach((d, index) => {
                    if (currentWeek.length === 7) {
                        weeks.push(currentWeek);
                        currentWeek = [];
                    }
                    currentWeek.push({...d, index});
                });

                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) {
                        currentWeek.push(null);
                    }
                    weeks.push(currentWeek);
                }

                let html = `
                    <div style="padding: 20px;">
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: #FF5722;">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 8px;">
                            ${['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map(day => `
                                <div style="text-align: center; font-size: 11px; color: rgba(255, 255, 255, 0.4); padding: 4px;">${day}</div>
                            `).join('')}
                        </div>
                        ${weeks.map(week => `
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 6px;">
                                ${week.map(day => {
                                    if (!day) return '<div></div>';

                                    const intensity = day.count === 0 ? 0 : Math.min(1, day.count / 3);
                                    const color = day.count === 0
                                        ? 'rgba(255, 255, 255, 0.03)'
                                        : `rgba(255, 87, 34, ${0.2 + intensity * 0.8})`;

                                    const isToday = day.date.toDateString() === today.toDateString();

                                    return `
                                        <div style="
                                            aspect-ratio: 1;
                                            background: ${color};
                                            border: 1px solid ${isToday ? '#FF5722' : 'rgba(255, 255, 255, 0.08)'};
                                            border-radius: 8px;
                                            display: flex;
                                            flex-direction: column;
                                            align-items: center;
                                            justify-content: center;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            position: relative;
                                            padding: 4px;
                                        " title="${day.day} ${day.month}: ${day.count} –æ—Ç–≤–∞–ª–∏–ª–∏—Å—å"
                                          onclick="selectChurnedUsersDay(${day.index})"
                                          onmouseover="this.style.transform='scale(1.05)'"
                                          onmouseout="this.style.transform='scale(1)'">
                                            <div style="font-size: 12px; color: ${day.count > 0 ? '#fff' : 'rgba(255, 255, 255, 0.6)'}; font-weight: 600;">
                                                ${day.day}
                                            </div>
                                            ${day.count > 0 ? `
                                                <div style="font-size: 10px; color: ${intensity > 0.5 ? '#fff' : '#FF5722'}; margin-top: 2px; font-weight: 700;">
                                                    -${day.count}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}

                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">–ú–µ–Ω—å—à–µ</span>
                            <div style="display: flex; gap: 4px;">
                                ${[0, 0.2, 0.4, 0.6, 0.8, 1].map(intensity => `
                                    <div style="
                                        width: 16px;
                                        height: 16px;
                                        background: ${intensity === 0 ? 'rgba(255, 255, 255, 0.03)' : `rgba(255, 87, 34, ${0.2 + intensity * 0.8})`};
                                        border: 1px solid rgba(255, 255, 255, 0.08);
                                        border-radius: 3px;
                                    "></div>
                                `).join('')}
                            </div>
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">–ë–æ–ª—å—à–µ</span>
                        </div>
                    </div>`;

                document.getElementById('churnedUsersCalendarContent').innerHTML = html;

                // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ —Å–ø–∏—Å–∫–∞ –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                window.renderChurnedUsersList = function() {
                    if (selectedDayUsers.length === 0) {
                        document.getElementById('churnedUsersListContent').innerHTML = `
                            <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">
                                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                            </div>`;
                        return;
                    }

                    const listHtml = `
                        <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #FF5722; font-size: 14px;">–û—Ç–≤–∞–ª–∏–≤—à–∏–µ—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (${selectedDayUsers.length})</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">ID</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">–ò–º—è</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                                            <th style="text-align: right; padding: 8px; color: rgba(255, 255, 255, 0.7);">–ë–∞–ª–∞–Ω—Å</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${selectedDayUsers.map(user => `
                                            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.8);">${user.telegram_id}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.9);">${user.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.6);">${new Date(user.last_seen_at || user.created_at).toLocaleDateString()}</td>
                                                <td style="padding: 8px; text-align: right; color: #FFD700;">${user.balance || 0}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;

                    document.getElementById('churnedUsersListContent').innerHTML = listHtml;
                };

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
                renderChurnedUsersList();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è:', error);
                document.getElementById('churnedContent').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        };

        window.closeChurnedUsersCalendarModal = function() {
            document.getElementById('churnedUsersCalendarModal').classList.remove('active');
        };

        window.showNoTasksStats = async function() {
            document.getElementById('noTasksModal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è, –Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞–Ω–∏—è
                const noTasksUsers = users.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    return lastActive && new Date(lastActive) >= today && u.balance_ar <= 50;
                });

                let html = `
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(241, 196, 15, 0.1); border-radius: 10px;">
                        <p style="margin: 0; font-size: 13px;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∑–∞–¥–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è: <strong style="color: #f1c40f;">${noTasksUsers.length}</strong></p>
                    </div>
                    <table style="width: 100%; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th style="text-align: center; padding: 10px;">ID</th>
                                <th style="text-align: center; padding: 10px;">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                                <th style="text-align: center; padding: 10px;">–ë–∞–ª–∞–Ω—Å</th>
                            </tr>
                        </thead>
                        <tbody>`;

                noTasksUsers.forEach(user => {
                    const lastActive = user.last_seen_at || user.last_active || user.last_login;
                    html += `
                        <tr style="border-top: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${createAvatar(user)}
                                    <span>${user.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</span>
                                </div>
                            </td>
                            <td style="text-align: center; padding: 10px; color: rgba(255,255,255,0.6);">${user.telegram_id}</td>
                            <td style="text-align: center; padding: 10px;">${new Date(lastActive).toLocaleTimeString('ru-RU')}</td>
                            <td style="text-align: center; padding: 10px;">${user.balance_ar} AR</td>
                        </tr>`;
                });

                html += `
                        </tbody>
                    </table>`;

                document.getElementById('noTasksContent').innerHTML = html;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–µ–∑ –∑–∞–¥–∞–Ω–∏–π:', error);
                document.getElementById('noTasksContent').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        };

        window.closeNoTasksModal = function() {
            document.getElementById('noTasksModal').classList.remove('active');
        };

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–í–ò–ó–ê–ú–ò =====

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–∏–∑–æ–≤
        window.loadQuizzes = async function() {
            console.log('–†–∞–∑–¥–µ–ª –ó–∞–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω');
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–≤–∏–∑–æ–≤ –∏–∑ –ë–î...');

            try {
                const { data: quizzes, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('type', 'educational_quiz')
                    .order('created_at', { ascending: false });

                console.log('–û—Ç–≤–µ—Ç –æ—Ç –ë–î –ø–æ–ª—É—á–µ–Ω:', { quizzes, error });

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∏–∑–æ–≤:', error);
                    document.getElementById('quizzesList').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∏–∑–æ–≤</p>';
                    return;
                }

                const quizzesList = document.getElementById('quizzesList');
                
                if (!quizzes || quizzes.length === 0) {
                    quizzesList.innerHTML = '<p style="color: rgba(255, 255, 255, 0.6);">–ö–≤–∏–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }

                quizzesList.innerHTML = quizzes.map(quiz => `
                    <div class="quiz-card">
                        <div class="quiz-header">
                            <h3 class="quiz-title">${quiz.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                            <label class="quiz-toggle">
                                <input type="checkbox" ${quiz.is_active ? 'checked' : ''}
                                       onchange="toggleQuizStatus('${quiz.id}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="quiz-info">
                            <div class="quiz-stat">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="#FFD700" stroke-width="2"/>
                                    <path d="M12 6V12L16 14" stroke="#FFD700" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>${quiz.reward_ar || 0} AR</span>
                            </div>
                            <div class="quiz-stat">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 11H15M9 15H15M7 7H17C18.1 7 19 7.9 19 9V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V9C5 7.9 5.9 7 7 7Z" stroke="#888" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>${quiz.questions?.length || 0} –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                            </div>
                        </div>
                        <div class="quiz-actions">
                            <button onclick="editQuiz('${quiz.id}')" class="quiz-btn quiz-btn-edit">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.4374 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button onclick="deleteQuiz('${quiz.id}')" class="quiz-btn quiz-btn-delete">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M18 6L6 18M6 6L18 18" stroke="#ff4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('quizzesList').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∏–∑–æ–≤</p>';
            }
        };

        // –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        function getQuestionsCount(questions) {
            if (!questions) return 0;
            if (Array.isArray(questions)) return questions.length;
            if (questions.questions && Array.isArray(questions.questions)) return questions.questions.length;
            return 0;
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
        window.openQuizModal = function() {
            document.getElementById('quiz-modal').style.display = 'flex';
            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            document.getElementById('quiz-title').value = '';
            document.getElementById('quiz-description').value = '';
            document.getElementById('quiz-reward').value = '50';
            document.getElementById('quiz-completion').value = '';
            document.getElementById('questions-container').innerHTML = '';
        };

        window.closeQuizModal = function() {
            document.getElementById('quiz-modal').style.display = 'none';
        };

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        window.addQuestion = function() {
            const container = document.getElementById('questions-container');
            const questionCount = container.children.length + 1;

            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.style.cssText = `
                border: 1px solid rgba(255,215,0,0.3);
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                background: rgba(255,255,255,0.05);
            `;

            questionDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="color: #FFD700; font-weight: 500;">–í–æ–ø—Ä–æ—Å ${questionCount}:</label>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(255,68,68,0.2);
                        color: #ff4444;
                        border: 1px solid rgba(255,68,68,0.3);
                        border-radius: 5px;
                        padding: 5px 10px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    ">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                            <path d="M18 6L6 18M6 6L18 18" stroke="#ff4444" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
                <input type="text" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞" class="input-field question-text">
                <div style="margin-top: 10px;">
                    <label style="color: #888; font-size: 12px;">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:</label>
                    <div class="answers-container">
                        <div style="margin: 5px 0;">
                            <input type="radio" name="correct-${questionCount}" value="0">
                            <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1" class="input-field answer-option" style="width: calc(100% - 30px); display: inline-block; margin: 0;">
                        </div>
                        <div style="margin: 5px 0;">
                            <input type="radio" name="correct-${questionCount}" value="1">
                            <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2" class="input-field answer-option" style="width: calc(100% - 30px); display: inline-block; margin: 0;">
                        </div>
                        <div style="margin: 5px 0;">
                            <input type="radio" name="correct-${questionCount}" value="2">
                            <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 3" class="input-field answer-option" style="width: calc(100% - 30px); display: inline-block; margin: 0;">
                        </div>
                        <div style="margin: 5px 0;">
                            <input type="radio" name="correct-${questionCount}" value="3">
                            <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 4" class="input-field answer-option" style="width: calc(100% - 30px); display: inline-block; margin: 0;">
                        </div>
                    </div>
                    <label style="color: #888; font-size: 12px; margin-top: 10px; display: block;">–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
                </div>
            `;

            container.appendChild(questionDiv);
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–≤–∏–∑–∞ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.saveQuizFromModal = async function() {
            try {
                const title = document.getElementById('quiz-title').value.trim();
                const description = document.getElementById('quiz-description').value.trim();
                const reward_ar = parseInt(document.getElementById('quiz-reward').value) || 50;
                const completion_message = document.getElementById('quiz-completion').value.trim() || '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–≤–∏–∑–∞!';

                if (!title) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞');
                    return;
                }

                // –°–æ–±–∏—Ä–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
                const questionItems = document.querySelectorAll('#questions-container .question-item');
                const questions = [];

                questionItems.forEach((item, index) => {
                    const questionText = item.querySelector('.question-text').value.trim();
                    const answerOptions = item.querySelectorAll('.answer-option');
                    const correctRadio = item.querySelector(`input[name="correct-${index+1}"]:checked`);

                    if (questionText) {
                        const answers = [];
                        answerOptions.forEach(option => {
                            if (option.value.trim()) {
                                answers.push(option.value.trim());
                            }
                        });

                        if (answers.length > 0 && correctRadio) {
                            questions.push({
                                question: questionText,
                                answers: answers,
                                correct: parseInt(correctRadio.value)
                            });
                        }
                    }
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                const editId = document.getElementById('quiz-modal').getAttribute('data-edit-id');

                const quizData = {
                    type: 'educational_quiz',
                    title,
                    description,
                    reward_ar,
                    questions: questions,
                    completion_message,
                    is_active: true
                };

                console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–≤–∏–∑:', quizData);

                let result;
                if (editId) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–≤–∏–∑
                    result = await supabase
                        .from('tasks')
                        .update(quizData)
                        .eq('id', editId)
                        .select();
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–≤–∏–∑
                    result = await supabase
                        .from('tasks')
                        .insert([quizData])
                        .select();
                }

                if (result.error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–≤–∏–∑–∞:', result.error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–≤–∏–∑–∞: ' + result.error.message);
                    return;
                }

                // –û—á–∏—â–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('quiz-modal').removeAttribute('data-edit-id');

                closeQuizModal();
                await loadQuizzes();
                alert(editId ? '–ö–≤–∏–∑ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–ö–≤–∏–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–≤–∏–∑–∞');
            }
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–≤–∏–∑–∞ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        window.showCreateQuizForm = function() {
            document.getElementById('createQuizForm').style.display = 'block';
            document.getElementById('completionMessage').value = '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–≤–∏–∑–∞!';
            
            // –°–±—Ä–æ—Å –≤–æ–ø—Ä–æ—Å–æ–≤
            const container = document.getElementById('questionsContainer');
            container.innerHTML = `
                <div class="question-item" style="
                    border: 1px solid rgba(255,215,0,0.3);
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 15px;
                    background: rgba(255,255,255,0.05);
                ">
                    <div style="margin-bottom: 10px;">
                        <label style="color: white; display: block; margin-bottom: 5px;">–í–æ–ø—Ä–æ—Å 1:</label>
                        <input type="text" class="question-text" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid rgba(255,255,255,0.2);
                            border-radius: 6px;
                            background: rgba(255,255,255,0.1);
                            color: white;
                        ">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="color: white; display: block; margin-bottom: 5px;">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É):</label>
                        <textarea class="question-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1&#10;–í–∞—Ä–∏–∞–Ω—Ç 2&#10;–í–∞—Ä–∏–∞–Ω—Ç 3&#10;–í–∞—Ä–∏–∞–Ω—Ç 4" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid rgba(255,255,255,0.2);
                            border-radius: 6px;
                            background: rgba(255,255,255,0.1);
                            color: white;
                            height: 80px;
                            resize: vertical;
                        "></textarea>
                    </div>
                    <div>
                        <label style="color: white; display: block; margin-bottom: 5px;">–û–±—É—á–∞—é—â–∏–π —Ç–µ–∫—Å—Ç:</label>
                        <textarea class="question-education" placeholder="–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞" style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid rgba(255,255,255,0.2);
                            border-radius: 6px;
                            background: rgba(255,255,255,0.1);
                            color: white;
                            height: 60px;
                            resize: vertical;
                        "></textarea>
                    </div>
                </div>
            `;
        }

        // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–≤–∏–∑–∞
        function hideCreateQuizForm() {
            document.getElementById('createQuizForm').style.display = 'none';
            // –û—á–∏—â–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('createQuizForm').removeAttribute('data-edit-id');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
            const saveBtn = document.querySelector('button[onclick="saveQuiz()"]');
            if (saveBtn) {
                saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–≤–∏–∑';
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
        function addQuestion() {
            const container = document.getElementById('questionsContainer');
            const questionCount = container.children.length + 1;
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.style.cssText = `
                border: 1px solid rgba(255,215,0,0.3);
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                background: rgba(255,255,255,0.05);
            `;
            
            questionDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <label style="color: #FFD700; font-weight: 500; font-size: 16px;">–í–æ–ø—Ä–æ—Å ${questionCount}:</label>
                    <button onclick="removeQuestion(this)" style="
                        background: rgba(255,68,68,0.2);
                        color: #ff4444;
                        border: 1px solid rgba(255,68,68,0.3);
                        border-radius: 6px;
                        padding: 6px 12px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 500;
                        transition: all 0.3s;
                    " onmouseover="this.style.background='rgba(255,68,68,0.3)'; this.style.borderColor='#ff4444';"
                       onmouseout="this.style.background='rgba(255,68,68,0.2)'; this.style.borderColor='rgba(255,68,68,0.3)';">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="text" class="question-text" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞" style="
                        width: 100%;
                        padding: 12px;
                        border: 1px solid rgba(255,255,255,0.2);
                        border-radius: 8px;
                        background: rgba(255,255,255,0.1);
                        color: white;
                        font-size: 14px;
                        transition: all 0.3s;
                    " onfocus="this.style.borderColor='#FFD700'; this.style.background='rgba(255,255,255,0.15)';"
                       onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(255,255,255,0.1)';">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É):</label>
                    <textarea class="question-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1&#10;–í–∞—Ä–∏–∞–Ω—Ç 2&#10;–í–∞—Ä–∏–∞–Ω—Ç 3&#10;–í–∞—Ä–∏–∞–Ω—Ç 4" style="
                        width: 100%;
                        padding: 12px;
                        border: 1px solid rgba(255,255,255,0.2);
                        border-radius: 8px;
                        background: rgba(255,255,255,0.1);
                        color: white;
                        height: 100px;
                        resize: vertical;
                        font-size: 14px;
                        transition: all 0.3s;
                    " onfocus="this.style.borderColor='#FFD700'; this.style.background='rgba(255,255,255,0.15)';"
                       onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(255,255,255,0.1)';"></textarea>
                </div>
                <div>
                    <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">–û–±—É—á–∞—é—â–∏–π —Ç–µ–∫—Å—Ç:</label>
                    <textarea class="question-education" placeholder="–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞" style="
                        width: 100%;
                        padding: 12px;
                        border: 1px solid rgba(255,255,255,0.2);
                        border-radius: 8px;
                        background: rgba(255,255,255,0.1);
                        color: white;
                        height: 80px;
                        resize: vertical;
                        font-size: 14px;
                        transition: all 0.3s;
                    " onfocus="this.style.borderColor='#FFD700'; this.style.background='rgba(255,255,255,0.15)';"
                       onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(255,255,255,0.1)';"></textarea>
                </div>
            `;
            
            container.appendChild(questionDiv);
        }

        // –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å
        function removeQuestion(button) {
            const questionItem = button.closest('.question-item');
            questionItem.remove();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
            const container = document.getElementById('questionsContainer');
            const questions = container.querySelectorAll('.question-item');
            questions.forEach((item, index) => {
                const label = item.querySelector('label');
                if (label) {
                    label.textContent = `–í–æ–ø—Ä–æ—Å ${index + 1}:`;
                }
            });
        }

        // –°–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ñ–æ—Ä–º—ã
        function collectQuestions() {
            const questions = [];
            const questionItems = document.querySelectorAll('.question-item');
            
            questionItems.forEach((item, index) => {
                const text = item.querySelector('.question-text').value.trim();
                const optionsText = item.querySelector('.question-options').value.trim();
                const education = item.querySelector('.question-education').value.trim();
                
                if (text && optionsText) {
                    const options = optionsText.split('\n').filter(opt => opt.trim()).map(opt => opt.trim());
                    
                    questions.push({
                        question: text,
                        options: options,
                        education_text: education || '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç!'
                    });
                }
            });
            
            return questions;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–≤–∏–∑–∞
        async function saveQuiz() {
            try {
                const title = document.getElementById('quizTitle').value.trim();
                const description = document.getElementById('quizDescription').value.trim();
                const reward_ar = parseInt(document.getElementById('quizReward').value) || 100;
                const completion_message = document.getElementById('completionMessage').value.trim() || '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–≤–∏–∑–∞!';
                
                if (!title) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞');
                    return;
                }
                
                const questions = collectQuestions();
                if (questions.length === 0) {
                    alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
                    return;
                }
                
                // –í–ê–ñ–ù–û: questions –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º!
                const quizData = {
                    type: 'educational_quiz',
                    title: title,
                    description: description,
                    reward_ar: reward_ar,
                    questions: questions, // –ú–ê–°–°–ò–í, –Ω–µ –æ–±—ä–µ–∫—Ç!
                    completion_message: completion_message,
                    is_active: true
                };
                
                console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–≤–∏–∑:', quizData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–≤–∏–∑
                const editId = document.getElementById('createQuizForm').getAttribute('data-edit-id');
                
                let result;
                if (editId) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–≤–∏–∑
                    result = await supabase
                        .from('tasks')
                        .update(quizData)
                        .eq('id', editId)
                        .select();
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–≤–∏–∑
                    result = await supabase
                        .from('tasks')
                        .insert([quizData])
                        .select();
                }
                
                if (result.error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–≤–∏–∑–∞:', result.error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–≤–∏–∑–∞: ' + result.error.message);
                    return;
                }
                
                alert(editId ? '–ö–≤–∏–∑ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–ö–≤–∏–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                hideCreateQuizForm();
                loadQuizzes(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–≤–∏–∑–∞');
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞
        window.editQuiz = async function(quizId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–≤–∏–∑–∞
                const { data: quiz, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .eq('id', quizId)
                    .single();

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∏–∑–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∏–∑–∞');
                    return;
                }

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                openQuizModal();

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∫–≤–∏–∑–∞
                document.getElementById('quiz-title').value = quiz.title || '';
                document.getElementById('quiz-description').value = quiz.description || '';
                document.getElementById('quiz-reward').value = quiz.reward_ar || 50;
                document.getElementById('quiz-completion').value = quiz.completion_message || '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–≤–∏–∑–∞!';

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–≤–∏–∑–∞
                document.getElementById('quiz-modal').setAttribute('data-edit-id', quizId);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
                const container = document.getElementById('questions-container');
                container.innerHTML = '';

                let questions = [];
                if (quiz.questions) {
                    if (Array.isArray(quiz.questions)) {
                        questions = quiz.questions;
                    }
                }

                if (questions.length > 0) {
                    questions.forEach((q, index) => {
                        addQuestion();
                        const questionItems = container.querySelectorAll('.question-item');
                        const currentItem = questionItems[index];

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
                        currentItem.querySelector('.question-text').value = q.question || '';

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
                        const answerOptions = currentItem.querySelectorAll('.answer-option');
                        if (q.answers && Array.isArray(q.answers)) {
                            q.answers.forEach((answer, ansIndex) => {
                                if (answerOptions[ansIndex]) {
                                    answerOptions[ansIndex].value = answer;
                                }
                            });
                        }

                        // –û—Ç–º–µ—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                        const correctRadio = currentItem.querySelector(`input[name="correct-${index+1}"][value="${q.correct}"]`);
                        if (correctRadio) {
                            correctRadio.checked = true;
                        }
                    });
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –ø—É—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å
                    addQuestion();
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–≤–∏–∑–∞:', error);
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            }
        };

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–≤–∏–∑–∞
        window.toggleQuizStatus = async function(quizId, isActive) {
            try {
                const { error } = await supabase
                    .from('tasks')
                    .update({ is_active: isActive })
                    .eq('id', quizId);

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                    // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                    await loadQuizzes();
                    return;
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                await loadQuizzes();
            }
        };

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–≤–∏–∑–∞
        window.deleteQuiz = async function(quizId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–≤–∏–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('id', quizId);

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–≤–∏–∑–∞:', error);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
                    return;
                }

                await loadQuizzes(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–≤–∏–∑–∞');
            }
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–≤–∏–∑—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞–∑–¥–µ–ª–∞
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–≤–∏–∑—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            setTimeout(loadQuizzes, 1000);
        });

        // ======================
        // –°–ò–°–¢–ï–ú–ê –õ–û–ì–û–í –ò –û–¢–õ–ê–î–ö–ò
        // ======================

        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ª–æ–≥–æ–≤
        let allLogs = [];
        let autoRefresh = false;
        let logsSection = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–æ–≤
        function initLogsSystem() {
            logsSection = document.getElementById('logs');
            if (!logsSection) return;

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console –º–µ—Ç–æ–¥—ã
            const originalConsole = {
                log: console.log,
                error: console.error,
                warn: console.warn,
                info: console.info
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∞
            function addLog(level, args, originalMethod) {
                const timestamp = new Date();
                const message = args.map(arg =>
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ª–æ–≥–∞
                let logType = 'general';
                if (message.includes('[AUTH]')) logType = 'auth';
                else if (message.includes('REFERRAL') || message.includes('[REFERRAL]')) logType = 'referral';
                else if (level === 'error') logType = 'error';

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
                const logEntry = {
                    timestamp,
                    level,
                    message,
                    type: logType,
                    id: Date.now() + Math.random()
                };

                allLogs.push(logEntry);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 500)
                if (allLogs.length > 500) {
                    allLogs = allLogs.slice(-500);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ –ª–æ–≥–æ–≤
                if (document.getElementById('logs').classList.contains('active')) {
                    updateLogsDisplay();
                }

                // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
                originalMethod.apply(console, args);
            }

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            console.log = function(...args) { addLog('log', args, originalConsole.log); };
            console.error = function(...args) { addLog('error', args, originalConsole.error); };
            console.warn = function(...args) { addLog('warn', args, originalConsole.warn); };
            console.info = function(...args) { addLog('info', args, originalConsole.info); };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);
            document.getElementById('autoRefreshBtn').addEventListener('click', toggleAutoRefresh);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            ['filterAuth', 'filterReferral', 'filterError', 'filterGeneral'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateLogsDisplay);
            });

            document.getElementById('searchLogs').addEventListener('input', updateLogsDisplay);

            console.log('üîç [LOGS] –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ - –≤—Å–µ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –∏–∑ localStorage
        function loadLogsFromStorage() {
            try {
                const logs = localStorage.getItem('ar_arena_logs');
                if (logs) {
                    allLogs = JSON.parse(logs);
                    console.log(`üîß [ADMIN] –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allLogs.length} –ª–æ–≥–æ–≤ –∏–∑ localStorage`);
                } else {
                    allLogs = [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤ –∏–∑ localStorage:', error);
                allLogs = [];
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–≥–æ–≤
        function updateLogsDisplay() {
            const console = document.getElementById('logsConsole');
            if (!console) return;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –ª–æ–≥–∏ –∏–∑ localStorage
            loadLogsFromStorage();

            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const filters = {
                auth: document.getElementById('filterAuth').checked,
                referral: document.getElementById('filterReferral').checked,
                error: document.getElementById('filterError').checked,
                general: document.getElementById('filterGeneral').checked
            };

            const searchTerm = document.getElementById('searchLogs').value.toLowerCase();

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ª–æ–≥–∏
            let filteredLogs = allLogs.filter(log => {
                if (!filters[log.type]) return false;
                if (searchTerm && !log.message.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –ª–æ–≥–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            filteredLogs = filteredLogs.slice(-100);

            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML
            if (filteredLogs.length === 0) {
                console.innerHTML = `
                    <div style="color: #888; text-align: center; margin-top: 200px;">
                        <span style="font-size: 16px;">üîç</span><br>
                        ${allLogs.length === 0 ?
                            '–û–∂–∏–¥–∞–Ω–∏–µ –ª–æ–≥–æ–≤... –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π' :
                            '–õ–æ–≥–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã - —Å–Ω–∏–º–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞'}
                    </div>
                `;
            } else {
                console.innerHTML = filteredLogs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString('ru-RU', { hour12: false });
                    const color = getLogColor(log.level, log.type);
                    const icon = getLogIcon(log.level, log.type);
                    const page = log.page ? `[${log.page}]` : '';

                    return `
                        <div style="margin: 2px 0; padding: 4px 0; border-left: 3px solid ${color}; padding-left: 10px;">
                            <span style="color: #888; font-size: 11px;">${time} ${page}</span>
                            <span style="color: ${color}; margin: 0 8px;">${icon}</span>
                            <span style="color: #e0e0e0;">${escapeHtml(log.message)}</span>
                        </div>
                    `;
                }).join('');
            }

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∫–æ–Ω—Ü—É
            console.scrollTop = console.scrollHeight;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateLogsStats();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–∏–ø–∞ –ª–æ–≥–∞
        function getLogColor(level, type) {
            if (type === 'auth') return '#FFD700';
            if (type === 'referral') return '#4CAF50';
            if (type === 'error' || level === 'error') return '#FF5722';
            if (level === 'warn') return '#FF9800';
            return '#2196F3';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–∞ –ª–æ–≥–∞
        function getLogIcon(level, type) {
            if (type === 'auth') return 'AUTH';
            if (type === 'referral') return 'REF';
            if (type === 'error' || level === 'error') return 'ERR';
            if (level === 'warn') return 'WARN';
            return 'INFO';
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateLogsStats() {
            const stats = allLogs.reduce((acc, log) => {
                acc[log.type] = (acc[log.type] || 0) + 1;
                acc.total++;
                return acc;
            }, { auth: 0, referral: 0, error: 0, general: 0, total: 0 });

            document.getElementById('authLogsCount').textContent = stats.auth;
            document.getElementById('referralLogsCount').textContent = stats.referral;
            document.getElementById('errorLogsCount').textContent = stats.error;
            document.getElementById('totalLogsCount').textContent = stats.total;
        }

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
        function clearLogs() {
            allLogs = [];
            try {
                localStorage.removeItem('ar_arena_logs');
                console.log('üîç [LOGS] –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã –∏–∑ localStorage');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤:', error);
            }
            updateLogsDisplay();
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤
        function exportLogs() {
            const content = allLogs.map(log =>
                `${log.timestamp.toISOString()} [${log.level.toUpperCase()}] [${log.type.toUpperCase()}] ${log.message}`
            ).join('\n');

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ar-arena-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('üîç [LOGS] –õ–æ–≥–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('autoRefreshBtn');

            if (autoRefresh) {
                btn.innerHTML = '–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í–ö–õ';
                btn.style.background = 'linear-gradient(135deg, #FF6B35, #F7931E)';
                startAutoRefresh();
            } else {
                btn.innerHTML = '–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –í–´–ö–õ';
                btn.style.background = 'linear-gradient(135deg, #11998E, #38EF7D)';
                stopAutoRefresh();
            }

            console.log(`üîç [LOGS] –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${autoRefresh ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`);
        }

        // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        let autoRefreshInterval;
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                if (document.getElementById('logs').classList.contains('active')) {
                    updateLogsDisplay();
                }
            }, 2000);
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(() => {
            initLogsSystem();
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏ –∏–∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            loadLogsFromStorage();
            updateLogsDisplay();
        }, 1000);

        // –ó–∞–ø—É—Å–∫
        init();
    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π -->
    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="newUsersCalendarModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
                <button onclick="closeNewUsersCalendarModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="newUsersCalendarContent">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div id="newUsersListContent" style="margin-top: 20px;">
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="churnedUsersCalendarModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>–û—Ç–≤–∞–ª–∏–≤—à–∏–µ—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
                <button onclick="closeChurnedUsersCalendarModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="churnedUsersCalendarContent">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div id="churnedUsersListContent" style="margin-top: 20px;">
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–≤–∞–ª–∏–≤—à–∏—Ö—Å—è -->
    <div id="churnedModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>–û—Ç–≤–∞–ª–∏–≤—à–∏–µ—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <button onclick="closeChurnedModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="churnedContent" style="max-height: 500px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–µ–∑ –∑–∞–¥–∞–Ω–∏–π -->
    <div id="noTasksModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –∑–∞–¥–∞–Ω–∏–π</h3>
                <button onclick="closeNoTasksModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="noTasksContent" style="max-height: 500px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é -->
    <nav class="bottom-navigation">
        <div class="nav-item" onclick="window.location.href='index.html'">
            <img src="icons/main.png" alt="–ì–ª–∞–≤–Ω–∞—è" class="nav-icon">
            <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" onclick="window.location.href='tasks.html'">
            <img src="icons/todo.png" alt="–ó–∞–¥–∞–Ω–∏—è" class="nav-icon">
            <span class="nav-label">–ó–∞–¥–∞–Ω–∏—è</span>
        </div>
        <div class="nav-item" onclick="window.location.href='games.html'">
            <img src="icons/gamepad.png" alt="–ò–≥—Ä—ã" class="nav-icon">
            <span class="nav-label">–ò–≥—Ä—ã</span>
        </div>
        <div class="nav-item" onclick="window.location.href='shop.html'">
            <img src="icons/SHOP.png" alt="–ú–∞–≥–∞–∑–∏–Ω" class="nav-icon">
            <span class="nav-label">–ú–∞–≥–∞–∑–∏–Ω</span>
        </div>
        <div class="nav-item active" onclick="window.location.href='admin.html'">
            <img src="icons/admin.png" alt="–ê–¥–º–∏–Ω" class="nav-icon">
            <span class="nav-label">–ê–¥–º–∏–Ω</span>
        </div>
    </nav>

    <style>
    .bottom-navigation {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 400px;
        height: 60px;
        background: rgba(10, 10, 10, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 184, 0, 0.15);
        border-radius: 20px;
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        padding: 8px 6px;
    }

    .nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 6px 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .nav-item.active .nav-icon {
        filter: drop-shadow(0 4px 12px rgba(255, 215, 0, 0.8));
        transform: scale(1.1);
    }

    .nav-item.active .nav-label {
        color: #FFD700;
        font-weight: 700;
    }

    .nav-icon {
        width: 28px;
        height: 28px;
        object-fit: contain;
        display: block;
        transition: all 0.3s ease;
    }

    .nav-label {
        font-size: 9px;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 600;
        white-space: nowrap;
        transition: all 0.3s ease;
    }
    </style>

</body>
</html>