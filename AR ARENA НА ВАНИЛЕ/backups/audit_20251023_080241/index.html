<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AR ARENA - Главная</title>
    <link rel="stylesheet" href="home-styles.css?v=20251021">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили для роутера */
        .bottom-nav a {
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        main#app-content {
            transition: opacity 0.1s ease;
        }
    </style>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Подключение к нашей БД -->
    <script src="supabase-client.js"></script>
    <!-- Модуль авторизации -->
    <script src="auth.js?v=1759200000"></script>
</head>
<body>
    <!-- Floating particles background -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="container">
        <main id="app-content">
            <!-- Верхняя плашка с названием -->
            <div class="app-header">
                <h1 class="app-title" onclick="window.location.href='landing-ar.html'">AR ARENA</h1>
                <div class="app-subtitle">ACADEMY</div>
            </div>

            <!-- Карточка профиля -->
            <div class="profile-card">
            <div class="profile-top">
                <div class="profile-avatar-wrapper">
                    <img src="" alt="Avatar" class="profile-avatar" id="userAvatar">
                    <div class="avatar-placeholder" id="avatarPlaceholder" style="display: none;">
                        <span id="avatarInitial">Г</span>
                    </div>
                </div>
                <h2 class="profile-name" id="user-name">Гость</h2>
            </div>

            <div class="profile-buttons">
                <button class="profile-stat-btn" onclick="window.showFriends()">
                    <span class="stat-number" id="friendsCount">0</span>
                    <span class="stat-name">ДРУЗЕЙ</span>
                </button>
                <button class="profile-stat-btn" onclick="window.showBalance()">
                    <span class="stat-number" id="user-balance">—</span>
                    <span class="stat-name">МОНЕТ</span>
                </button>
                <button class="profile-stat-btn" onclick="window.showLevel()">
                    <span class="stat-number" id="streakDays">1</span>
                    <span class="stat-name">УРОВЕНЬ</span>
                </button>
            </div>
        </div>

        <!-- Грид с функциональными карточками -->
        <div class="features-grid">
            <!-- Задания -->
            <div class="feature-card" onclick="window.location.href='tasks.html'">
                <div class="feature-icon">
                    <img src="icons/todo.png" alt="Задания">
                </div>
                <div class="feature-content">
                    <h3 class="feature-title">Задания</h3>
                    <p class="feature-desc">Выполняйте задания<br>и зарабатывайте AR</p>
                    <div class="feature-badge">5 новых</div>
                </div>
            </div>

            <!-- Профиль -->
            <div class="feature-card" onclick="window.location.href='profile.html'">
                <div class="feature-icon">
                    <img src="icons/profil.png" alt="Профиль">
                </div>
                <div class="feature-content">
                    <h3 class="feature-title">Профиль</h3>
                    <p class="feature-desc">Управление<br>аккаунтом</p>
                    <div class="feature-badge green">Настройки</div>
                </div>
            </div>

            <!-- Реферальная программа -->
            <div class="feature-card" onclick="window.location.href='referral.html'">
                <div class="feature-icon">
                    <img src="icons/pp1.png" alt="Реферальная программа">
                </div>
                <div class="feature-content">
                    <h3 class="feature-title">Реферальная программа</h3>
                    <p class="feature-desc">Приглашайте друзей<br>получайте бонусы</p>
                    <div class="feature-badge red">+10% за друга</div>
                </div>
            </div>

            <!-- AR SHOP -->
            <div class="feature-card" onclick="window.location.href='shop.html'">
                <div class="feature-icon">
                    <img src="icons/SHOP.png" alt="AR SHOP">
                </div>
                <div class="feature-content">
                    <h3 class="feature-title">AR SHOP</h3>
                    <p class="feature-desc">Покупайте товары<br>за AR монеты</p>
                    <div class="feature-badge gold">Новинки</div>
                </div>
            </div>

        </div>
        </main>

        <!-- Нижняя навигация -->
        <nav class="bottom-navigation">
            <div class="nav-item active" onclick="window.location.href='index.html'">
                <img src="icons/main.png" alt="Главная" class="nav-icon">
                <span class="nav-label">Главная</span>
            </div>
            <div class="nav-item" onclick="window.location.href='tasks.html'">
                <img src="icons/todo.png" alt="Задания" class="nav-icon">
                <span class="nav-label">Задания</span>
            </div>
            <div class="nav-item" onclick="window.location.href='games.html'">
                <img src="icons/gamepad.png" alt="Игры" class="nav-icon">
                <span class="nav-label">Игры</span>
            </div>
            <div class="nav-item" onclick="window.location.href='shop.html'">
                <img src="icons/SHOP.png" alt="Магазин" class="nav-icon">
                <span class="nav-label">Магазин</span>
            </div>
            <div class="nav-item" onclick="window.location.href='admin.html?v=20251007'">
                <img src="icons/admin.png" alt="Админ" class="nav-icon">
                <span class="nav-label">Админ</span>
            </div>
        </nav>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram?.WebApp;
        tg?.ready();
        tg?.expand();

        // Получаем данные пользователя
        const user = tg?.initDataUnsafe?.user;

        // Загружаем данные пользователя
        function loadUserData() {
            // Сразу устанавливаем имя из Telegram, если есть
            if (user && user.first_name) {
                document.getElementById('user-name').textContent =
                    user.first_name + (user.last_name ? ' ' + user.last_name : '');
            }

            // Обрабатываем аватар
            if (user) {
                const avatarElement = document.getElementById('userAvatar');
                const placeholderElement = document.getElementById('avatarPlaceholder');

                if (user.photo_url) {
                    avatarElement.src = user.photo_url;
                    avatarElement.style.display = 'block';
                    placeholderElement.style.display = 'none';
                } else {
                    // Показываем заглушку с инициалом
                    const initials = (user.first_name || 'U').charAt(0).toUpperCase();
                    document.getElementById('avatarInitial').textContent = initials;
                    avatarElement.style.display = 'none';
                    placeholderElement.style.display = 'flex';
                }
            }

            // Загружаем количество друзей из localStorage
            const friends = localStorage.getItem('friendsCount') || '0';
            document.getElementById('friendsCount').textContent = friends;

            // Загружаем дни активности
            updateActivityStreak();
        }

        // Обновление счетчика дней активности
        function updateActivityStreak() {
            const today = new Date().toDateString();
            const lastVisit = localStorage.getItem('lastVisit');
            let streak = parseInt(localStorage.getItem('activityStreak') || '0');

            if (lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastVisit === yesterday.toDateString()) {
                    // Продолжаем серию
                    streak++;
                } else {
                    // Начинаем новую серию
                    streak = 1;
                }

                localStorage.setItem('activityStreak', streak);
                localStorage.setItem('lastVisit', today);
            }

            document.getElementById('streakDays').textContent = streak;
        }

        // Заглушки для функций
        function showReferral() {
            alert('Реферальная программа скоро будет доступна!');
        }

        function showProfile() {
            alert('Профиль в разработке!');
        }

        // Админ-панель (временно для всех)
        function checkAdminAccess() {
            // Временно отключено - админка доступна для всех
            const adminNavItem = document.getElementById('adminNavItem');
            if (adminNavItem) {
                adminNavItem.style.display = 'flex';
            }
        }

        // Вызываем проверку админа сразу при загрузке
        checkAdminAccess();

        function showFriends() {
            alert('Список друзей скоро будет доступен!');
        }

        function showBalance() {
            alert('История транзакций скоро будет доступна!');
        }

        function showLevel() {
            alert('Система уровней в разработке!');
        }

        // Загружаем данные при старте
        window.addEventListener('DOMContentLoaded', loadUserData);

        // Обновляем интерфейс при изменении пользователя
        window.addEventListener('userUpdated', function() {
            if (window.updateUserInterface) {
                window.updateUserInterface();
            }
            loadUserData();
        });
    </script>

    <!-- Подключение роутера -->
    <script src="router.js"></script>
</body>
</html>