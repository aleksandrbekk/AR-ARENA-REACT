<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ü–æ–∫—É–ø–∫–∞ –±–∏–ª–µ—Ç–æ–≤ - AR ARENA</title>
    <!-- Version: 20251021_NO_CONFIRM - Buy tickets with 1 click -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js?v=20251021"></script>
    <script src="auth.js?v=1759200000"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        /* HEADER */
        .page-header {
            text-align: center;
            margin-bottom: 24px;
            animation: fadeIn 0.5s ease;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.15));
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 24px;
            color: #FFD700;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.25));
            border-color: rgba(255, 215, 0, 0.7);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4);
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .page-title {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
        }

        /* BALANCE */
        .balance-card {
            background: linear-gradient(135deg,
                rgba(20, 20, 20, 0.9) 0%,
                rgba(30, 30, 30, 0.8) 100%
            );
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 18px;
            border: 2px solid rgba(255, 215, 0, 0.25);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.5),
                inset 0 0 30px rgba(255, 215, 0, 0.05);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: fadeIn 0.5s ease 0.1s backwards;
        }

        .balance-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .balance-icon {
            width: 36px;
            height: 36px;
            filter: drop-shadow(0 4px 12px rgba(255, 215, 0, 0.5));
        }

        .balance-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .balance-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            text-transform: uppercase;
        }

        .balance-value {
            font-size: 22px;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* TICKETS SECTION */
        .tickets-section {
            background: linear-gradient(135deg,
                rgba(20, 20, 20, 0.9) 0%,
                rgba(30, 30, 30, 0.8) 100%
            );
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 24px;
            border: 2px solid rgba(255, 215, 0, 0.25);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.5),
                inset 0 0 30px rgba(255, 215, 0, 0.05);
            margin-bottom: 24px;
            animation: fadeIn 0.5s ease 0.15s backwards;
        }

        .tickets-toggle {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 14px;
            padding: 4px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 24px;
        }

        .toggle-btn {
            background: transparent;
            border: none;
            border-radius: 11px;
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #0a0a0a;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* TICKETS GRID */
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .ticket-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 24px 18px;
            background: linear-gradient(145deg, #1f1f1f, #1a1a1a);
            background-size: 200% 200%;
            border-radius: 22px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            min-height: 160px;
            overflow: hidden;
            animation: cardBreathe 6s ease-in-out infinite;
        }

        @keyframes cardBreathe {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–ª–µ—Å–∫ —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç–æ—á–∫—É */
        .ticket-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -200%;
            width: 50%;
            height: 200%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.08) 25%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.08) 75%,
                transparent 100%
            );
            transform: skewX(-25deg);
            animation: cardShine 5s ease-in-out infinite;
        }

        @keyframes cardShine {
            0% {
                left: -200%;
            }
            50%, 100% {
                left: 200%;
            }
        }

        /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
        .ticket-item::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 20px;
            background: linear-gradient(
                145deg,
                rgba(255, 255, 255, 0.08) 0%,
                transparent 50%,
                rgba(0, 0, 0, 0.3) 100%
            );
            pointer-events: none;
            opacity: 0.7;
        }

        .ticket-item:hover {
            transform: translateY(-8px) scale(1.03);
        }

        .ticket-item:active {
            transform: translateY(-4px) scale(0.99);
        }

        /* Ticket 1 - Green */
        .ticket-item.green {
            background: linear-gradient(
                145deg,
                rgba(16, 185, 129, 0.15) 0%,
                rgba(5, 150, 105, 0.08) 50%,
                #1a1a1a 100%
            );
            box-shadow:
                0 8px 24px rgba(16, 185, 129, 0.3),
                0 4px 12px rgba(16, 185, 129, 0.2),
                inset 0 1px 0 rgba(16, 185, 129, 0.2);
            animation: pulseGreen 3s ease-in-out infinite, cardBreathe 6s ease-in-out infinite;
        }

        @keyframes pulseGreen {
            0%, 100% {
                box-shadow:
                    0 8px 24px rgba(16, 185, 129, 0.3),
                    0 4px 12px rgba(16, 185, 129, 0.2),
                    inset 0 1px 0 rgba(16, 185, 129, 0.2);
            }
            50% {
                box-shadow:
                    0 12px 32px rgba(16, 185, 129, 0.5),
                    0 6px 18px rgba(16, 185, 129, 0.3),
                    inset 0 1px 0 rgba(16, 185, 129, 0.3);
            }
        }

        .ticket-item.green:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow:
                0 16px 40px rgba(16, 185, 129, 0.6),
                0 8px 24px rgba(16, 185, 129, 0.4),
                inset 0 1px 0 rgba(16, 185, 129, 0.4);
        }

        /* Ticket 3 - Blue */
        .ticket-item.blue {
            background: linear-gradient(
                145deg,
                rgba(59, 130, 246, 0.15) 0%,
                rgba(37, 99, 235, 0.08) 50%,
                #1a1a1a 100%
            );
            box-shadow:
                0 8px 24px rgba(59, 130, 246, 0.3),
                0 4px 12px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(59, 130, 246, 0.2);
            animation: pulseBlue 3s ease-in-out infinite, cardBreathe 6s ease-in-out infinite;
        }

        @keyframes pulseBlue {
            0%, 100% {
                box-shadow:
                    0 8px 24px rgba(59, 130, 246, 0.3),
                    0 4px 12px rgba(59, 130, 246, 0.2),
                    inset 0 1px 0 rgba(59, 130, 246, 0.2);
            }
            50% {
                box-shadow:
                    0 12px 32px rgba(59, 130, 246, 0.5),
                    0 6px 18px rgba(59, 130, 246, 0.3),
                    inset 0 1px 0 rgba(59, 130, 246, 0.3);
            }
        }

        .ticket-item.blue:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow:
                0 16px 40px rgba(59, 130, 246, 0.6),
                0 8px 24px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(59, 130, 246, 0.4);
        }

        /* Ticket 10 - Purple */
        .ticket-item.purple {
            background: linear-gradient(
                145deg,
                rgba(168, 85, 247, 0.15) 0%,
                rgba(126, 34, 206, 0.08) 50%,
                #1a1a1a 100%
            );
            box-shadow:
                0 8px 24px rgba(168, 85, 247, 0.3),
                0 4px 12px rgba(168, 85, 247, 0.2),
                inset 0 1px 0 rgba(168, 85, 247, 0.2);
            animation: pulsePurple 3s ease-in-out infinite, cardBreathe 6s ease-in-out infinite;
        }

        @keyframes pulsePurple {
            0%, 100% {
                box-shadow:
                    0 8px 24px rgba(168, 85, 247, 0.3),
                    0 4px 12px rgba(168, 85, 247, 0.2),
                    inset 0 1px 0 rgba(168, 85, 247, 0.2);
            }
            50% {
                box-shadow:
                    0 12px 32px rgba(168, 85, 247, 0.5),
                    0 6px 18px rgba(168, 85, 247, 0.3),
                    inset 0 1px 0 rgba(168, 85, 247, 0.3);
            }
        }

        .ticket-item.purple:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow:
                0 16px 40px rgba(168, 85, 247, 0.6),
                0 8px 24px rgba(168, 85, 247, 0.4),
                inset 0 1px 0 rgba(168, 85, 247, 0.4);
        }

        /* Ticket 30 - Gold */
        .ticket-item.gold {
            background: linear-gradient(
                145deg,
                rgba(255, 215, 0, 0.2) 0%,
                rgba(255, 165, 0, 0.1) 50%,
                #1a1a1a 100%
            );
            box-shadow:
                0 8px 24px rgba(255, 215, 0, 0.4),
                0 4px 12px rgba(255, 215, 0, 0.3),
                inset 0 1px 0 rgba(255, 215, 0, 0.3);
            animation: pulseGold 3s ease-in-out infinite, cardBreathe 6s ease-in-out infinite;
        }

        @keyframes pulseGold {
            0%, 100% {
                box-shadow:
                    0 8px 24px rgba(255, 215, 0, 0.4),
                    0 4px 12px rgba(255, 215, 0, 0.3),
                    inset 0 1px 0 rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow:
                    0 12px 32px rgba(255, 215, 0, 0.6),
                    0 6px 18px rgba(255, 215, 0, 0.4),
                    inset 0 1px 0 rgba(255, 215, 0, 0.4);
            }
        }

        .ticket-item.gold:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow:
                0 16px 40px rgba(255, 215, 0, 0.7),
                0 8px 24px rgba(255, 215, 0, 0.5),
                inset 0 1px 0 rgba(255, 215, 0, 0.5);
        }

        .ticket-icon-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 64px;
            margin-bottom: 12px;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* –°–≤–µ—Ç—è—â–∏–π—Å—è –∫—Ä—É–≥ –∑–∞ –∏–∫–æ–Ω–∫–æ–π */
        .ticket-icon-wrapper::before {
            content: '';
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: radial-gradient(
                circle,
                rgba(255, 215, 0, 0.2) 0%,
                rgba(255, 215, 0, 0.1) 40%,
                transparent 70%
            );
            animation: iconGlow 2.5s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes iconGlow {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.8;
            }
        }

        .ticket-item:hover .ticket-icon-wrapper {
            transform: scale(1.15) translateY(-4px) rotate(5deg);
        }

        .ticket-item:hover .ticket-icon-wrapper::before {
            transform: scale(1.3);
            opacity: 1;
        }

        .ticket-icon {
            max-width: 80px;
            max-height: 64px;
            height: auto;
            width: auto;
            filter: drop-shadow(0 6px 20px rgba(255, 215, 0, 0.6));
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .ticket-item:hover .ticket-icon {
            filter: drop-shadow(0 10px 30px rgba(255, 215, 0, 0.9));
        }

        .ticket-amount {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(
                135deg,
                #FFD700 0%,
                #FFED4E 25%,
                #FFA500 50%,
                #FFCC00 75%,
                #FFD700 100%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 6px;
            line-height: 1;
            animation: amountShine 3s linear infinite;
            text-shadow: 0 4px 20px rgba(255, 215, 0, 0.5);
            position: relative;
            z-index: 2;
        }

        @keyframes amountShine {
            0% {
                background-position: 0% center;
            }
            100% {
                background-position: 200% center;
            }
        }

        .ticket-item:hover .ticket-amount {
            transform: scale(1.1);
        }

        .ticket-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }

        .ticket-discount {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
            letter-spacing: 0.5px;
        }

        .buy-btn {
            background: linear-gradient(
                135deg,
                #FFD700 0%,
                #FFED4E 25%,
                #FFA500 50%,
                #FFCC00 75%,
                #FFD700 100%
            );
            background-size: 200% auto;
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 16px;
            padding: 11px 16px;
            font-size: 14px;
            font-weight: 900;
            color: #000;
            cursor: pointer;
            box-shadow:
                0 8px 24px rgba(255, 215, 0, 0.6),
                0 4px 12px rgba(255, 215, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            z-index: 3;
            animation: btnShine 3s linear infinite, btnPulse 2s ease-in-out infinite;
            margin-top: 4px;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        @keyframes btnPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow:
                    0 8px 24px rgba(255, 215, 0, 0.6),
                    0 4px 12px rgba(255, 215, 0, 0.4),
                    inset 0 2px 0 rgba(255, 255, 255, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow:
                    0 10px 30px rgba(255, 215, 0, 0.8),
                    0 6px 16px rgba(255, 215, 0, 0.6),
                    inset 0 2px 0 rgba(255, 255, 255, 0.5);
            }
        }

        @keyframes btnShine {
            0% {
                background-position: 0% center;
            }
            100% {
                background-position: 200% center;
            }
        }

        .buy-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(
                45deg,
                rgba(255, 215, 0, 0.4),
                rgba(255, 237, 78, 0.6),
                rgba(255, 165, 0, 0.4),
                rgba(255, 204, 0, 0.6)
            );
            background-size: 400% 400%;
            border-radius: 16px;
            z-index: -1;
            animation: borderGlow 3s ease infinite;
            opacity: 0.7;
        }

        @keyframes borderGlow {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .buy-btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow:
                0 12px 36px rgba(255, 215, 0, 0.8),
                0 6px 18px rgba(255, 215, 0, 0.6),
                inset 0 2px 0 rgba(255, 255, 255, 0.5),
                inset 0 -2px 0 rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .buy-btn:hover::before {
            opacity: 1;
        }

        .buy-btn:active {
            transform: translateY(-1px) scale(0.99);
            box-shadow:
                0 6px 18px rgba(255, 215, 0, 0.5),
                0 3px 10px rgba(255, 215, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
        }


        .earn-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255, 215, 0, 0.15);
        }

        .earn-item:last-child {
            margin-bottom: 0;
        }

        .earn-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .earn-task {
            font-size: 15px;
            font-weight: 700;
            color: #FFF;
        }

        .earn-reward {
            font-size: 13px;
            color: #FFD700;
            font-weight: 600;
        }

        .earn-btn {
            background: linear-gradient(135deg, #11998E 0%, #38EF7D 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 700;
            color: #FFF;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(56, 239, 125, 0.3);
            transition: all 0.2s ease;
        }

        .earn-btn:active {
            transform: scale(0.95);
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="window.location.href='weekly-contest-new.html'">‚Üê</button>

        <div class="page-header">
            <div class="page-title">–ü–û–ö–£–ü–ö–ê –ë–ò–õ–ï–¢–û–í</div>
            <div class="page-subtitle">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ª–æ—Ç–µ—Ä–µ—è</div>
        </div>

        <!-- BALANCE -->
        <div class="balance-card">
            <div class="balance-left">
                <img src="icons/coins.png" class="balance-icon" alt="Balance">
                <div class="balance-info">
                    <div class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                    <div class="balance-value" id="user-balance">1,500</div>
                </div>
            </div>
        </div>

        <!-- TICKETS SECTION -->
        <div class="tickets-section">
            <!-- TOGGLE -->
            <div class="tickets-toggle">
                <button class="toggle-btn active" onclick="switchTab('buy')">–ö—É–ø–∏—Ç—å</button>
                <button class="toggle-btn" onclick="switchTab('earn')">–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å</button>
            </div>

            <!-- BUY TAB -->
            <div id="tab-buy" class="tab-content active">
                <div class="tickets-grid">
                    <div class="ticket-item green" onclick="buyTickets(1, 100)">
                        <div class="ticket-icon-wrapper">
                            <img src="icons/m.png" class="ticket-icon" alt="Ticket">
                        </div>
                        <div class="ticket-amount">1</div>
                        <div class="ticket-label">–±–∏–ª–µ—Ç</div>
                        <button class="buy-btn">100 AR</button>
                    </div>

                    <div class="ticket-item blue" onclick="buyTickets(3, 270)">
                        <div class="ticket-discount">-10%</div>
                        <div class="ticket-icon-wrapper">
                            <img src="icons/l.png" class="ticket-icon" alt="Ticket">
                        </div>
                        <div class="ticket-amount">3</div>
                        <div class="ticket-label">–±–∏–ª–µ—Ç–∞</div>
                        <button class="buy-btn">270 AR</button>
                    </div>

                    <div class="ticket-item purple" onclick="buyTickets(10, 800)">
                        <div class="ticket-discount">-20%</div>
                        <div class="ticket-icon-wrapper">
                            <img src="icons/xl.png" class="ticket-icon" alt="Ticket">
                        </div>
                        <div class="ticket-amount">10</div>
                        <div class="ticket-label">–±–∏–ª–µ—Ç–æ–≤</div>
                        <button class="buy-btn">800 AR</button>
                    </div>

                    <div class="ticket-item gold" onclick="buyTickets(30, 2100)">
                        <div class="ticket-discount">-30%</div>
                        <div class="ticket-icon-wrapper">
                            <img src="icons/xxl.png" class="ticket-icon" alt="Ticket">
                        </div>
                        <div class="ticket-amount">30</div>
                        <div class="ticket-label">–±–∏–ª–µ—Ç–æ–≤</div>
                        <button class="buy-btn">2,100 AR</button>
                    </div>
                </div>
            </div>

            <!-- EARN TAB -->
            <div id="tab-earn" class="tab-content">
                <div class="earn-item">
                    <div class="earn-left">
                        <div class="earn-task">–ë—Ä–æ–Ω–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å</div>
                        <div class="earn-reward">+1 –±–∏–ª–µ—Ç –∑–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞</div>
                    </div>
                    <button class="earn-btn" onclick="window.location.href='referral.html'">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                </div>

                <div class="earn-item">
                    <div class="earn-left">
                        <div class="earn-task">–°–µ—Ä–µ–±—Ä—è–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</div>
                        <div class="earn-reward">+2 –±–∏–ª–µ—Ç–∞ –∑–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞</div>
                    </div>
                    <button class="earn-btn" onclick="window.location.href='referral.html'">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                </div>

                <div class="earn-item">
                    <div class="earn-left">
                        <div class="earn-task">–ó–æ–ª–æ—Ç–æ–π —É—Ä–æ–≤–µ–Ω—å</div>
                        <div class="earn-reward">+3 –±–∏–ª–µ—Ç–∞ –∑–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞</div>
                    </div>
                    <button class="earn-btn" onclick="window.location.href='referral.html'">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Switch tabs
        function switchTab(tab) {
            // Update buttons
            const buttons = document.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.getElementById('tab-buy').classList.remove('active');
            document.getElementById('tab-earn').classList.remove('active');

            if (tab === 'buy') {
                document.getElementById('tab-buy').classList.add('active');
            } else {
                document.getElementById('tab-earn').classList.add('active');
            }
        }

        // Buy tickets function
        async function buyTickets(amount, price) {
            try {
                const user = window.currentUser;
                const db = window.supabaseClient || window.db;

                if (!user) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å');
                    return;
                }

                if (!db) {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    return;
                }

                // Check balance
                const currentBalance = user.balance_ar || 0;
                if (currentBalance < price) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.\n–¢—Ä–µ–±—É–µ—Ç—Å—è: ${price} AR\n–î–æ—Å—Ç—É–ø–Ω–æ: ${currentBalance} AR`);
                    return;
                }

                // –ü–æ–∫—É–ø–∫–∞ –ë–ï–ó –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è - –ø–æ 1 –∫–ª–∏–∫—É
                const ticketWord = amount === 1 ? '–±–∏–ª–µ—Ç' : amount < 5 ? '–±–∏–ª–µ—Ç–∞' : '–±–∏–ª–µ—Ç–æ–≤';
                console.log('üí≥ –ù–∞—á–∏–Ω–∞—é –ø–æ–∫—É–ø–∫—É –±–∏–ª–µ—Ç–æ–≤...', {amount, price, userId: user.id});

                // Call RPC function to buy tickets (bypasses RLS and handles all logic)
                const { data: result, error: rpcError } = await db
                    .rpc('buy_lottery_tickets', {
                        p_user_id: user.id,
                        p_amount: amount,
                        p_price: price
                    });

                if (rpcError) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ RPC —Ñ—É–Ω–∫—Ü–∏–∏:', rpcError);
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –±–∏–ª–µ—Ç–æ–≤:\n\n${rpcError.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑'}`);
                    return;
                }

                // Check result from RPC function
                const purchaseResult = Array.isArray(result) ? result[0] : result;

                if (!purchaseResult || !purchaseResult.success) {
                    const errorMsg = purchaseResult?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    console.error('‚ùå –ü–æ–∫—É–ø–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:', errorMsg);
                    alert(`–û—à–∏–±–∫–∞: ${errorMsg}`);
                    return;
                }

                console.log('‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞:', purchaseResult);

                // Update current user in memory with new values from RPC
                window.currentUser.balance_ar = purchaseResult.new_balance;
                window.currentUser.tickets = purchaseResult.new_tickets;

                // Trigger UI update event
                window.dispatchEvent(new Event('userUpdated'));

                // Reload balance display
                loadUserBalance();

                // Show success message
                alert(
                    `‚úÖ –£—Å–ø–µ—à–Ω–æ!\n\n` +
                    `–ö—É–ø–ª–µ–Ω–æ: ${amount} ${ticketWord}\n` +
                    `–°–ø–∏—Å–∞–Ω–æ: ${price.toLocaleString('ru-RU')} AR\n\n` +
                    `–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å AR: ${purchaseResult.new_balance.toLocaleString('ru-RU')}\n` +
                    `–í—Å–µ–≥–æ –±–∏–ª–µ—Ç–æ–≤: ${purchaseResult.new_tickets}`
                );

                console.log('üéâ –ü–æ–∫—É–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');

            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –±–∏–ª–µ—Ç–æ–≤:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –±–∏–ª–µ—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.');
            }
        }

        // Load user balance - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        let balanceCheckAttempts = 0;
        const MAX_ATTEMPTS = 20; // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º

        async function loadUserBalance() {
            try {
                balanceCheckAttempts++;

                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ currentUser —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ–ø—ã—Ç–æ–∫
                if (!window.currentUser && balanceCheckAttempts < MAX_ATTEMPTS) {
                    console.log(`‚è≥ –ü–æ–ø—ã—Ç–∫–∞ ${balanceCheckAttempts}/${MAX_ATTEMPTS}: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...`);
                    setTimeout(loadUserBalance, 500);
                    return;
                }

                if (!window.currentUser) {
                    console.error('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ—Å–ª–µ', MAX_ATTEMPTS, '–ø–æ–ø—ã—Ç–æ–∫');
                    document.getElementById('user-balance').textContent = '‚Äî';
                    return;
                }

                const user = window.currentUser;
                console.log('üë§ –ó–∞–≥—Ä—É–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', {
                    id: user.id,
                    telegram_id: user.telegram_id,
                    balance_ar: user.balance_ar,
                    first_name: user.first_name
                });

                if (user.balance_ar !== undefined) {
                    const balance = user.balance_ar || 0;
                    document.getElementById('user-balance').textContent = balance.toLocaleString('ru-RU');
                    console.log('‚úÖ –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω:', balance, 'AR');
                } else {
                    console.warn('‚ö†Ô∏è –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø–æ–ª—è balance_ar');
                    document.getElementById('user-balance').textContent = '0';
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
                document.getElementById('user-balance').textContent = '‚Äî';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.addEventListener('userUpdated', () => {
            console.log('üîÑ –°–æ–±—ã—Ç–∏–µ userUpdated - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é –±–∞–ª–∞–Ω—Å...');
            balanceCheckAttempts = 0; // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–ø—ã—Ç–æ–∫
            loadUserBalance();
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (DOMContentLoaded)');
            balanceCheckAttempts = 0;
            loadUserBalance();
        });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            console.log('üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (load)');
            if (!window.currentUser) {
                console.log('‚ö†Ô∏è currentUser –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞—é –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É...');
                balanceCheckAttempts = 0;
                loadUserBalance();
            }
        });
    </script>
</body>
</html>