<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR ARENA - –°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js?v=20250114"></script>
    <script src="auth.js?v=20250114"></script>
    <script src="admin-section-header.js"></script>
    <style id="section-header-styles"></style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            padding: 16px 12px 40px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.6), rgba(10, 10, 10, 0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 22px;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 24px;
        }

        /* FORM ELEMENTS */

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 12px;
            padding: 12px 14px;
            color: #fff;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border: 2px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        input[type="datetime-local"] {
            color-scheme: dark;
        }

        /* RADIO BUTTONS */

        .radio-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .radio-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.6);
        }

        .radio-btn.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            border-color: #FFD700;
        }

        /* PRIZES */

        .prize-list {
            margin-bottom: 12px;
        }

        .prize-item {
            display: grid;
            grid-template-columns: 60px 1fr 100px 36px;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .prize-place-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            color: #FFD700;
            font-weight: 700;
            text-align: center;
            font-size: 14px;
        }

        .prize-delete {
            width: 36px;
            height: 36px;
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #ff4444;
            transition: all 0.3s ease;
        }

        .prize-delete:hover {
            background: rgba(255, 0, 0, 0.4);
            transform: scale(1.1);
        }

        .add-prize-btn {
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-prize-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,215,0,0.5);
        }

        /* GRID LAYOUT */

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* CHECKBOX */

        .checkbox-wrapper {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #FFD700;
        }

        .checkbox-item label {
            flex: 1;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* VIP CONFIG (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */

        .vip-config {
            display: none;
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .vip-config.active {
            display: block;
        }

        /* BUTTONS */

        .submit-btn {
            width: 100%;
            height: 50px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 15px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .submit-btn:active {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* SUCCESS MESSAGE */

        .success-message {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border: 2px solid rgba(16, 185, 129, 0.5);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .success-message h3 {
            font-size: 20px;
            color: #10b981;
            margin-bottom: 8px;
        }

        .success-message p {
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <script>
        document.getElementById('section-header-styles').textContent = sectionHeaderStyles;
        document.body.insertAdjacentHTML('afterbegin', createSectionHeader('–°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à', 'admin-giveaways-list.html'));
    </script>

    <div class="container">
        <!-- SUCCESS MESSAGE -->
        <div class="success-message" id="success-message">
            <h3>‚úÖ –†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω!</h3>
            <p id="success-text"></p>
        </div>

        <!-- FORM -->
        <div class="card">
            <h2>–ù–æ–≤—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à V2</h2>

            <form id="giveawayForm" onsubmit="createGiveaway(event)">
                <!-- –¢–ò–ü –†–û–ó–´–ì–†–´–®–ê -->
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ä–æ–∑—ã–≥—Ä—ã—à–∞</label>
                    <div class="radio-group">
                        <div class="radio-btn active" onclick="selectType('tickets', this)">üéüÔ∏è –ë–∏–ª–µ—Ç—ã</div>
                        <div class="radio-btn" onclick="selectType('money', this)">üí∞ –î–µ–Ω—å–≥–∏</div>
                        <div class="radio-btn" onclick="selectType('course', this)">üéì –ö—É—Ä—Å</div>
                    </div>
                    <input type="hidden" id="giveawayType" name="type" value="tickets">
                </div>

                <!-- –ù–ê–ó–í–ê–ù–ò–ï -->
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="giveawayTitle" placeholder="–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π —Ä–æ–∑—ã–≥—Ä—ã—à 2025" required>
                </div>

                <!-- –û–ü–ò–°–ê–ù–ò–ï -->
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-textarea" id="giveawayDescription" placeholder="–ü—Ä–∏–º–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ –∏ –≤—ã–∏–≥—Ä–∞–π—Ç–µ –∫—Ä—É—Ç—ã–µ –ø—Ä–∏–∑—ã!" required></textarea>
                </div>

                <!-- –ü–†–ò–ó–´ -->
                <div class="form-group">
                    <label class="form-label">–ü—Ä–∏–∑—ã (–º–µ—Å—Ç–æ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Å—É–º–º–∞ AR)</label>
                    <div class="prize-list" id="prizeList">
                        <div class="prize-item">
                            <input type="number" class="prize-place-input" value="1" min="1" readonly>
                            <input type="text" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–∑–∞" value="iPhone 15 Pro" required>
                            <input type="number" class="form-input" placeholder="AR" value="10000" min="0" required>
                            <div class="prize-delete" onclick="deletePrize(this)">√ó</div>
                        </div>
                        <div class="prize-item">
                            <input type="number" class="prize-place-input" value="2" min="1" readonly>
                            <input type="text" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–∑–∞" value="AirPods Pro" required>
                            <input type="number" class="form-input" placeholder="AR" value="5000" min="0" required>
                            <div class="prize-delete" onclick="deletePrize(this)">√ó</div>
                        </div>
                    </div>
                    <button type="button" class="add-prize-btn" onclick="addPrize()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑</button>
                </div>

                <!-- –î–ê–¢–´ -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–ù–∞—á–∞–ª–æ</label>
                        <input type="datetime-local" class="form-input" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
                        <input type="datetime-local" class="form-input" id="endDate" required>
                    </div>
                </div>

                <!-- –õ–ò–ú–ò–¢–´ –ë–ò–õ–ï–¢–û–í -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–ú–∏–Ω–∏–º—É–º –±–∏–ª–µ—Ç–æ–≤</label>
                        <input type="number" class="form-input" id="minTickets" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ú–∞–∫—Å–∏–º—É–º –Ω–∞ —é–∑–µ—Ä–∞</label>
                        <input type="number" class="form-input" id="maxTickets" value="100" min="1" required>
                    </div>
                </div>

                <!-- VIP –û–ü–¶–ò–Ø -->
                <div class="checkbox-wrapper">
                    <div class="checkbox-item" onclick="toggleVIP()">
                        <input type="checkbox" id="vipEnabled">
                        <label for="vipEnabled">–í–∫–ª—é—á–∏—Ç—å VIP –æ–ø—Ü–∏—é</label>
                    </div>
                </div>

                <div class="vip-config" id="vipConfig">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ú–Ω–æ–∂–∏—Ç–µ–ª—å —à–∞–Ω—Å–æ–≤</label>
                            <input type="number" class="form-input" id="vipMultiplier" value="2.0" min="1" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¶–µ–Ω–∞ VIP (AR)</label>
                            <input type="number" class="form-input" id="vipPrice" value="500" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ VIP</label>
                        <input type="text" class="form-input" id="vipDescription" value="–£–¥–≤–æ–µ–Ω–∏–µ —à–∞–Ω—Å–æ–≤ –Ω–∞ –ø–æ–±–µ–¥—É">
                    </div>
                </div>

                <!-- SUBMIT -->
                <div class="form-group">
                    <button type="submit" class="submit-btn" id="submitBtn">–°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const now = new Date();
        const nowStr = now.toISOString().slice(0, 16);
        const weekLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        const weekLaterStr = weekLater.toISOString().slice(0, 16);

        document.getElementById('startDate').value = nowStr;
        document.getElementById('endDate').value = weekLaterStr;

        // ========================================
        // –í–´–ë–û–† –¢–ò–ü–ê
        // ========================================

        function selectType(type, element) {
            const buttons = document.querySelectorAll('.radio-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('giveawayType').value = type;
        }

        // ========================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ò–ó–ê–ú–ò
        // ========================================

        function addPrize() {
            const prizeList = document.getElementById('prizeList');
            const prizeCount = prizeList.querySelectorAll('.prize-item').length;

            const prizeItem = document.createElement('div');
            prizeItem.className = 'prize-item';
            prizeItem.innerHTML = `
                <input type="number" class="prize-place-input" value="${prizeCount + 1}" min="1" readonly>
                <input type="text" class="form-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–∑–∞" required>
                <input type="number" class="form-input" placeholder="AR" value="0" min="0" required>
                <div class="prize-delete" onclick="deletePrize(this)">√ó</div>
            `;
            prizeList.appendChild(prizeItem);

            updatePrizePlaces();
        }

        function deletePrize(element) {
            const prizeList = document.getElementById('prizeList');
            const prizeItems = prizeList.querySelectorAll('.prize-item');

            if (prizeItems.length > 1) {
                element.parentElement.remove();
                updatePrizePlaces();
            } else {
                alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏–∑');
            }
        }

        function updatePrizePlaces() {
            const prizeItems = document.querySelectorAll('.prize-item');
            prizeItems.forEach((item, index) => {
                const placeInput = item.querySelector('.prize-place-input');
                placeInput.value = index + 1;
            });
        }

        // ========================================
        // VIP TOGGLE
        // ========================================

        function toggleVIP() {
            const checkbox = document.getElementById('vipEnabled');
            const vipConfig = document.getElementById('vipConfig');

            setTimeout(() => {
                if (checkbox.checked) {
                    vipConfig.classList.add('active');
                } else {
                    vipConfig.classList.remove('active');
                }
            }, 0);
        }

        // ========================================
        // –°–û–ó–î–ê–ù–ò–ï –†–û–ó–´–ì–†–´–®–ê
        // ========================================

        async function createGiveaway(event) {
            event.preventDefault();

            try {
                const db = window.supabaseClient || window.db;
                const user = window.currentUser;

                if (!db) {
                    alert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
                    return;
                }

                if (!user) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å');
                    return;
                }

                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

                // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–∑—ã
                const prizeItems = document.querySelectorAll('.prize-item');
                const prizes = [];

                prizeItems.forEach((item, index) => {
                    const inputs = item.querySelectorAll('.form-input');
                    const description = inputs[0].value.trim();
                    const prizeAr = parseInt(inputs[1].value) || 0;

                    prizes.push({
                        place: index + 1,
                        description: description,
                        prize_ar: prizeAr
                    });
                });

                // VIP –∫–æ–Ω—Ñ–∏–≥
                let vipConfig = null;
                if (document.getElementById('vipEnabled').checked) {
                    vipConfig = {
                        enabled: true,
                        multiplier: parseFloat(document.getElementById('vipMultiplier').value),
                        price_ar: parseInt(document.getElementById('vipPrice').value),
                        description: document.getElementById('vipDescription').value.trim()
                    };
                }

                // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
                const giveawayData = {
                    title: document.getElementById('giveawayTitle').value.trim(),
                    description: document.getElementById('giveawayDescription').value.trim(),
                    type: document.getElementById('giveawayType').value,
                    status: 'active',
                    is_active: true,
                    start_date: document.getElementById('startDate').value,
                    end_date: document.getElementById('endDate').value,
                    prizes: prizes,
                    min_tickets: parseInt(document.getElementById('minTickets').value),
                    max_tickets_per_user: parseInt(document.getElementById('maxTickets').value),
                    vip_config: vipConfig,
                    created_by: user.id
                };

                console.log('–°–æ–∑–¥–∞—é —Ä–æ–∑—ã–≥—Ä—ã—à:', giveawayData);

                // –í—Å—Ç–∞–≤–∫–∞ –≤ –ë–î
                const { data, error } = await db
                    .from('giveaways')
                    .insert([giveawayData])
                    .select()
                    .single();

                if (error) throw error;

                console.log('‚úÖ –†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω:', data);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                document.getElementById('success-text').textContent = `–†–æ–∑—ã–≥—Ä—ã—à "${giveawayData.title}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! ID: ${data.id}`;
                document.getElementById('success-message').classList.add('show');

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('giveawayForm').reset();
                document.getElementById('startDate').value = nowStr;
                document.getElementById('endDate').value = weekLaterStr;
                document.getElementById('vipConfig').classList.remove('active');

                // –°–∫—Ä–æ–ª–ª –Ω–∞–≤–µ—Ä—Ö
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞
                setTimeout(() => {
                    window.location.href = `giveaway-detail.html?id=${data.id}`;
                }, 3000);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞:\n\n' + error.message);
            } finally {
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à';
            }
        }

        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ auth
        let authAttempts = 0;
        function waitForAuth() {
            if (window.currentUser || authAttempts > 20) {
                console.log('‚úÖ Auth ready');
            } else {
                authAttempts++;
                setTimeout(waitForAuth, 500);
            }
        }

        window.addEventListener('DOMContentLoaded', waitForAuth);
    </script>
</body>
</html>
