<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        .log {
            background: black;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #4CAF50;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        input {
            padding: 10px;
            margin: 10px 0;
            width: 300px;
            background: #333;
            color: white;
            border: 1px solid #555;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã AR ARENA</h1>

    <div class="test-section">
        <h2>1. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
        <div id="current-user">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="test-section">
        <h2>2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã URL</h2>
        <div id="url-params">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
    </div>

    <div class="test-section">
        <h2>3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î</h2>
        <input type="text" id="telegram-id" placeholder="Telegram ID –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏">
        <button onclick="checkUserInDB()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î</button>
        <div id="db-result"></div>
    </div>

    <div class="test-section">
        <h2>4. –°–∏–º—É–ª—è—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <input type="text" id="new-user-id" placeholder="Telegram ID –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="text" id="referrer-id" placeholder="Telegram ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞">
        <button onclick="simulateNewUser()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>
    </div>

    <div class="test-section">
        <h2>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞</h2>
        <input type="text" id="check-balance-id" placeholder="Telegram ID">
        <button onclick="checkBalance()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        <div id="balance-result"></div>
    </div>

    <div class="test-section">
        <h2>6. –õ–æ–≥–∏</h2>
        <div class="log" id="logs"></div>
    </div>

    <script>
        const log = (msg, type = 'info') => {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            logsDiv.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram?.WebApp;
            const user = tg?.initDataUnsafe?.user;

            if (user) {
                document.getElementById('current-user').innerHTML = `
                    <div class="success">‚úÖ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</div>
                    ID: ${user.id}<br>
                    –ò–º—è: ${user.first_name} ${user.last_name || ''}<br>
                    Username: @${user.username || '–Ω–µ—Ç'}
                `;
                log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.first_name} (${user.id})`, 'success');
            } else {
                document.getElementById('current-user').innerHTML =
                    '<div class="warning">‚ö†Ô∏è –ù–µ –≤ Telegram (–±—Ä–∞—É–∑–µ—Ä)</div>';
                log('–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ', 'warning');
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');

            if (ref) {
                document.getElementById('url-params').innerHTML =
                    `<div class="success">‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–∞–π–¥–µ–Ω: ref=${ref}</div>`;
                log(`–ù–∞–π–¥–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä ref=${ref}`, 'success');
            } else {
                document.getElementById('url-params').innerHTML =
                    '<div class="error">‚ùå –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>';
                log('–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞', 'error');
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        async function checkUserInDB() {
            const telegramId = document.getElementById('telegram-id').value;
            if (!telegramId) {
                log('–í–≤–µ–¥–∏—Ç–µ Telegram ID', 'error');
                return;
            }

            log(`–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId} –≤ –ë–î...`);

            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('telegram_id', telegramId);

                if (error) throw error;

                if (data && data.length > 0) {
                    const user = data[0];
                    document.getElementById('db-result').innerHTML = `
                        <div class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:</div>
                        <pre>${JSON.stringify(user, null, 2)}</pre>
                    `;
                    log(`–ù–∞–π–¥–µ–Ω: ${user.first_name}, –±–∞–ª–∞–Ω—Å: ${user.balance_ar} AR`, 'success');
                } else {
                    document.getElementById('db-result').innerHTML =
                        '<div class="warning">‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –Ω–∞–π–¥–µ–Ω (–Ω–æ–≤—ã–π)</div>';
                    log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'warning');
                }
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ë–î: ${error.message}`, 'error');
            }
        }

        // –°–∏–º—É–ª—è—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function simulateNewUser() {
            const newUserId = document.getElementById('new-user-id').value;
            const referrerId = document.getElementById('referrer-id').value;

            if (!newUserId) {
                log('–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            log('–°–∏–º—É–ª–∏—Ä—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π
                const { data: existingUser } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('telegram_id', newUserId);

                if (existingUser && existingUser.length > 0) {
                    log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${newUserId} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!`, 'error');
                    return;
                }

                // –ò—â–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
                let referrerDbId = null;
                if (referrerId) {
                    const { data: referrerData } = await supabaseClient
                        .from('users')
                        .select('id, balance_ar')
                        .eq('telegram_id', referrerId);

                    if (referrerData && referrerData.length > 0) {
                        referrerDbId = referrerData[0].id;
                        log(`–†–µ—Ñ–µ—Ä–µ—Ä –Ω–∞–π–¥–µ–Ω: ID=${referrerDbId}`, 'success');
                    } else {
                        log(`–†–µ—Ñ–µ—Ä–µ—Ä ${referrerId} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'warning');
                    }
                }

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data: newUser, error: insertError } = await supabaseClient
                    .from('users')
                    .insert({
                        telegram_id: newUserId,
                        username: `test_user_${newUserId}`,
                        first_name: `–¢–µ—Å—Ç–æ–≤—ã–π`,
                        last_name: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å`,
                        balance_ar: 50,
                        balance_coins: 0,
                        referrer_id: referrerDbId,
                        created_at: new Date().toISOString(),
                        last_seen_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (insertError) throw insertError;

                log(`‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω! ID: ${newUser.id}, –ë–∞–ª–∞–Ω—Å: 50 AR`, 'success');

                // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–µ—Ä—É
                if (referrerDbId) {
                    const { data: referrer } = await supabaseClient
                        .from('users')
                        .select('balance_ar')
                        .eq('id', referrerDbId)
                        .single();

                    const newBalance = (referrer.balance_ar || 0) + 100;

                    await supabaseClient
                        .from('users')
                        .update({ balance_ar: newBalance })
                        .eq('id', referrerDbId);

                    log(`‚úÖ –†–µ—Ñ–µ—Ä–µ—Ä—É –Ω–∞—á–∏—Å–ª–µ–Ω–æ 100 AR! –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${newBalance}`, 'success');
                }

            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        async function checkBalance() {
            const telegramId = document.getElementById('check-balance-id').value;
            if (!telegramId) {
                log('–í–≤–µ–¥–∏—Ç–µ Telegram ID', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('telegram_id, first_name, balance_ar, balance_coins')
                    .eq('telegram_id', telegramId)
                    .single();

                if (error) throw error;

                document.getElementById('balance-result').innerHTML = `
                    <div class="success">
                        <strong>${data.first_name}</strong><br>
                        üí∞ AR: ${data.balance_ar}<br>
                        ü™ô Coins: ${data.balance_coins}
                    </div>
                `;
                log(`–ë–∞–ª–∞–Ω—Å ${data.first_name}: ${data.balance_ar} AR`, 'success');

            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>