<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .info-box {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>Тест авторизации AR ARENA</h1>

    <div class="info-box">
        <h3>Статус Telegram WebApp:</h3>
        <div id="telegram-status">Проверка...</div>
    </div>

    <div class="info-box">
        <h3>Данные пользователя:</h3>
        <div id="user-info">Загрузка...</div>
    </div>

    <div class="info-box">
        <h3>Обработка данных:</h3>
        <div id="processing">Ожидание...</div>
    </div>

    <script>
        // Проверяем Telegram WebApp
        setTimeout(() => {
            const statusEl = document.getElementById('telegram-status');
            const userEl = document.getElementById('user-info');
            const procEl = document.getElementById('processing');

            if (window.Telegram && window.Telegram.WebApp) {
                statusEl.innerHTML = '<span class="success">✅ Telegram WebApp доступен</span>';

                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    userEl.innerHTML = `
                        <span class="success">✅ Данные получены:</span><br>
                        ID: ${user.id}<br>
                        Имя: <strong>${user.first_name} ${user.last_name || ''}</strong><br>
                        Username: @${user.username || 'не указан'}<br>
                        Premium: ${user.is_premium ? 'Да' : 'Нет'}
                    `;

                    // Сохраняем в localStorage для теста
                    localStorage.setItem('telegram_user', JSON.stringify(user));
                    localStorage.setItem('user_name', user.first_name + ' ' + (user.last_name || ''));

                    procEl.innerHTML = '<span class="success">✅ Данные сохранены в localStorage</span>';

                    // Обновляем имя на главной странице через storage event
                    window.dispatchEvent(new Event('storage'));

                } else {
                    userEl.innerHTML = '<span class="error">❌ Данные пользователя не найдены</span>';
                    procEl.innerHTML = '<span class="warning">⚠️ Работа в тестовом режиме</span>';
                }
            } else {
                statusEl.innerHTML = '<span class="error">❌ Telegram WebApp не доступен (браузер)</span>';
                userEl.innerHTML = '<span class="warning">⚠️ Тестовый режим</span>';
            }
        }, 100);
    </script>
</body>
</html>