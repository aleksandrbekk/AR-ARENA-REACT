<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
            font-size: 12px;
        }
        .section {
            background: #000;
            border: 1px solid #0f0;
            padding: 15px;
            margin: 10px 0;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffff00; }
        button {
            background: #0f0;
            color: black;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´</h1>

    <div class="section">
        <h3>1. TELEGRAM WEBAPPP</h3>
        <div id="telegram-status"></div>
    </div>

    <div class="section">
        <h3>2. START_PARAM</h3>
        <div id="start-param"></div>
    </div>

    <div class="section">
        <h3>3. –¢–ï–ö–£–©–ò–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨</h3>
        <div id="current-user"></div>
    </div>

    <div class="section">
        <h3>4. SUPABASE –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï</h3>
        <div id="supabase-status"></div>
        <button onclick="testSupabase()">–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î</button>
    </div>

    <div class="section">
        <h3>5. –¢–ï–°–¢ –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´</h3>
        <button onclick="simulateReferral()">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Ä–µ—Ñ —Å—Å—ã–ª–∫–µ</button>
        <div id="referral-test"></div>
    </div>

    <div class="section">
        <h3>6. –ü–†–û–í–ï–†–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –ë–î</h3>
        <input type="text" id="check-telegram-id" placeholder="Telegram ID">
        <button onclick="checkUser()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <div id="user-check"></div>
    </div>

    <div class="section">
        <h3>7. –õ–û–ì–ò</h3>
        <div id="logs"></div>
    </div>

    <script>
        const log = (msg, type = 'info') => {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            logsDiv.innerHTML += `<div class="${color}">[${time}] ${msg}</div>`;
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
        const checkTelegram = () => {
            const statusDiv = document.getElementById('telegram-status');
            const tg = window.Telegram?.WebApp;

            if (!tg) {
                statusDiv.innerHTML = '<span class="error">‚ùå Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω</span>';
                log('Telegram WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            statusDiv.innerHTML = `
                <span class="success">‚úÖ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω</span><br>
                <pre>Version: ${tg.version}
Platform: ${tg.platform}
InitData: ${tg.initData ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}
User: ${JSON.stringify(tg.initDataUnsafe?.user, null, 2)}</pre>
            `;
            log('Telegram WebApp –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º start_param
        const checkStartParam = () => {
            const paramDiv = document.getElementById('start-param');
            const tg = window.Telegram?.WebApp;

            let startParam = tg?.initDataUnsafe?.start_param;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è
            const methods = {
                'initDataUnsafe.start_param': tg?.initDataUnsafe?.start_param,
                'URL hash tgWebAppStartParam': new URLSearchParams(window.location.hash.substring(1)).get('tgWebAppStartParam'),
                'URL search start_param': new URLSearchParams(window.location.search).get('start_param'),
            };

            // –ü–∞—Ä—Å–∏–º initData
            if (tg?.initData) {
                const params = new URLSearchParams(tg.initData);
                methods['Parsed from initData'] = params.get('start_param');
            }

            let html = '';
            for (const [method, value] of Object.entries(methods)) {
                const status = value ? '‚úÖ' : '‚ùå';
                html += `${status} ${method}: <span class="${value ? 'success' : 'error'}">${value || '–ù–ï–¢'}</span><br>`;
            }

            paramDiv.innerHTML = html;

            if (startParam) {
                log(`start_param –Ω–∞–π–¥–µ–Ω: ${startParam}`, 'success');
                if (startParam.startsWith('ref_')) {
                    const refId = startParam.replace('ref_', '');
                    log(`–†–µ—Ñ–µ—Ä–µ—Ä ID: ${refId}`, 'success');
                }
            } else {
                log('start_param –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
            }
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const checkCurrentUser = () => {
            const userDiv = document.getElementById('current-user');
            const tg = window.Telegram?.WebApp;
            const user = tg?.initDataUnsafe?.user;

            if (user) {
                userDiv.innerHTML = `
                    <span class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω</span><br>
                    <pre>${JSON.stringify(user, null, 2)}</pre>
                `;
                log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.first_name} (ID: ${user.id})`, 'success');
            } else {
                userDiv.innerHTML = '<span class="error">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</span>';
                log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            }
        };

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Supabase
        const checkSupabaseStatus = () => {
            const statusDiv = document.getElementById('supabase-status');

            if (typeof supabaseClient === 'undefined') {
                statusDiv.innerHTML = '<span class="error">‚ùå Supabase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>';
                log('Supabase –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            } else {
                statusDiv.innerHTML = '<span class="success">‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω</span>';
                log('Supabase –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
            }
        };

        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        async function testSupabase() {
            log('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î...');

            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count')
                    .limit(1);

                if (error) {
                    log(`–û—à–∏–±–∫–∞ –ë–î: ${error.message}`, 'error');
                } else {
                    log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ!', 'success');
                }
            } catch (e) {
                log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        async function checkUser() {
            const telegramId = document.getElementById('check-telegram-id').value;
            if (!telegramId) {
                log('–í–≤–µ–¥–∏—Ç–µ Telegram ID', 'error');
                return;
            }

            log(`–ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}...`);

            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('telegram_id', telegramId);

                const resultDiv = document.getElementById('user-check');

                if (error) {
                    resultDiv.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${error.message}</span>`;
                    log(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}`, 'error');
                } else if (data && data.length > 0) {
                    resultDiv.innerHTML = `
                        <span class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω</span>
                        <pre>${JSON.stringify(data[0], null, 2)}</pre>
                    `;
                    log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: –±–∞–ª–∞–Ω—Å ${data[0].balance_ar} AR`, 'success');
                } else {
                    resultDiv.innerHTML = '<span class="warning">‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î</span>';
                    log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'warning');
                }
            } catch (e) {
                log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
            }
        }

        // –°–∏–º—É–ª—è—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
        function simulateReferral() {
            const testRefId = '190202791';
            log(`–°–∏–º—É–ª–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ ref_${testRefId}`);

            // –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–π start_param
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.initDataUnsafe.start_param = `ref_${testRefId}`;
                log('start_param —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');

                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
                checkStartParam();
            } else {
                log('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', () => {
            checkTelegram();
            checkStartParam();
            checkCurrentUser();
            checkSupabaseStatus();
            log('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞', 'info');
        });
    </script>
</body>
</html>