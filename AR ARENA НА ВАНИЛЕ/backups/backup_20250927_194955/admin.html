<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR ARENA - Админ панель</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
        }

        /* Хедер */
        .header {
            background: linear-gradient(to bottom, rgba(15, 15, 15, 0.98), rgba(10, 10, 10, 0.98));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 14px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        /* Контейнер */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Хлебные крошки */
        .breadcrumbs {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .breadcrumbs a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .breadcrumbs a:hover {
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
        }

        .breadcrumbs span {
            color: rgba(255, 255, 255, 0.3);
        }

        /* Кнопка-стрелка назад */
        .arrow-back {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            transition: all 0.2s;
        }

        .arrow-back:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
            color: #FFD700;
            transform: translateX(-2px);
        }

        /* Навигационная строка */
        .nav-line {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .nav-breadcrumb a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav-breadcrumb a:hover {
            color: #FFD700;
        }

        /* Сетка карточек */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 180px);
            gap: 20px;
            margin-top: 40px;
            justify-content: center;
        }

        /* Карточка */
        .card {
            width: 180px;
            height: 180px;
            background: rgba(25, 25, 35, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(40, 40, 50, 1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.5s;
        }

        .card:hover::before {
            transform: scale(1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .card-icon {
            width: 64px;
            height: 64px;
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }

        .card-icon img {
            width: 64px;
            height: 64px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #FFD700;
            position: relative;
            z-index: 1;
            text-align: center;
            margin: 10px 0;
        }

        .card-description {
            display: none;
        }

        .card-stats {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .card-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }

        .card-stat-label {
            display: none;
        }

        /* Страницы разделов */
        .section-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Статистика */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 8px;
            padding: 10px;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-box-value {
            font-size: 22px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 4px;
            line-height: 1;
        }

        .stat-box-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Таблицы */
        .table-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .table-container h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #FFD700;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .compact-table {
            max-height: 260px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(255, 215, 0, 0.06);
            color: #FFD700;
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.15);
        }

        td {
            padding: 6px 8px;
            color: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 12px;
            height: 30px;
            text-align: left;
        }

        tr:hover {
            background: rgba(255, 215, 0, 0.03);
        }

        /* Аватарки для пользователей */
        .user-avatar-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .avatar-placeholder-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .referrer-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .avatar-placeholder-mini {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        /* Кнопки управления балансом */
        .balance-controls {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .balance-btn {
            width: 22px;
            height: 22px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .balance-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
        }

        /* Кнопки действий */
        .action-btn {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .action-btn.danger {
            border-color: rgba(255, 100, 100, 0.3);
            color: #ff6464;
        }

        .action-btn.danger:hover {
            background: rgba(255, 100, 100, 0.1);
        }

        /* Разделение между кнопками */
        td button + button {
            margin-left: 5px;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(20, 20, 28, 0.98), rgba(15, 15, 20, 0.98));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #FFD700;
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #FFD700;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .modal-body {
            margin: 20px 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            font-size: 12px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-footer button {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-footer button:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .modal-footer button.danger {
            background: rgba(255, 100, 100, 0.1);
            border-color: rgba(255, 100, 100, 0.3);
            color: #ff6464;
        }

        .modal-footer button.danger:hover {
            background: rgba(255, 100, 100, 0.2);
        }

        /* Кнопки */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Загрузка */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top-color: #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        .notification.error {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Адаптивность */
        @media (max-width: 1024px) {
            .cards-grid {
                grid-template-columns: repeat(3, 180px);
            }
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(2, 180px);
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .admin-info {
                flex-direction: column;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Хедер -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <img src="/icons/admin.png" alt="Admin" style="width: 28px; height: 28px;">
                <div style="font-size: 16px; font-weight: 600; color: rgba(255, 255, 255, 0.9); margin-left: 10px;">
                    Админ панель
                </div>
            </div>
        </div>
    </div>


    <!-- Контейнер -->
    <div class="container">
        <!-- Главная страница с карточками -->
        <div id="mainPage" class="section-content active">
            <!-- Стильная навигация -->
            <div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 25px;">
                <a href="index.html" style="display: flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 12px 16px; color: rgba(255, 255, 255, 0.8); text-decoration: none; font-size: 13px; transition: all 0.2s; font-weight: 500; hover: background: rgba(255, 255, 255, 0.05);" title="Вернуться в AR ARENA">
                    <span style="font-size: 16px; color: #FFD700;">←</span>
                    <span>AR ARENA</span>
                </a>
            </div>

            <div class="cards-grid">
                <!-- Дашборд -->
                <div class="card" onclick="openSection('dashboard')">
                    <div class="card-icon">
                        <img src="/icons/dashboard.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Дашборд</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="dashboardStat">0</div>
                    </div>
                </div>

                <!-- Рефералы -->
                <div class="card" onclick="openSection('referrals')">
                    <div class="card-icon">
                        <img src="/icons/referral-tree.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Рефералы</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="referralsStat">0</div>
                    </div>
                </div>

                <!-- Задания -->
                <div class="card" onclick="openSection('tasks')">
                    <div class="card-icon">
                        <img src="/icons/tasks.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Задания</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="tasksStat">0</div>
                    </div>
                </div>

                <!-- Магазин -->
                <div class="card" onclick="openSection('shop')">
                    <div class="card-icon">
                        <img src="/icons/shop-cart.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Магазин</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="shopStat">0</div>
                    </div>
                </div>

                <!-- Сундуки -->
                <div class="card" onclick="openSection('chests')">
                    <div class="card-icon">
                        <img src="/icons/chest.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Сундуки</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="chestsStat">0</div>
                    </div>
                </div>

                <!-- Розыгрыши -->
                <div class="card" onclick="openSection('giveaways')">
                    <div class="card-icon">
                        <img src="/icons/lottery.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Розыгрыши</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="giveawaysStat">0</div>
                    </div>
                </div>

                <!-- Финансы -->
                <div class="card" onclick="openSection('finance')">
                    <div class="card-icon">
                        <img src="/icons/coins.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Финансы</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="financeStat">0</div>
                    </div>
                </div>

                <!-- Настройки -->
                <div class="card" onclick="openSection('settings')">
                    <div class="card-icon">
                        <img src="/icons/settings-gear.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Настройки</div>
                    <div class="card-stats">
                        <div class="card-stat-value">10</div>
                    </div>
                </div>

                <!-- Аналитика -->
                <div class="card" onclick="openSection('analytics')">
                    <div class="card-icon">
                        <img src="/icons/analytics-chart.png" width="64" height="64" alt="">
                    </div>
                    <div class="card-title">Аналитика</div>
                    <div class="card-stats">
                        <div class="card-stat-value" id="analyticsStat">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Раздел: Дашборд -->
        <div id="dashboard" class="section-content">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px;">
                <a href="#" onclick="goHome()" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: rgba(255, 255, 255, 0.6); text-decoration: none; transition: all 0.2s;">
                    <span style="font-size: 18px;">←</span>
                </a>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                    <a href="#" onclick="goHome()" style="color: rgba(255, 255, 255, 0.6); text-decoration: none; transition: color 0.2s;">Главная</a>
                    <span style="color: rgba(255, 255, 255, 0.3);">/</span>
                    <span style="color: #FFD700; font-weight: 500;">Дашборд</span>
                </div>
            </div>

            <!-- Статистика пользователей - 4 плашки -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px;" id="totalUsers">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">Всего</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px;">
                    <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px;" id="onlineNow">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">Онлайн</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s;" onclick="showNewUsersCalendar()">
                    <div style="font-size: 24px; font-weight: 700; color: #4CAF50; margin-bottom: 4px;" id="newToday">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">Новых</div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s;" onclick="showChurnedUsersCalendar()">
                    <div style="font-size: 24px; font-weight: 700; color: #FF5722; margin-bottom: 4px;" id="churnedToday">0</div>
                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px;">Отвалились</div>
                </div>
            </div>


            <!-- Таблица пользователей -->
            <div class="table-container">
                <h3 style="font-size: 14px; margin-bottom: 15px; color: rgba(255, 255, 255, 0.8); font-weight: 500; padding-left: 5px;">Управление пользователями</h3>
                <div id="usersList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Раздел: Рефералы -->
        <div id="referrals" class="section-content">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px;">
                <a href="#" onclick="goHome()" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: rgba(255, 255, 255, 0.6); text-decoration: none; transition: all 0.2s;">
                    <span style="font-size: 18px;">←</span>
                </a>
                <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                    <a href="#" onclick="goHome()" style="color: rgba(255, 255, 255, 0.6); text-decoration: none; transition: color 0.2s;">Главная</a>
                    <span style="color: rgba(255, 255, 255, 0.3);">/</span>
                    <span style="color: #FFD700; font-weight: 500;">Рефералы</span>
                </div>
            </div>
            <h2 style="font-size: 20px; margin-bottom: 20px; color: #FFD700; font-weight: 600;">Реферальная система</h2>

            <!-- Статистика рефералов -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                <div class="stat-box">
                    <div class="stat-box-value" id="totalReferrals">0</div>
                    <div class="stat-box-label">Всего рефералов</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="todayReferrals">0</div>
                    <div class="stat-box-label">За сегодня</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="orphanUsers">0</div>
                    <div class="stat-box-label">Без реферера</div>
                </div>
            </div>

            <!-- Кнопки управления -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; max-width: 400px;">
                <button onclick="showChangeReferrer()" style="
                    padding: 12px 20px;
                    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    color: #FFD700;
                    border-radius: 10px;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.1);
                    white-space: nowrap;
                ">
                    Сменить
                </button>
                <button onclick="showTop100Modal()" style="
                    padding: 12px 20px;
                    background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
                    border: 1px solid rgba(52, 152, 219, 0.3);
                    color: #3498db;
                    border-radius: 10px;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
                    white-space: nowrap;
                ">
                    ТОП 100
                </button>
            </div>

            <!-- Все пользователи с управлением рефералами -->
            <div class="table-container">
                <h3>Пользователи</h3>
                <div id="referralUsersTable">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно смены реферера -->
        <div id="changeReferrerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Сменить реферала</h3>
                    <button class="modal-close" onclick="closeChangeReferrerModal()">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>ID пользователя (Telegram ID):</label>
                        <input type="text" id="changeUserId" placeholder="Введите ID пользователя">
                    </div>
                    <div class="form-group">
                        <label>ID нового реферера (Telegram ID):</label>
                        <input type="text" id="changeNewReferrer" placeholder="Введите ID нового реферера">
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="executeChangeReferrer()" style="background: rgba(255, 215, 0, 0.2);">Сменить</button>
                    <button class="danger" onclick="closeChangeReferrerModal()">Отмена</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно смены реферера для одного пользователя -->
        <div id="singleReferrerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Изменить реферера</h3>
                    <button class="modal-close" onclick="closeSingleReferrerModal()">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>ID пользователя:</label>
                        <input type="text" id="singleUserId" readonly style="opacity: 0.7;">
                    </div>
                    <div class="form-group">
                        <label>Текущий реферер:</label>
                        <input type="text" id="currentSingleReferrer" readonly style="opacity: 0.7;">
                    </div>
                    <div class="form-group">
                        <label>Новый реферер (Telegram ID):</label>
                        <input type="text" id="newSingleReferrer" placeholder="Введите Telegram ID">
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="clearSingleReferrer()">Очистить реферера</button>
                    <button onclick="updateSingleReferrer()">Установить</button>
                    <button class="danger" onclick="closeSingleReferrerModal()">Отмена</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно ТОП 100 -->
        <div id="top100Modal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3>ТОП 100 рефереров</h3>
                    <button class="modal-close" onclick="closeTop100Modal()">×</button>
                </div>
                <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="top100Content">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tasks" class="section-content">
            <div class="breadcrumbs">
                <a href="#" onclick="goHome()">Главная</a>
                <span>></span>
                <span>Задания</span>
            </div>
            <a href="#" class="btn-back" onclick="goHome()">← Назад</a>
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #FFD700;">Управление заданиями</h2>
            <p style="color: rgba(255, 255, 255, 0.6);">Раздел в разработке</p>
        </div>

        <div id="shop" class="section-content">
            <div class="breadcrumbs">
                <a href="#" onclick="goHome()">Главная</a>
                <span>></span>
                <span>Магазин</span>
            </div>
            <a href="#" class="btn-back" onclick="goHome()">← Назад</a>
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #FFD700;">Магазин</h2>
            <p style="color: rgba(255, 255, 255, 0.6);">Раздел в разработке</p>
        </div>

        <div id="chests" class="section-content">
            <div class="breadcrumbs">
                <a href="#" onclick="goHome()">Главная</a>
                <span>></span>
                <span>Сундуки</span>
            </div>
            <a href="#" class="btn-back" onclick="goHome()">← Назад</a>
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #FFD700;">Управление сундуками</h2>
            <p style="color: rgba(255, 255, 255, 0.6);">Раздел в разработке</p>
        </div>

        <div id="giveaways" class="section-content">
            <div class="breadcrumbs">
                <a href="#" onclick="goHome()">Главная</a>
                <span>></span>
                <span>Розыгрыши</span>
            </div>
            <a href="#" class="btn-back" onclick="goHome()">← Назад</a>
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #FFD700;">Управление розыгрышами</h2>
            <p style="color: rgba(255, 255, 255, 0.6);">Раздел в разработке</p>
        </div>

        <div id="finance" class="section-content">
            <div class="breadcrumbs">
                <a href="#" onclick="goHome()">Главная</a>
                <span>></span>
                <span>Финансы</span>
            </div>
            <a href="#" class="btn-back" onclick="goHome()">← Назад</a>
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #FFD700;">Финансы</h2>
            <p style="color: rgba(255, 255, 255, 0.6);">Раздел в разработке</p>
        </div>

        <div id="settings" class="section-content">
            <div class="breadcrumbs">
                <a href="#" onclick="goHome()">Главная</a>
                <span>></span>
                <span>Настройки</span>
            </div>
            <a href="#" class="btn-back" onclick="goHome()">← Назад</a>
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #FFD700;">Настройки системы</h2>
            <p style="color: rgba(255, 255, 255, 0.6);">Раздел в разработке</p>
        </div>

        <div id="analytics" class="section-content">
            <div class="breadcrumbs">
                <a href="#" onclick="goHome()">Главная</a>
                <span>></span>
                <span>Аналитика</span>
            </div>
            <a href="#" class="btn-back" onclick="goHome()">← Назад</a>
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #FFD700;">Аналитика</h2>
            <p style="color: rgba(255, 255, 255, 0.6);">Раздел в разработке</p>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Конфигурация
        const SUPABASE_URL = 'https://syxjkircmiwpnpagznay.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5eGpraXJjbWl3cG5wYWd6bmF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NjQ0MTEsImV4cCI6MjA3MzM0MDQxMX0.XUJWPrPOtsG_cynjfH38mJR2lJYThGTgEVMMu3MIw8g';
        const ADMIN_IDS = [190202791];

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;

        // Инициализация
        async function init() {
            // Временно отключаем проверку для тестирования
            // if (await checkAdmin()) {
                window.Telegram?.WebApp?.ready();
                window.Telegram?.WebApp?.expand();
                await loadMainStats();
            // }
        }

        // Проверка администратора
        async function checkAdmin() {
            const initData = window.Telegram?.WebApp?.initData;
            if (!initData) {
                showNotification('Ошибка: Откройте через Telegram', 'error');
                return false;
            }

            const urlParams = new URLSearchParams(initData);
            const userParam = urlParams.get('user');
            if (!userParam) {
                showNotification('Ошибка: Нет данных пользователя', 'error');
                return false;
            }

            const user = JSON.parse(decodeURIComponent(userParam));
            // Временно отключаем проверку админа для тестирования
            // if (!ADMIN_IDS.includes(user.id)) {
            //     document.body.innerHTML = '<div style="color: white; text-align: center; padding: 50px; font-size: 20px;">❌ Доступ запрещен</div>';
            //     return false;
            // }

            currentUser = user || { first_name: 'Admin', id: 'admin' };
            // Убрали отображение информации об админе
            return true;
        }

        // Загрузка статистики для карточек
        async function loadMainStats() {
            try {
                // Общее количество пользователей
                const { count: totalUsers } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                const usersStatEl = document.getElementById('usersStat');
                if (usersStatEl) usersStatEl.textContent = totalUsers || 0;

                // Активные сегодня
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const { count: activeToday } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('last_active', today.toISOString());
                const dashboardStatEl = document.getElementById('dashboardStat');
                if (dashboardStatEl) dashboardStatEl.textContent = activeToday || 0;

                // Количество рефералов
                const { count: referrals } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .not('referred_by', 'is', null);
                const referralsStatEl = document.getElementById('referralsStat');
                if (referralsStatEl) referralsStatEl.textContent = referrals || 0;

                // Общее количество монет
                const { data: coinsData } = await supabase
                    .from('users')
                    .select('balance_ar');
                const totalCoins = coinsData?.reduce((sum, user) => sum + (user.balance_ar || 0), 0) || 0;
                const financeStatEl = document.getElementById('financeStat');
                if (financeStatEl) financeStatEl.textContent = totalCoins.toLocaleString();

            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Загрузка данных дашборда
        // Текущий период для отвалившихся
        let currentPeriod = '3days';
        let chartInstance = null;

        async function loadDashboard() {
            try {
                // Загружаем всех пользователей
                const { data: allUsers } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // 1. Всего пользователей
                const totalUsersEl = document.getElementById('totalUsers');
                if (totalUsersEl) totalUsersEl.textContent = allUsers?.length || 0;

                // 2. Онлайн сейчас (последние 5 минут)
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const onlineNow = allUsers?.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    return lastActive && new Date(lastActive) >= fiveMinutesAgo;
                }).length || 0;
                const onlineNowEl = document.getElementById('onlineNow');
                if (onlineNowEl) onlineNowEl.textContent = onlineNow;

                // 3. Новых сегодня
                const newToday = allUsers?.filter(u => new Date(u.created_at) >= today).length || 0;
                const newTodayEl = document.getElementById('newToday');
                if (newTodayEl) newTodayEl.textContent = newToday;

                // 4. Отвалились сегодня (стали неактивными 3+ дня)
                const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
                const churnedToday = allUsers?.filter(u => {
                    const lastActive = new Date(u.last_seen_at || u.last_active || u.created_at);
                    const churnDate = new Date(lastActive.getTime() + 3 * 24 * 60 * 60 * 1000);
                    return churnDate >= today && churnDate < new Date(today.getTime() + 24 * 60 * 60 * 1000);
                }).length || 0;
                const churnedTodayEl = document.getElementById('churnedToday');
                if (churnedTodayEl) churnedTodayEl.textContent = churnedToday;

                // 4. Конверсия
                const usersWithTasks = allUsers?.filter(u => u.balance_ar > 50).length || 0;
                const conversionRate = allUsers?.length > 0 ?
                    Math.round((usersWithTasks / allUsers.length) * 100) : 0;
                const conversionRateEl = document.getElementById('conversionRate');
                if (conversionRateEl) conversionRateEl.textContent = conversionRate + '%';

                // 5. Отвалились (по умолчанию 3+ дня)
                updateChurnedUsers(allUsers, currentPeriod);

                // 6. Без заданий сегодня
                const noTasksToday = allUsers?.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    return lastActive && new Date(lastActive) >= today && u.balance_ar <= 50;
                }).length || 0;
                const noTasksTodayEl = document.getElementById('noTasksToday');
                if (noTasksTodayEl) noTasksTodayEl.textContent = noTasksToday;

                // 7. Вчера активны
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayEnd = new Date(today);
                const yesterdayActive = allUsers?.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    if (!lastActive) return false;
                    const activeDate = new Date(lastActive);
                    return activeDate >= yesterday && activeDate < yesterdayEnd;
                }).length || 0;
                const yesterdayEl = document.getElementById('yesterdayActive');
                if (yesterdayEl) yesterdayEl.textContent = yesterdayActive;

                // 8. Средний баланс
                const avgBalance = allUsers?.length > 0 ?
                    Math.round(allUsers.reduce((sum, u) => sum + (u.balance_ar || 0), 0) / allUsers.length) : 0;
                const avgBalanceEl = document.getElementById('avgBalance');
                if (avgBalanceEl) avgBalanceEl.textContent = avgBalance;

                // Сохраняем пользователей глобально для переключения периодов
                window.dashboardUsers = allUsers;

                // Загружаем пользователей в таблицу после небольшой задержки для гарантии что DOM готов
                setTimeout(async () => {
                    await loadUsers();
                }, 100);

                // Последние регистрации
                const { data: recentUsers } = await supabase
                    .from('users')
                    .select('telegram_id, username, first_name, created_at, referred_by')
                    .order('created_at', { ascending: false })
                    .limit(10);

                const recentHtml = recentUsers?.length ?
                    `<table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Время</th>
                                <th>Реферер</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentUsers.map(user => `
                                <tr>
                                    <td>${user.telegram_id}</td>
                                    <td>${user.first_name || user.username || 'Нет имени'}</td>
                                    <td>${new Date(user.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</td>
                                    <td>${user.referred_by || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` :
                    '<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px;">Нет новых регистраций</p>';

                document.getElementById('recentRegistrations').innerHTML = recentHtml;

                // Проблемные пользователи
                const { data: problemUsers } = await supabase
                    .from('users')
                    .select('telegram_id, username, first_name, last_login, tasks_completed')
                    .or(`last_login.lt.${threeDaysAgo.toISOString()},tasks_completed.eq.0`)
                    .limit(10);

                const problemHtml = problemUsers?.length ?
                    `<table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Последний вход</th>
                                <th>Заданий</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${problemUsers.map(user => `
                                <tr>
                                    <td>${user.telegram_id}</td>
                                    <td>${user.first_name || user.username || 'Нет имени'}</td>
                                    <td>${user.last_login ? new Date(user.last_login).toLocaleDateString('ru-RU') : 'Никогда'}</td>
                                    <td>${user.tasks_completed || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` :
                    '<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px;">Нет проблемных пользователей</p>';

                document.getElementById('problemUsers').innerHTML = problemHtml;

            } catch (error) {
                console.error('Ошибка загрузки дашборда:', error);
            }
        }

        // Функция генерации цвета аватара (как в index.html)
        function getAvatarColor(id) {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57',
                '#DDA0DD', '#98D8C8', '#FFD700', '#FF69B4', '#00CED1',
                '#FF7F50', '#6A5ACD', '#20B2AA', '#F4A460', '#FF6347'
            ];
            const numId = parseInt(id) || 0;
            return colors[numId % colors.length];
        }

        // Функция создания HTML аватара
        function createAvatar(user, size = 'normal') {
            const sizeClass = size === 'mini' ? 'avatar-placeholder-mini' : 'avatar-placeholder-small';
            const avatarClass = size === 'mini' ? 'referrer-avatar' : 'user-avatar';

            // Для текущего пользователя (админа) берем фото из Telegram напрямую
            const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
            if (tgUser && tgUser.id == user.telegram_id && tgUser.photo_url) {
                return `<img src="${tgUser.photo_url}" class="${avatarClass}" alt="">`;
            }

            // Для остальных используем photo_url из базы данных
            if (user.photo_url) {
                return `<img src="${user.photo_url}" class="${avatarClass}" alt="">`;
            } else {
                // Если фото нет - показываем цветной круг с буквой
                const initial = (user.first_name || user.username || 'U').charAt(0).toUpperCase();
                const color = getAvatarColor(user.telegram_id);
                return `<div class="${sizeClass}" style="background: ${color}">${initial}</div>`;
            }
        }

        // Загрузка пользователей
        async function loadUsers() {
            try {
                console.log('Начинаем загрузку пользователей...');

                // Загружаем всех пользователей - точно так же как в loadReferrals
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                console.log('Пользователи загружены:', users?.length || 0);

                // Генерируем таблицу с управлением балансом
                const html = users?.length ?
                    `<table style="font-size: 11px; width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th style="text-align: left; padding: 10px;">Пользователь</th>
                                <th style="text-align: center; padding: 10px;">ID</th>
                                <th style="text-align: center; padding: 10px;">Баланс</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 8px 10px;">
                                        <div class="user-avatar-wrapper" style="display: flex; align-items: center; gap: 10px;">
                                            ${createAvatar(user)}
                                            <div>
                                                <div style="color: rgba(255, 255, 255, 0.9);">${user.first_name || 'Без имени'}</div>
                                                ${user.username ? `<div style="font-size: 9px; color: rgba(255,255,255,0.5);">@${user.username}</div>` : ''}
                                            </div>
                                        </div>
                                    </td>
                                    <td style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 10px;">${user.telegram_id}</td>
                                    <td style="text-align: center;">
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            <button onclick="changeBalance('${user.telegram_id}', -10)" style="background: rgba(255,69,58,0.2); border: 1px solid rgba(255,69,58,0.3); color: #FF453A; padding: 3px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: bold;" title="Убрать 10 AR">-10</button>
                                            <span style="font-weight: bold; color: #FFD700; min-width: 50px;">${user.balance_ar || 0} AR</span>
                                            <button onclick="changeBalance('${user.telegram_id}', 10)" style="background: rgba(52,199,89,0.2); border: 1px solid rgba(52,199,89,0.3); color: #34C759; padding: 3px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: bold;" title="Добавить 10 AR">+10</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` :
                    '<p style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px; padding: 20px;">Нет пользователей</p>';

                // Обновляем элемент
                const usersListEl = document.getElementById('usersList');
                if (usersListEl) {
                    usersListEl.innerHTML = html;
                    console.log('Таблица пользователей обновлена');
                } else {
                    console.error('Элемент usersList не найден!');
                }

            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                const usersListEl = document.getElementById('usersList');
                if (usersListEl) {
                    usersListEl.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Ошибка загрузки пользователей</p>';
                }
            }
        }

        // Глобальные функции для управления пользователями
        window.changeBalance = async function(userId, amount) {
            try {
                const { data: user } = await supabase
                    .from('users')
                    .select('balance_ar')
                    .eq('telegram_id', userId)
                    .single();

                const newBalance = (user.balance_ar || 0) + amount;

                if (newBalance < 0) {
                    showNotification('Баланс не может быть отрицательным', 'error');
                    return;
                }

                await supabase
                    .from('users')
                    .update({ balance_ar: newBalance })
                    .eq('telegram_id', userId);

                loadUsers(); // Перезагружаем список
                showNotification(`Баланс обновлен: ${amount > 0 ? '+' : ''}${amount} AR`);
            } catch (error) {
                console.error('Ошибка изменения баланса:', error);
                showNotification('Ошибка изменения баланса', 'error');
            }
        }

        // Функция управления балансом (упрощенная)
        // changeBalance уже определена выше и используется кнопками +50/-50

        // Открытие раздела
        window.openSection = async function(section) {
            // Скрываем все разделы
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.remove('active');
            });

            // Показываем выбранный раздел
            document.getElementById(section).classList.add('active');

            // Загружаем данные для раздела
            if (section === 'dashboard') {
                await loadDashboard();
            }
        };

        // Возврат на главную
        window.goHome = function() {
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('mainPage').classList.add('active');
            loadMainStats();
        };

        // Выход
        window.logout = function() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                window.Telegram?.WebApp?.close();
            }
        };

        // Уведомления
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Функция обновления отвалившихся пользователей
        function updateChurnedUsers(users, period = '3days') {
            let daysAgo;
            let label;

            switch(period) {
                case '3days':
                    daysAgo = 3;
                    label = 'Отвалились 3+ дней';
                    break;
                case '7days':
                    daysAgo = 7;
                    label = 'Отвалились 7+ дней';
                    break;
                case '30days':
                    daysAgo = 30;
                    label = 'Отвалились 30+ дней';
                    break;
                default:
                    daysAgo = 3;
                    label = 'Отвалились 3+ дней';
            }

            const cutoffDate = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
            const churnedCount = users?.filter(u => {
                const lastActive = u.last_seen_at || u.last_active || u.last_login || u.created_at;
                return new Date(lastActive) < cutoffDate;
            }).length || 0;

            const displayEl = document.getElementById('churnedUsersDisplay');
            const labelEl = document.getElementById('churnedLabel');

            if (displayEl) displayEl.textContent = churnedCount;
            if (labelEl) labelEl.textContent = label;
        }

        // Функция переключения периода
        window.changePeriod = function(period) {
            currentPeriod = period;

            // Обновляем стили кнопок
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.style.background = 'rgba(255, 255, 255, 0.03)';
                btn.style.border = '1px solid rgba(255, 255, 255, 0.08)';
                btn.style.color = 'rgba(255, 255, 255, 0.7)';
            });

            const activeBtn = document.getElementById('period-' + period);
            if (activeBtn) {
                activeBtn.style.background = 'rgba(255, 215, 0, 0.15)';
                activeBtn.style.border = '1px solid rgba(255, 215, 0, 0.3)';
                activeBtn.style.color = '#FFD700';
            }

            // Обновляем данные
            if (window.dashboardUsers) {
                updateChurnedUsers(window.dashboardUsers, period);
            }
        };

        // Функция создания календаря активности
        function createActivityCalendar(users) {
            const today = new Date();
            const calendarPreview = document.querySelector('#calendarPreview > div');
            const calendarView = document.getElementById('activityCalendar');

            if (!calendarPreview || !calendarView) return;

            // Создаем данные для последних 30 дней
            const calendarData = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                const nextDay = new Date(date);
                nextDay.setDate(nextDay.getDate() + 1);

                const count = users?.filter(u => {
                    const created = new Date(u.created_at);
                    return created >= date && created < nextDay;
                }).length || 0;

                calendarData.push({
                    date: new Date(date),
                    count: count,
                    day: date.getDate(),
                    month: date.toLocaleDateString('ru-RU', { month: 'short' }),
                    weekday: date.toLocaleDateString('ru-RU', { weekday: 'short' })
                });
            }

            // Создаем мини-превью (последние 14 дней)
            calendarPreview.innerHTML = calendarData.slice(-14).map(d => {
                const intensity = d.count === 0 ? 0 : Math.min(1, d.count / 5);
                const color = d.count === 0
                    ? 'rgba(255, 255, 255, 0.03)'
                    : `rgba(255, 215, 0, ${0.2 + intensity * 0.8})`;

                return `
                    <div style="
                        width: 20px;
                        height: 20px;
                        background: ${color};
                        border: 1px solid rgba(255, 255, 255, 0.08);
                        border-radius: 4px;
                        cursor: pointer;
                        position: relative;
                    " title="${d.day} ${d.month}: ${d.count} новых">
                    </div>
                `;
            }).join('');

            // Создаем полный календарь
            const weeks = [];
            let currentWeek = [];

            // Добавляем пустые ячейки в начале
            const firstDay = calendarData[0].date.getDay();
            const startPadding = firstDay === 0 ? 6 : firstDay - 1;
            for (let i = 0; i < startPadding; i++) {
                currentWeek.push(null);
            }

            // Заполняем календарь
            calendarData.forEach(d => {
                if (currentWeek.length === 7) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentWeek.push(d);
            });

            // Добавляем последнюю неделю
            if (currentWeek.length > 0) {
                while (currentWeek.length < 7) {
                    currentWeek.push(null);
                }
                weeks.push(currentWeek);
            }

            calendarView.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                        ${['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map(day => `
                            <div style="
                                text-align: center;
                                font-size: 10px;
                                color: rgba(255, 255, 255, 0.4);
                                padding: 4px;
                            ">${day}</div>
                        `).join('')}
                    </div>
                    ${weeks.map(week => `
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px;">
                            ${week.map(day => {
                                if (!day) return '<div></div>';

                                const intensity = day.count === 0 ? 0 : Math.min(1, day.count / 5);
                                const color = day.count === 0
                                    ? 'rgba(255, 255, 255, 0.03)'
                                    : `rgba(255, 215, 0, ${0.2 + intensity * 0.8})`;

                                const isToday = day.date.toDateString() === today.toDateString();

                                return `
                                    <div style="
                                        aspect-ratio: 1;
                                        background: ${color};
                                        border: 1px solid ${isToday ? '#FFD700' : 'rgba(255, 255, 255, 0.08)'};
                                        border-radius: 6px;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        justify-content: center;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        position: relative;
                                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                        <div style="font-size: 11px; color: ${day.count > 0 ? '#000' : 'rgba(255, 255, 255, 0.6)'}; font-weight: 600;">
                                            ${day.day}
                                        </div>
                                        ${day.count > 0 ? `
                                            <div style="font-size: 9px; color: ${intensity > 0.5 ? '#000' : '#FFD700'}; margin-top: 2px;">
                                                +${day.count}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                    <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">Меньше</span>
                    <div style="display: flex; gap: 4px;">
                        ${[0, 0.2, 0.4, 0.6, 0.8, 1].map(intensity => `
                            <div style="
                                width: 14px;
                                height: 14px;
                                background: ${intensity === 0 ? 'rgba(255, 255, 255, 0.03)' : `rgba(255, 215, 0, ${0.2 + intensity * 0.8})`};
                                border: 1px solid rgba(255, 255, 255, 0.08);
                                border-radius: 3px;
                            "></div>
                        `).join('')}
                    </div>
                    <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">Больше</span>
                </div>
            `;
        }

        // Функция переключения календаря
        window.toggleCalendar = function() {
            const calendarView = document.getElementById('calendarView');
            const calendarPreview = document.getElementById('calendarPreview');
            const toggleBtn = document.getElementById('calendarToggle');

            if (calendarView.style.display === 'none') {
                calendarView.style.display = 'block';
                calendarPreview.style.display = 'none';
                toggleBtn.textContent = 'Свернуть ▲';
            } else {
                calendarView.style.display = 'none';
                calendarPreview.style.display = 'block';
                toggleBtn.textContent = 'Развернуть ▼';
            }
        };

        // Простой график на Canvas без Chart.js
        function drawSimpleChart(canvas, data) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Очищаем canvas
            ctx.clearRect(0, 0, width, height);

            // Находим максимальное значение
            const maxValue = Math.max(...data.map(d => d.count), 1);

            // Рисуем линии сетки
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (height - 20) * (1 - i / 4) + 10;
                ctx.beginPath();
                ctx.moveTo(30, y);
                ctx.lineTo(width - 10, y);
                ctx.stroke();
            }

            // Рисуем график
            if (data.length > 0) {
                const stepX = (width - 40) / (data.length - 1);

                // Рисуем линию
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.beginPath();

                data.forEach((point, index) => {
                    const x = 30 + index * stepX;
                    const y = (height - 20) * (1 - point.count / maxValue) + 10;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();

                // Рисуем точки
                data.forEach((point, index) => {
                    const x = 30 + index * stepX;
                    const y = (height - 20) * (1 - point.count / maxValue) + 10;

                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();

                    // Подписи
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(point.date, x, height - 2);
                });
            }
        }

        // Функции для раздела Рефералы
        async function loadReferrals() {
            try {
                // Загружаем всех пользователей
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                // Создаем маппинг id -> пользователь для быстрого поиска
                const userById = {};
                users.forEach(u => userById[u.id] = u);

                // Статистика - referred_by это ID пользователя, а не telegram_id
                const totalReferrals = users.filter(u => u.referred_by || u.referrer_id).length;
                const activeReferrals = users.filter(u => (u.referred_by || u.referrer_id) &&
                    (u.last_seen_at || u.last_active) &&
                    new Date(u.last_seen_at || u.last_active) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;
                const orphans = users.filter(u => !u.referred_by && !u.referrer_id).length;

                // Подсчет рефералов для каждого пользователя - используем ID пользователя
                const referralCounts = {};
                users.forEach(user => {
                    const referrerId = user.referred_by || user.referrer_id;
                    if (referrerId) {
                        // Находим реферера по ID и используем его telegram_id для группировки
                        const referrer = userById[referrerId];
                        if (referrer) {
                            referralCounts[referrer.telegram_id] = (referralCounts[referrer.telegram_id] || 0) + 1;
                        }
                    }
                });

                // Топ реферер
                let topReferrer = { id: '-', count: 0 };
                for (const [id, count] of Object.entries(referralCounts)) {
                    if (count > topReferrer.count) {
                        topReferrer = { id, count };
                    }
                }

                // Среднее количество рефералов
                const referrers = Object.keys(referralCounts).length;
                const avgReferrals = referrers > 0 ? Math.round(totalReferrals / referrers) : 0;

                // Обновляем только существующие элементы статистики
                const totalReferralsEl = document.getElementById('totalReferrals');
                if (totalReferralsEl) totalReferralsEl.textContent = totalReferrals;

                const todayReferralsEl = document.getElementById('todayReferrals');
                if (todayReferralsEl) {
                    // Считаем рефералов за сегодня
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayRefs = users.filter(u => {
                        const hasRef = u.referred_by || u.referrer_id;
                        const createdAt = new Date(u.created_at);
                        return hasRef && createdAt >= today;
                    }).length;
                    todayReferralsEl.textContent = todayRefs;
                }

                const orphanUsersEl = document.getElementById('orphanUsers');
                if (orphanUsersEl) orphanUsersEl.textContent = orphans;

                // Создаем таблицу всех пользователей с управлением рефералами
                let usersTableHtml = `
                    <table style="font-size: 11px;">
                        <thead>
                            <tr>
                                <th style="width: 200px; text-align: left; padding-left: 10px;">Пользователь</th>
                                <th style="width: 80px; text-align: center;">ID</th>
                                <th style="width: 120px; text-align: center;">Пригласил</th>
                                <th style="width: 100px; text-align: center;">Рефералов</th>
                                <th style="width: 100px; text-align: center;">Баланс</th>
                                <th style="width: 100px; text-align: center;">Регистрация</th>
                                <th style="width: 100px; text-align: center;">Действия</th>
                            </tr>
                        </thead>
                        <tbody>`;

                for (const user of users) {
                    // Находим реферера по ID
                    const referrerId = user.referred_by || user.referrer_id;
                    const referrer = referrerId ? userById[referrerId] : null;
                    // Считаем рефералов
                    const refCount = users.filter(u => {
                        const refId = u.referred_by || u.referrer_id;
                        return refId && userById[refId] && userById[refId].telegram_id === user.telegram_id;
                    }).length;

                    usersTableHtml += `
                        <tr>
                            <td style="padding: 8px 10px;">
                                <div class="user-avatar-wrapper" style="display: flex; align-items: center; gap: 10px;">
                                    ${createAvatar(user)}
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.9);">${user.first_name || 'Без имени'}</div>
                                        ${user.username ? `<div style="font-size: 9px; color: rgba(255,255,255,0.5);">@${user.username}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 10px;">${user.telegram_id}</td>
                            <td style="text-align: center; color: rgba(255, 255, 255, 0.8);">
                                ${referrer ? referrer.first_name || referrer.telegram_id : 'Без реферера'}
                            </td>
                            <td style="text-align: center; font-weight: bold; color: #FFD700;">${refCount}</td>
                            <td style="text-align: center;">${user.balance_ar || 0} AR</td>
                            <td style="text-align: center; font-size: 10px;">${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
                            <td style="text-align: center;">
                                <button class="action-btn" onclick="showReferralTree('${user.telegram_id}')"
                                        style="background: none; border: none; padding: 5px; cursor: pointer; margin-right: 5px;"
                                        title="Дерево рефералов">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
                                        <path d="M12 2v6m0 0a3 3 0 1 0 0 6m0-6a3 3 0 1 1 0 6m0 0v2m0 0a3 3 0 1 0 0 6m0-6a3 3 0 1 1 0 6"></path>
                                        <path d="M9 8H3m6 8H3m18-8h-6m6 8h-6"></path>
                                    </svg>
                                </button>
                                <button class="action-btn" onclick="openSingleReferrerModal('${user.telegram_id}', '${user.referred_by || ''}')"
                                        style="background: none; border: none; padding: 5px; cursor: pointer;"
                                        title="Изменить реферера">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>`;
                }

                usersTableHtml += `
                        </tbody>
                    </table>`;

                document.getElementById('referralUsersTable').innerHTML = usersTableHtml;

            } catch (error) {
                console.error('Ошибка загрузки рефералов:', error);
                showNotification('Ошибка загрузки данных рефералов', 'error');
            }
        }

        // Вычисление максимальной глубины реферальной цепочки
        function calculateMaxReferralDepth(users) {
            let maxDepth = 0;
            const userMap = {};
            users.forEach(u => userMap[u.telegram_id] = u);

            function getDepth(userId, visited = new Set()) {
                if (visited.has(userId)) return 0;
                visited.add(userId);

                const referrals = users.filter(u => u.referred_by === userId);
                if (referrals.length === 0) return 0;

                let max = 0;
                for (const ref of referrals) {
                    const depth = 1 + getDepth(ref.telegram_id, visited);
                    if (depth > max) max = depth;
                }
                return max;
            }

            users.forEach(user => {
                if (!user.referred_by) {
                    const depth = getDepth(user.telegram_id);
                    if (depth > maxDepth) maxDepth = depth;
                }
            });

            return maxDepth;
        }

        // Массовая смена реферера
        window.showMassReferrerChange = function() {
            document.getElementById('massReferrerModal').classList.add('active');
        };

        window.closeMassReferrerModal = function() {
            document.getElementById('massReferrerModal').classList.remove('active');
        };

        window.checkMassReferrals = async function() {
            const fromId = document.getElementById('massFromReferrer').value.trim();
            if (!fromId) {
                showNotification('Введите ID реферера', 'error');
                return;
            }

            try {
                const { count } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('referred_by', fromId);

                document.getElementById('massReferralCount').textContent = count || 0;

                if (count === 0) {
                    showNotification('У этого пользователя нет рефералов', 'error');
                } else {
                    showNotification(`Найдено ${count} рефералов для переноса`);
                }
            } catch (error) {
                console.error('Ошибка проверки:', error);
                showNotification('Ошибка проверки рефералов', 'error');
            }
        };

        window.executeMassReferrerChange = async function() {
            const fromId = document.getElementById('massFromReferrer').value.trim();
            const toId = document.getElementById('massToReferrer').value.trim();

            if (!fromId || !toId) {
                showNotification('Заполните оба поля', 'error');
                return;
            }

            if (fromId === toId) {
                showNotification('ID должны отличаться', 'error');
                return;
            }

            if (!confirm(`Перенести всех рефералов от ${fromId} к ${toId}?`)) {
                return;
            }

            try {
                // Проверяем существование нового реферера
                const { data: newReferrer } = await supabase
                    .from('users')
                    .select('telegram_id')
                    .eq('telegram_id', toId)
                    .single();

                if (!newReferrer) {
                    showNotification('Новый реферер не найден', 'error');
                    return;
                }

                // Переносим рефералов
                const { error } = await supabase
                    .from('users')
                    .update({ referrer_id: toId })
                    .eq('referrer_id', fromId);

                if (error) throw error;

                showNotification('Рефералы успешно перенесены');
                closeMassReferrerModal();
                loadReferrals();
            } catch (error) {
                console.error('Ошибка переноса:', error);
                showNotification('Ошибка переноса рефералов', 'error');
            }
        };

        // Функция показа ТОП 100
        window.showTop100Modal = async function() {
            document.getElementById('top100Modal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                // Создаем маппинг для быстрого поиска
                const userById = {};
                users.forEach(u => userById[u.id] = u);

                // Подсчет рефералов по уровням для каждого пользователя
                const userStats = {};

                users.forEach(user => {
                    userStats[user.telegram_id] = {
                        user: user,
                        level1: 0,
                        level2: 0,
                        totalReferrals: 0
                    };
                });

                // Считаем рефералов первого уровня
                users.forEach(user => {
                    const referrerId = user.referred_by || user.referrer_id;
                    if (referrerId) {
                        const referrer = userById[referrerId];
                        if (referrer && userStats[referrer.telegram_id]) {
                            userStats[referrer.telegram_id].level1++;
                            userStats[referrer.telegram_id].totalReferrals++;
                        }
                    }
                });

                // Считаем рефералов второго уровня
                users.forEach(user => {
                    const referrerId = user.referred_by || user.referrer_id;
                    if (referrerId) {
                        const referrer = userById[referrerId];
                        if (referrer) {
                            // Находим рефералов этого пользователя
                            const userReferrals = users.filter(u => {
                                const refId = u.referred_by || u.referrer_id;
                                return refId === user.id;
                            });

                            // Для каждого реферала первого уровня добавляем ко второму уровню реферера
                            userReferrals.forEach(() => {
                                const grandReferrerId = referrer.telegram_id;
                                if (userStats[grandReferrerId]) {
                                    userStats[grandReferrerId].level2++;
                                    userStats[grandReferrerId].totalReferrals++;
                                }
                            });
                        }
                    }
                });

                // Сортируем по правилам: 1 уровень, потом 2 уровень, потом по алфавиту
                const sortedUsers = Object.values(userStats)
                    .filter(stat => stat.totalReferrals > 0)
                    .sort((a, b) => {
                        if (a.level1 !== b.level1) {
                            return b.level1 - a.level1;
                        }
                        if (a.level2 !== b.level2) {
                            return b.level2 - a.level2;
                        }
                        // По алфавиту
                        const nameA = a.user.first_name || a.user.telegram_id;
                        const nameB = b.user.first_name || b.user.telegram_id;
                        return nameA.localeCompare(nameB);
                    })
                    .slice(0, 100);

                // Создаем HTML таблицу
                let tableHtml = `
                    <table style="width: 100%; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="width: 50px; text-align: center;">Место</th>
                                <th style="width: 250px; text-align: left; padding-left: 10px;">Пользователь</th>
                                <th style="width: 100px; text-align: center;">ID</th>
                                <th style="width: 120px; text-align: center;">Рефералы 1 ур.</th>
                                <th style="width: 120px; text-align: center;">Рефералы 2 ур.</th>
                                <th style="width: 100px; text-align: center;">Всего</th>
                            </tr>
                        </thead>
                        <tbody>`;

                sortedUsers.forEach((stat, index) => {
                    const placeStyle = index < 3 ? 'color: #FFD700; font-weight: bold; font-size: 16px;' : '';
                    const placeIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}`;

                    tableHtml += `
                        <tr>
                            <td style="text-align: center; ${placeStyle}">${placeIcon}</td>
                            <td style="padding: 8px 10px;">
                                <div class="user-avatar-wrapper" style="display: flex; align-items: center; gap: 10px;">
                                    ${createAvatar(stat.user)}
                                    <div>
                                        <div style="color: rgba(255, 255, 255, 0.9);">${stat.user.first_name || 'Без имени'}</div>
                                        ${stat.user.username ? `<div style="font-size: 9px; color: rgba(255,255,255,0.5);">@${stat.user.username}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: center; color: rgba(255, 255, 255, 0.6); font-size: 10px;">${stat.user.telegram_id}</td>
                            <td style="text-align: center; font-weight: bold; color: #2ecc71;">${stat.level1}</td>
                            <td style="text-align: center; font-weight: bold; color: #3498db;">${stat.level2}</td>
                            <td style="text-align: center; font-weight: bold; color: #FFD700;">${stat.totalReferrals}</td>
                        </tr>`;
                });

                tableHtml += `
                        </tbody>
                    </table>`;

                document.getElementById('top100Content').innerHTML = tableHtml;

            } catch (error) {
                console.error('Ошибка загрузки ТОП 100:', error);
                document.getElementById('top100Content').innerHTML = '<p style="color: red;">Ошибка загрузки данных</p>';
            }
        };

        window.closeTop100Modal = function() {
            document.getElementById('top100Modal').classList.remove('active');
        };

        // Функция открытия модального окна смены реферера
        window.showChangeReferrer = function() {
            document.getElementById('changeReferrerModal').classList.add('active');
        };

        window.closeChangeReferrerModal = function() {
            document.getElementById('changeReferrerModal').classList.remove('active');
            document.getElementById('changeUserId').value = '';
            document.getElementById('changeNewReferrer').value = '';
        };

        // Функция выполнения смены реферера
        window.executeChangeReferrer = async function() {
            const userId = document.getElementById('changeUserId').value.trim();
            const newReferrerId = document.getElementById('changeNewReferrer').value.trim();

            if (!userId) {
                showNotification('Введите ID пользователя', 'error');
                return;
            }

            try {
                // Находим пользователя по telegram_id
                const { data: user } = await supabase
                    .from('users')
                    .select('*')
                    .eq('telegram_id', userId)
                    .single();

                if (!user) {
                    showNotification('Пользователь не найден', 'error');
                    return;
                }

                // Если указан новый реферер, находим его
                let newReferrerDbId = null;
                if (newReferrerId) {
                    const { data: referrer } = await supabase
                        .from('users')
                        .select('*')
                        .eq('telegram_id', newReferrerId)
                        .single();

                    if (!referrer) {
                        showNotification('Реферер не найден', 'error');
                        return;
                    }
                    newReferrerDbId = referrer.id;
                }

                // Обновляем реферера
                const { error } = await supabase
                    .from('users')
                    .update({ referrer_id: newReferrerDbId })
                    .eq('telegram_id', userId);

                if (error) throw error;

                showNotification('Реферер успешно изменен', 'success');
                closeChangeReferrerModal();
                await loadReferrals(); // Обновляем данные

            } catch (error) {
                console.error('Ошибка смены реферера:', error);
                showNotification('Ошибка при смене реферера', 'error');
            }
        };

        // Функция показа дерева рефералов (общая, без указания конкретного пользователя)
        window.showReferralTree = async function(referrerId) {
            // Если referrerId не передан, показываем модальное окно для ввода ID
            if (!referrerId) {
                const userId = prompt('Введите Telegram ID пользователя для просмотра дерева рефералов:');
                if (!userId) return;
                referrerId = userId.trim();
            }
            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                const userById = {};
                users.forEach(u => userById[u.id] = u);

                // Находим основного пользователя
                const mainUser = users.find(u => u.telegram_id === referrerId);
                if (!mainUser) {
                    showNotification('Пользователь не найден', 'error');
                    return;
                }

                // Находим рефералов
                const referrals = users.filter(u => {
                    const refId = u.referred_by || u.referrer_id;
                    return refId && userById[refId] && userById[refId].telegram_id === referrerId;
                });

                // Показываем модальное окно с деревом
                let treeHtml = `
                    <div style="padding: 20px;">
                        <h4 style="color: #FFD700; margin-bottom: 20px;">Дерево рефералов: ${mainUser.first_name || mainUser.telegram_id}</h4>
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 10px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                ${createAvatar(mainUser)}
                                <div>
                                    <div style="font-weight: 600; color: #FFD700;">${mainUser.first_name || 'Без имени'}</div>
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.5);">ID: ${mainUser.telegram_id}</div>
                                </div>
                            </div>`;

                if (referrals.length > 0) {
                    treeHtml += '<div style="border-left: 2px solid rgba(255, 215, 0, 0.2); margin-left: 20px; padding-left: 20px;">';
                    referrals.forEach((ref, index) => {
                        const isLast = index === referrals.length - 1;
                        treeHtml += `
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                <div style="width: 20px; height: 2px; background: rgba(255, 215, 0, 0.2);"></div>
                                ${createAvatar(ref, 'mini')}
                                <div>
                                    <div style="font-size: 13px; font-weight: 500;">${ref.first_name || 'Без имени'}</div>
                                    <div style="font-size: 10px; color: rgba(255,255,255,0.5);">ID: ${ref.telegram_id} | ${ref.balance_ar || 0} AR</div>
                                </div>
                            </div>`;
                    });
                    treeHtml += '</div>';
                } else {
                    treeHtml += '<div style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 10px;">Нет рефералов</div>';
                }

                treeHtml += `
                        </div>
                    </div>`;

                // Показываем в модальном окне
                const modal = document.getElementById('treeModal');
                if (!modal) {
                    // Создаем модальное окно для дерева
                    const modalDiv = document.createElement('div');
                    modalDiv.id = 'treeModal';
                    modalDiv.className = 'modal active';
                    modalDiv.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Дерево рефералов</h3>
                                <button class="modal-close" onclick="document.getElementById('treeModal').classList.remove('active')">×</button>
                            </div>
                            <div class="modal-body" id="treeContent">
                                ${treeHtml}
                            </div>
                        </div>`;
                    document.body.appendChild(modalDiv);
                } else {
                    modal.classList.add('active');
                    document.getElementById('treeContent').innerHTML = treeHtml;
                }
            } catch (error) {
                console.error('Ошибка загрузки дерева:', error);
                showNotification('Ошибка загрузки дерева рефералов', 'error');
            }
        };

        window.transferAllReferrals = function(fromId) {
            document.getElementById('massFromReferrer').value = fromId;
            showMassReferrerChange();
        };

        // Функции для изменения реферера одного пользователя
        window.openSingleReferrerModal = async function(userId, currentReferrerDbId) {
            console.log('Открытие модалки редактирования:', { userId, currentReferrerDbId });

            const modalElement = document.getElementById('singleReferrerModal');
            if (!modalElement) {
                console.error('Модальное окно не найдено!');
                showNotification('Ошибка: модальное окно не найдено', 'error');
                return;
            }

            const userIdInput = document.getElementById('singleUserId');
            if (!userIdInput) {
                console.error('Поле singleUserId не найдено!');
                showNotification('Ошибка: поле ID не найдено', 'error');
                return;
            }

            userIdInput.value = userId;

            // Если есть текущий реферер, находим его telegram_id по id в БД
            if (currentReferrerDbId && currentReferrerDbId !== 'null' && currentReferrerDbId !== '') {
                try {
                    const { data: referrer, error } = await supabase
                        .from('users')
                        .select('telegram_id, first_name')
                        .eq('id', currentReferrerDbId)
                        .single();

                    console.log('Текущий реферер:', referrer, 'Ошибка:', error);

                    if (referrer && !error) {
                        document.getElementById('currentSingleReferrer').value =
                            `${referrer.first_name || 'ID'}: ${referrer.telegram_id}`;
                    } else {
                        document.getElementById('currentSingleReferrer').value = 'Нет реферера';
                    }
                } catch (error) {
                    console.error('Ошибка получения реферера:', error);
                    document.getElementById('currentSingleReferrer').value = 'Нет реферера';
                }
            } else {
                document.getElementById('currentSingleReferrer').value = 'Нет реферера';
            }

            document.getElementById('newSingleReferrer').value = '';
            modalElement.classList.add('active');
        };

        window.closeSingleReferrerModal = function() {
            document.getElementById('singleReferrerModal').classList.remove('active');
        };

        window.updateSingleReferrer = async function() {
            const userIdEl = document.getElementById('singleUserId');
            const newReferrerIdEl = document.getElementById('newSingleReferrer');

            if (!userIdEl || !newReferrerIdEl) {
                console.error('Не найдены поля ввода!', { userIdEl, newReferrerIdEl });
                showNotification('Ошибка: не найдены поля ввода', 'error');
                return;
            }

            const userId = userIdEl.value;
            const newReferrerId = newReferrerIdEl.value.trim();

            console.log('Обновление реферера:', { userId, newReferrerId });

            if (!userId) {
                showNotification('Ошибка: не указан ID пользователя', 'error');
                return;
            }

            if (!newReferrerId) {
                showNotification('Введите ID нового реферера', 'error');
                return;
            }

            if (userId === newReferrerId) {
                showNotification('Пользователь не может быть реферером сам себе', 'error');
                return;
            }

            try {
                // Находим нового реферера и получаем его id (не telegram_id!)
                const { data: referrer, error: refError } = await supabase
                    .from('users')
                    .select('id, telegram_id, first_name')
                    .eq('telegram_id', newReferrerId)
                    .single();

                console.log('Найден реферер:', referrer, 'Ошибка:', refError);

                if (refError || !referrer) {
                    showNotification(`Реферер с ID ${newReferrerId} не найден в базе`, 'error');
                    return;
                }

                // Находим пользователя, которому меняем реферера
                const { data: userToUpdate, error: userError } = await supabase
                    .from('users')
                    .select('id, telegram_id')
                    .eq('telegram_id', userId)
                    .single();

                console.log('Пользователь для обновления:', userToUpdate, 'Ошибка:', userError);

                if (userError || !userToUpdate) {
                    showNotification(`Пользователь с ID ${userId} не найден`, 'error');
                    return;
                }

                // Обновляем реферера - используем referrer.id, а не telegram_id!
                const { data: updateData, error } = await supabase
                    .from('users')
                    .update({ referrer_id: referrer.id })
                    .eq('id', userToUpdate.id)
                    .select();

                console.log('Результат обновления:', updateData, 'Ошибка:', error);

                if (error) throw error;

                showNotification(`✅ Реферер изменен на ${referrer.first_name || newReferrerId}`, 'success');
                closeSingleReferrerModal();

                // Перезагружаем таблицы в разделе рефералов
                if (document.getElementById('referrals').classList.contains('active')) {
                    await loadReferrals();
                }
            } catch (error) {
                console.error('Полная ошибка:', error);
                showNotification(`Ошибка: ${error.message || 'Неизвестная ошибка'}`, 'error');
            }
        };

        window.clearSingleReferrer = async function() {
            const userId = document.getElementById('singleUserId').value;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ referrer_id: null })
                    .eq('telegram_id', userId);

                if (error) throw error;

                showNotification('Реферер очищен');
                closeSingleReferrerModal();

                // Перезагружаем таблицы в разделе рефералов
                if (document.getElementById('referrals').classList.contains('active')) {
                    loadReferrals();
                }
            } catch (error) {
                console.error('Ошибка очистки реферера:', error);
                showNotification('Ошибка очистки реферера', 'error');
            }
        };

        // Обновляем функцию openSection
        const originalOpenSection = window.openSection;
        window.openSection = async function(section) {
            await originalOpenSection(section);

            if (section === 'referrals') {
                await loadReferrals();
            } else if (section === 'dashboard') {
                await loadDashboard();
            }
        };

        // Заглушка для редактирования
        window.editUser = function(id) {
            showNotification(`Редактирование пользователя ${id} будет доступно в следующем обновлении`);
        };

        // Функции для модальных окон статистики
        // Функции для календарей новых пользователей
        window.showNewUsersCalendar = async function() {
            document.getElementById('newUsersCalendarModal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Создаем календарь за 30 дней
                const today = new Date();
                const calendarData = [];
                let selectedDayUsers = [];

                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    const nextDay = new Date(date);
                    nextDay.setDate(nextDay.getDate() + 1);

                    const dayUsers = users?.filter(u => {
                        const created = new Date(u.created_at);
                        return created >= date && created < nextDay;
                    }) || [];

                    calendarData.push({
                        date: new Date(date),
                        count: dayUsers.length,
                        users: dayUsers,
                        day: date.getDate(),
                        month: date.toLocaleDateString('ru-RU', { month: 'short' }),
                        weekday: date.toLocaleDateString('ru-RU', { weekday: 'short' })
                    });
                }

                // Функция клика по дню
                window.selectNewUsersDay = function(dayIndex) {
                    selectedDayUsers = calendarData[dayIndex].users;
                    renderNewUsersList();
                };

                // Создаем календарную сетку
                const weeks = [];
                let currentWeek = [];

                const firstDay = calendarData[0].date.getDay();
                const startPadding = firstDay === 0 ? 6 : firstDay - 1;
                for (let i = 0; i < startPadding; i++) {
                    currentWeek.push(null);
                }

                calendarData.forEach((d, index) => {
                    if (currentWeek.length === 7) {
                        weeks.push(currentWeek);
                        currentWeek = [];
                    }
                    currentWeek.push({...d, index});
                });

                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) {
                        currentWeek.push(null);
                    }
                    weeks.push(currentWeek);
                }

                let html = `
                    <div style="padding: 20px;">
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: #4CAF50;">Календарь новых пользователей</h4>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 8px;">
                            ${['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map(day => `
                                <div style="text-align: center; font-size: 11px; color: rgba(255, 255, 255, 0.4); padding: 4px;">${day}</div>
                            `).join('')}
                        </div>
                        ${weeks.map(week => `
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 6px;">
                                ${week.map(day => {
                                    if (!day) return '<div></div>';

                                    const intensity = day.count === 0 ? 0 : Math.min(1, day.count / 5);
                                    const color = day.count === 0
                                        ? 'rgba(255, 255, 255, 0.03)'
                                        : `rgba(76, 175, 80, ${0.2 + intensity * 0.8})`;

                                    const isToday = day.date.toDateString() === today.toDateString();

                                    return `
                                        <div style="
                                            aspect-ratio: 1;
                                            background: ${color};
                                            border: 1px solid ${isToday ? '#4CAF50' : 'rgba(255, 255, 255, 0.08)'};
                                            border-radius: 8px;
                                            display: flex;
                                            flex-direction: column;
                                            align-items: center;
                                            justify-content: center;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            position: relative;
                                            padding: 4px;
                                        " title="${day.day} ${day.month}: ${day.count} новых"
                                          onclick="selectNewUsersDay(${day.index})"
                                          onmouseover="this.style.transform='scale(1.05)'"
                                          onmouseout="this.style.transform='scale(1)'">
                                            <div style="font-size: 12px; color: ${day.count > 0 ? '#000' : 'rgba(255, 255, 255, 0.6)'}; font-weight: 600;">
                                                ${day.day}
                                            </div>
                                            ${day.count > 0 ? `
                                                <div style="font-size: 10px; color: ${intensity > 0.5 ? '#000' : '#4CAF50'}; margin-top: 2px; font-weight: 700;">
                                                    +${day.count}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}

                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">Меньше</span>
                            <div style="display: flex; gap: 4px;">
                                ${[0, 0.2, 0.4, 0.6, 0.8, 1].map(intensity => `
                                    <div style="
                                        width: 16px;
                                        height: 16px;
                                        background: ${intensity === 0 ? 'rgba(255, 255, 255, 0.03)' : `rgba(76, 175, 80, ${0.2 + intensity * 0.8})`};
                                        border: 1px solid rgba(255, 255, 255, 0.08);
                                        border-radius: 3px;
                                    "></div>
                                `).join('')}
                            </div>
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">Больше</span>
                        </div>
                    </div>`;

                document.getElementById('newUsersCalendarContent').innerHTML = html;

                // Функция рендера списка пользователей
                window.renderNewUsersList = function() {
                    if (selectedDayUsers.length === 0) {
                        document.getElementById('newUsersListContent').innerHTML = `
                            <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">
                                Выберите день в календаре для просмотра пользователей
                            </div>`;
                        return;
                    }

                    const listHtml = `
                        <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #4CAF50; font-size: 14px;">Пользователи (${selectedDayUsers.length})</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">ID</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">Имя</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">Дата</th>
                                            <th style="text-align: right; padding: 8px; color: rgba(255, 255, 255, 0.7);">Баланс</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${selectedDayUsers.map(user => `
                                            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.8);">${user.telegram_id}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.9);">${user.first_name || 'Без имени'}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.6);">${new Date(user.created_at).toLocaleDateString()}</td>
                                                <td style="padding: 8px; text-align: right; color: #FFD700;">${user.balance || 0}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;

                    document.getElementById('newUsersListContent').innerHTML = listHtml;
                };

                // Показываем пустой список изначально
                renderNewUsersList();

            } catch (error) {
                console.error('Ошибка загрузки статистики новых пользователей:', error);
                document.getElementById('newUsersContent').innerHTML = '<p style="color: red;">Ошибка загрузки данных</p>';
            }
        };

        window.closeNewUsersCalendarModal = function() {
            document.getElementById('newUsersCalendarModal').classList.remove('active');
        };

        // Функция календаря отвалившихся пользователей
        window.showChurnedUsersCalendar = async function() {
            document.getElementById('churnedUsersCalendarModal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('last_seen_at', { ascending: true, nullsFirst: false });

                const today = new Date();
                const calendarData = [];
                let selectedDayUsers = [];

                // Создаем календарь за 30 дней для отвалившихся
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    const nextDay = new Date(date);
                    nextDay.setDate(nextDay.getDate() + 1);

                    // Пользователи, которые отвалились в этот день (не были активны 3+ дня от этой даты)
                    const dayChurnedUsers = users?.filter(u => {
                        const lastActive = new Date(u.last_seen_at || u.last_active || u.created_at);
                        const threeDaysFromDate = new Date(date.getTime() + 3 * 24 * 60 * 60 * 1000);

                        // Проверяем что последняя активность была раньше чем 3 дня от текущей даты
                        // И что пользователь был создан раньше чем 3 дня от текущей даты
                        return lastActive < date && lastActive >= new Date(date.getTime() - 24 * 60 * 60 * 1000);
                    }) || [];

                    calendarData.push({
                        date: new Date(date),
                        count: dayChurnedUsers.length,
                        users: dayChurnedUsers,
                        day: date.getDate(),
                        month: date.toLocaleDateString('ru-RU', { month: 'short' }),
                        weekday: date.toLocaleDateString('ru-RU', { weekday: 'short' })
                    });
                }

                // Функция клика по дню
                window.selectChurnedUsersDay = function(dayIndex) {
                    selectedDayUsers = calendarData[dayIndex].users;
                    renderChurnedUsersList();
                };

                // Создаем календарную сетку
                const weeks = [];
                let currentWeek = [];

                const firstDay = calendarData[0].date.getDay();
                const startPadding = firstDay === 0 ? 6 : firstDay - 1;
                for (let i = 0; i < startPadding; i++) {
                    currentWeek.push(null);
                }

                calendarData.forEach((d, index) => {
                    if (currentWeek.length === 7) {
                        weeks.push(currentWeek);
                        currentWeek = [];
                    }
                    currentWeek.push({...d, index});
                });

                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) {
                        currentWeek.push(null);
                    }
                    weeks.push(currentWeek);
                }

                let html = `
                    <div style="padding: 20px;">
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: #FF5722;">Календарь отвалившихся пользователей</h4>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 8px;">
                            ${['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map(day => `
                                <div style="text-align: center; font-size: 11px; color: rgba(255, 255, 255, 0.4); padding: 4px;">${day}</div>
                            `).join('')}
                        </div>
                        ${weeks.map(week => `
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 6px;">
                                ${week.map(day => {
                                    if (!day) return '<div></div>';

                                    const intensity = day.count === 0 ? 0 : Math.min(1, day.count / 3);
                                    const color = day.count === 0
                                        ? 'rgba(255, 255, 255, 0.03)'
                                        : `rgba(255, 87, 34, ${0.2 + intensity * 0.8})`;

                                    const isToday = day.date.toDateString() === today.toDateString();

                                    return `
                                        <div style="
                                            aspect-ratio: 1;
                                            background: ${color};
                                            border: 1px solid ${isToday ? '#FF5722' : 'rgba(255, 255, 255, 0.08)'};
                                            border-radius: 8px;
                                            display: flex;
                                            flex-direction: column;
                                            align-items: center;
                                            justify-content: center;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            position: relative;
                                            padding: 4px;
                                        " title="${day.day} ${day.month}: ${day.count} отвалились"
                                          onclick="selectChurnedUsersDay(${day.index})"
                                          onmouseover="this.style.transform='scale(1.05)'"
                                          onmouseout="this.style.transform='scale(1)'">
                                            <div style="font-size: 12px; color: ${day.count > 0 ? '#fff' : 'rgba(255, 255, 255, 0.6)'}; font-weight: 600;">
                                                ${day.day}
                                            </div>
                                            ${day.count > 0 ? `
                                                <div style="font-size: 10px; color: ${intensity > 0.5 ? '#fff' : '#FF5722'}; margin-top: 2px; font-weight: 700;">
                                                    -${day.count}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}

                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">Меньше</span>
                            <div style="display: flex; gap: 4px;">
                                ${[0, 0.2, 0.4, 0.6, 0.8, 1].map(intensity => `
                                    <div style="
                                        width: 16px;
                                        height: 16px;
                                        background: ${intensity === 0 ? 'rgba(255, 255, 255, 0.03)' : `rgba(255, 87, 34, ${0.2 + intensity * 0.8})`};
                                        border: 1px solid rgba(255, 255, 255, 0.08);
                                        border-radius: 3px;
                                    "></div>
                                `).join('')}
                            </div>
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">Больше</span>
                        </div>
                    </div>`;

                document.getElementById('churnedUsersCalendarContent').innerHTML = html;

                // Функция рендера списка отвалившихся пользователей
                window.renderChurnedUsersList = function() {
                    if (selectedDayUsers.length === 0) {
                        document.getElementById('churnedUsersListContent').innerHTML = `
                            <div style="text-align: center; color: rgba(255, 255, 255, 0.5); padding: 20px;">
                                Выберите день в календаре для просмотра отвалившихся пользователей
                            </div>`;
                        return;
                    }

                    const listHtml = `
                        <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #FF5722; font-size: 14px;">Отвалившиеся пользователи (${selectedDayUsers.length})</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">ID</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">Имя</th>
                                            <th style="text-align: left; padding: 8px; color: rgba(255, 255, 255, 0.7);">Последняя активность</th>
                                            <th style="text-align: right; padding: 8px; color: rgba(255, 255, 255, 0.7);">Баланс</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${selectedDayUsers.map(user => `
                                            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.8);">${user.telegram_id}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.9);">${user.first_name || 'Без имени'}</td>
                                                <td style="padding: 8px; color: rgba(255, 255, 255, 0.6);">${new Date(user.last_seen_at || user.created_at).toLocaleDateString()}</td>
                                                <td style="padding: 8px; text-align: right; color: #FFD700;">${user.balance || 0}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;

                    document.getElementById('churnedUsersListContent').innerHTML = listHtml;
                };

                // Показываем пустой список изначально
                renderChurnedUsersList();

            } catch (error) {
                console.error('Ошибка загрузки статистики отвалившихся:', error);
                document.getElementById('churnedContent').innerHTML = '<p style="color: red;">Ошибка загрузки данных</p>';
            }
        };

        window.closeChurnedUsersCalendarModal = function() {
            document.getElementById('churnedUsersCalendarModal').classList.remove('active');
        };

        window.showNoTasksStats = async function() {
            document.getElementById('noTasksModal').classList.add('active');

            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*');

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Пользователи, которые были активны сегодня, но не выполнили задания
                const noTasksUsers = users.filter(u => {
                    const lastActive = u.last_seen_at || u.last_active || u.last_login;
                    return lastActive && new Date(lastActive) >= today && u.balance_ar <= 50;
                });

                let html = `
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(241, 196, 15, 0.1); border-radius: 10px;">
                        <p style="margin: 0; font-size: 13px;">Всего пользователей без заданий сегодня: <strong style="color: #f1c40f;">${noTasksUsers.length}</strong></p>
                    </div>
                    <table style="width: 100%; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 10px;">Пользователь</th>
                                <th style="text-align: center; padding: 10px;">ID</th>
                                <th style="text-align: center; padding: 10px;">Последняя активность</th>
                                <th style="text-align: center; padding: 10px;">Баланс</th>
                            </tr>
                        </thead>
                        <tbody>`;

                noTasksUsers.forEach(user => {
                    const lastActive = user.last_seen_at || user.last_active || user.last_login;
                    html += `
                        <tr style="border-top: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${createAvatar(user)}
                                    <span>${user.first_name || 'Без имени'}</span>
                                </div>
                            </td>
                            <td style="text-align: center; padding: 10px; color: rgba(255,255,255,0.6);">${user.telegram_id}</td>
                            <td style="text-align: center; padding: 10px;">${new Date(lastActive).toLocaleTimeString('ru-RU')}</td>
                            <td style="text-align: center; padding: 10px;">${user.balance_ar} AR</td>
                        </tr>`;
                });

                html += `
                        </tbody>
                    </table>`;

                document.getElementById('noTasksContent').innerHTML = html;

            } catch (error) {
                console.error('Ошибка загрузки статистики без заданий:', error);
                document.getElementById('noTasksContent').innerHTML = '<p style="color: red;">Ошибка загрузки данных</p>';
            }
        };

        window.closeNoTasksModal = function() {
            document.getElementById('noTasksModal').classList.remove('active');
        };

        // Запуск
        init();
    </script>

    <!-- Модальные окна для календарей -->
    <!-- Календарь новых пользователей -->
    <div id="newUsersCalendarModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Новые пользователи - календарь</h3>
                <button onclick="closeNewUsersCalendarModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">✕</button>
            </div>
            <div class="modal-body">
                <div id="newUsersCalendarContent">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div id="newUsersListContent" style="margin-top: 20px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Календарь отвалившихся пользователей -->
    <div id="churnedUsersCalendarModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Отвалившиеся пользователи - календарь</h3>
                <button onclick="closeChurnedUsersCalendarModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">✕</button>
            </div>
            <div class="modal-body">
                <div id="churnedUsersCalendarContent">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div id="churnedUsersListContent" style="margin-top: 20px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно статистики отвалившихся -->
    <div id="churnedModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Отвалившиеся пользователи</h3>
                <button onclick="closeChurnedModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">✕</button>
            </div>
            <div class="modal-body">
                <div id="churnedContent" style="max-height: 500px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно статистики без заданий -->
    <div id="noTasksModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Пользователи без заданий</h3>
                <button onclick="closeNoTasksModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 28px;
                    height: 28px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 18px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    line-height: 1;
                    padding: 0;
                ">✕</button>
            </div>
            <div class="modal-body">
                <div id="noTasksContent" style="max-height: 500px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>