# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏

## –ß—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. ‚ö° –≠–Ω–µ—Ä–≥–∏—è (1000 ‚Üí 100)
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: energy = 100, energy_max = 100
- –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ users –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### 2. üëÜ –§–æ—Ä–º—É–ª–∞ —Ç–∞–ø–∞ (—É–±—Ä–∞—Ç—å level)
**–ë—ã–ª–æ:** `(level + 1) * taps` ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
**–°—Ç–∞–ª–æ:** `(tap_power + tap_bonus_—Å–∫–∏–Ω–∞) * taps`

**–ü—Ä–∏–º–µ—Ä—ã:**
- –Æ–∑–µ—Ä (tap_bonus=1): 1 —Ç–∞–ø = **1 BUL**
- –†—ç–ø–µ—Ä (tap_bonus=2): 1 —Ç–∞–ø = **2 BUL**
- –ë–∞–Ω–∫–∏—Ä (tap_bonus=4): 1 —Ç–∞–ø = **4 BUL**
- –ö—Ä–∏–ø—Ç–∞–Ω (tap_bonus=10): 1 —Ç–∞–ø = **10 BUL**

### 3. üí∞ –ü–æ–∫—É–ø–∫–∞ —Å–∫–∏–Ω–æ–≤ (buy_skin)
–¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–æ–±–µ –≤–∞–ª—é—Ç—ã:**
- BUL —Å–∫–∏–Ω—ã (id 1-12): —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è `balance_bul`
- AR —Å–∫–∏–Ω—ã (id 13-15): —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è `balance_ar`

### 4. üé≠ –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ —Å–∫–∏–Ω–æ–≤ (equip_skin)
–ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç:
- `user_skins.is_equipped` (—Å—Ç–∞—Ä—ã–π ‚Üí false, –Ω–æ–≤—ã–π ‚Üí true)
- `users.active_skin_id` (–Ω–æ–≤—ã–π skin_id)

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å Supabase SQL Editor
```
https://supabase.com/dashboard/project/syxjkircmiwpnpagznay/sql/new
```

### –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL
–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª `fix_all_game_mechanics.sql` –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –∫–æ–¥

### –®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–∏—Ç—å
–í—Å—Ç–∞–≤–∏—Ç—å –≤ SQL Editor –∏ –Ω–∞–∂–∞—Ç—å **RUN** –∏–ª–∏ **Ctrl+Enter**

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö SQL Editor –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```
total_users | avg_energy | avg_energy_max
------------|------------|---------------
     X      |    100     |      100
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–π —Ç–∞–ø –∞–¥–º–∏–Ω–∞
```
energy | energy_max | balance_bul | bul_earned
-------|------------|-------------|------------
  99   |    100     |   X+1       |     1
```
(–∏–ª–∏ –±–æ–ª—å—à–µ, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —Å–∫–∏–Ω —Å –±–æ–Ω—É—Å–æ–º)

### 3. –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–∏–Ω–æ–≤
15 —Å—Ç—Ä–æ–∫ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏:
- ID 1-12: BUL —Å–∫–∏–Ω—ã (price_bul > 0, price_ar = 0)
- ID 13-15: AR —Å–∫–∏–Ω—ã (price_bul = 0, price_ar > 0)

### 4. –°–∫–∏–Ω—ã –∞–¥–º–∏–Ω–∞
–°–ø–∏—Å–æ–∫ —Å–∫–∏–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 190202791

---

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ —Ñ–æ—Ä–º—É–ª–µ —Ç–∞–ø–∞

### ‚ùå –°—Ç–∞—Ä–∞—è (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
```sql
v_bul_earned := p_taps * (COALESCE(v_user.level, 1) + 1);
```
**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `level` (–∫–æ—Ç–æ—Ä–æ–≥–æ –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ –∏–≥—Ä–µ)
- –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –±–æ–Ω—É—Å—ã —Å–∫–∏–Ω–æ–≤
- –î–∞—ë—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

### ‚úÖ –ù–æ–≤–∞—è (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
```sql
-- –ü–æ–ª—É—á–∏—Ç—å tap_bonus –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∫–∏–Ω–∞
SELECT COALESCE(s.tap_bonus, 0) INTO v_skin_bonus
FROM skins s
WHERE s.id = v_user.active_skin_id;

-- –ù–∞–≥—Ä–∞–¥–∞ = –±–∞–∑–æ–≤—ã–π tap_power + –±–æ–Ω—É—Å —Å–∫–∏–Ω–∞
v_bul_earned := p_taps * (COALESCE(v_user.tap_power, 1) + v_skin_bonus);
```
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `tap_power` (–±–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ —Ç–∞–ø–∞)
- –î–æ–±–∞–≤–ª—è–µ—Ç `tap_bonus` –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∫–∏–Ω–∞
- –£–±—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ —É—Ä–æ–≤–Ω–µ–π (XP, level)
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è: —Ä–µ–¥–∫–∏–µ —Å–∫–∏–Ω—ã –¥–∞—é—Ç –±–æ–ª—å—à–µ BUL

---

## –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–≥—Ä–∞–¥ –ø–æ —Å–∫–∏–Ω–∞–º

| ID | –°–∫–∏–Ω | –†–µ–¥–∫–æ—Å—Ç—å | tap_bonus | 1 —Ç–∞–ø | 10 —Ç–∞–ø–æ–≤ |
|----|------|----------|-----------|-------|----------|
| 1 | –Æ–∑–µ—Ä | default | 1 | 1 BUL | 10 BUL |
| 2 | –ì–µ–π–º–µ—Ä | common | 2 | 2 BUL | 20 BUL |
| 3 | –°–ø–æ—Ä—Ç—Å–º–µ–Ω | common | 2 | 2 BUL | 20 BUL |
| 4 | –†—ç–ø–µ—Ä | common | 2 | 2 BUL | 20 BUL |
| 5 | –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç | uncommon | 3 | 3 BUL | 30 BUL |
| 6 | –î–∏–∑–∞–π–Ω–µ—Ä | uncommon | 3 | 3 BUL | 30 BUL |
| 7 | –Æ—Ä–∏—Å—Ç | uncommon | 3 | 3 BUL | 30 BUL |
| 8 | –ü–æ–ª–∏—Ç–∏–∫ | rare | 4 | 4 BUL | 40 BUL |
| 9 | –ë–∞–Ω–∫–∏—Ä | rare | 4 | 4 BUL | 40 BUL |
| 10 | –ú–∞—Ñ–∏–æ–∑–∏ | rare | 4 | 4 BUL | 40 BUL |
| 11 | –û–ª–∏–≥–∞—Ä—Ö | epic | 6 | 6 BUL | 60 BUL |
| 12 | –ö—Ä–∏–ø—Ç–∞–Ω | legendary | 10 | 10 BUL | 100 BUL |
| 13 | –ß–µ–º–ø–∏–æ–Ω UFC | epic | 6 | 6 BUL | 60 BUL |
| 14 | –õ–æ–∫–∏ | epic | 6 | 6 BUL | 60 BUL |
| 15 | –í–î–í—à–Ω–∏–∫ | legendary | 10 | 10 BUL | 100 BUL |

*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: tap_power –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 1, –ø–æ—ç—Ç–æ–º—É –Ω–∞–≥—Ä–∞–¥–∞ = 1 + tap_bonus - 1 = tap_bonus*

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º tap_power —Å—Ç–∞–Ω–µ—Ç > 1, —Ñ–æ—Ä–º—É–ª–∞ –±—É–¥–µ—Ç:
**–ù–∞–≥—Ä–∞–¥–∞ = (tap_power + tap_bonus) * taps**

---

## –ü–æ–∫—É–ø–∫–∞ —Å–∫–∏–Ω–æ–≤

### BUL —Å–∫–∏–Ω—ã (ID 1-12)
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ BUL
IF v_user.balance_bul < v_skin.price_bul THEN
    RETURN 'INSUFFICIENT_BUL';
END IF;

-- –°–ø–∏—Å–∞–Ω–∏–µ BUL
UPDATE users SET balance_bul = balance_bul - v_skin.price_bul;
```

### AR —Å–∫–∏–Ω—ã (ID 13-15)
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ AR
IF v_user.balance_ar < v_skin.price_ar THEN
    RETURN 'INSUFFICIENT_AR';
END IF;

-- –°–ø–∏—Å–∞–Ω–∏–µ AR
UPDATE users SET balance_ar = balance_ar - v_skin.price_ar;
```

---

## –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ —Å–∫–∏–Ω–æ–≤

```sql
-- 1. –°–Ω—è—Ç—å is_equipped —Å–æ —Å—Ç–∞—Ä–æ–≥–æ
UPDATE user_skins SET is_equipped = false
WHERE telegram_id = X AND skin_id = old_skin_id;

-- 2. –ù–∞–¥–µ—Ç—å –Ω–æ–≤—ã–π
UPDATE user_skins SET is_equipped = true
WHERE telegram_id = X AND skin_id = new_skin_id;

-- 3. –û–±–Ω–æ–≤–∏—Ç—å active_skin_id
UPDATE users SET active_skin_id = new_skin_id
WHERE telegram_id = X;
```

---

## –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ Telegram Mini App
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ:
   - –≠–Ω–µ—Ä–≥–∏—è = 100/100
   - –ó–∞ 1 —Ç–∞–ø –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ BUL
   - –ú–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å BUL —Å–∫–∏–Ω—ã –∑–∞ BUL
   - –ú–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å AR —Å–∫–∏–Ω—ã –∑–∞ AR (–µ—Å–ª–∏ –µ—Å—Ç—å –±–∞–ª–∞–Ω—Å)
   - –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ —Å–∫–∏–Ω–æ–≤ –º–µ–Ω—è–µ—Ç –±–æ–Ω—É—Å —Ç–∞–ø–∞

---

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
2. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Supabase SQL Editor
3. –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –∫–æ–Ω—Ü–∞ `fix_all_game_mechanics.sql`
