// –ü—Ä–æ—Å—Ç–æ–π –±–æ—Ç –¥–ª—è AR ARENA —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
const { Telegraf, Markup } = require('telegraf');
const express = require('express');
const { createClient } = require('@supabase/supabase-js');
const crypto = require('crypto');
const fetch = require('node-fetch');

// –¢–æ–∫–µ–Ω –±–æ—Ç–∞ @ARARENA_BOT
const BOT_TOKEN = '***REMOVED***';

// Supabase credentials
const SUPABASE_URL = 'https://syxjkircmiwpnpagznay.supabase.co';
const SUPABASE_SERVICE_KEY = '***REMOVED***';

// Tribute API Key (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook –ø–æ–¥–ø–∏—Å–∏)
// TODO: –ü–æ–ª—É—á–∏—Ç—å –≤ Tribute Dashboard ‚Üí Settings ‚Üí API Key
const TRIBUTE_API_KEY = process.env.TRIBUTE_API_KEY || '';

const bot = new Telegraf(BOT_TOKEN);
const app = express();
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

app.use(express.json());

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
bot.start((ctx) => {
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ –∫–æ–º–∞–Ω–¥—ã /start
    const startParam = ctx.message.text.split(' ')[1] || '';

    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Mini App
    // –û–¢–ö–ê–¢: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π index.html (iframe trick –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram)
    const cacheBuster = Date.now();
    let webAppUrl = `https://ararena.pro/index.html?v=${cacheBuster}`;

    if (startParam) {
        // Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä —á–µ—Ä–µ–∑ startapp –≤ URL
        webAppUrl = `https://ararena.pro/index.html?startapp=${startParam}&v=${cacheBuster}`;
        console.log(`–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º: ${startParam}`);
        console.log(`URL –¥–ª—è WebApp: ${webAppUrl}`);
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Mini App
    ctx.reply(
        'üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AR ARENA!\n\n' +
        'üí∞ –ü–æ–ª—É—á–∏—Ç–µ 100 AR –±–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n' +
        'üéØ –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –≤—ã–ø–æ–ª–Ω—è—è –∑–∞–¥–∞–Ω–∏—è\n' +
        'üèÜ –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π:\n' +
        '   ‚Ä¢ 200 AR –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ (L1)\n' +
        '   ‚Ä¢ 100 AR –∑–∞ –¥—Ä—É–∑–µ–π –≤–∞—à–∏—Ö –¥—Ä—É–∑–µ–π (L2)\n\n' +
        '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞:',
        Markup.inlineKeyboard([
            Markup.button.webApp('üéÆ –û—Ç–∫—Ä—ã—Ç—å AR ARENA', webAppUrl)
        ])
    );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥
bot.on('text', (ctx) => {
    const cacheBuster = Date.now();
    ctx.reply(
        '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å AR ARENA',
        Markup.inlineKeyboard([
            Markup.button.webApp('üéÆ –û—Ç–∫—Ä—ã—Ç—å AR ARENA', `https://ararena.pro/index.html?v=${cacheBuster}`)
        ])
    );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err, ctx) => {
    console.error('[ERROR]', err);
});

// ============================================
// GIVEAWAY WINNER NOTIFICATIONS
// ============================================

// Endpoint –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º
app.post('/api/notify-winners', async (req, res) => {
    try {
        const { giveawayId } = req.body;

        if (!giveawayId) {
            return res.status(400).json({ error: 'giveawayId is required' });
        }

        console.log(`üì© –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º —Ä–æ–∑—ã–≥—Ä—ã—à–∞ ${giveawayId}...`);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
        const { data: giveaway, error: giveawayError } = await supabase
            .from('giveaways')
            .select('*')
            .eq('id', giveawayId)
            .single();

        if (giveawayError || !giveaway) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞:', giveawayError);
            return res.status(404).json({ error: 'Giveaway not found' });
        }

        if (!giveaway.winners || giveaway.winners.length === 0) {
            return res.status(400).json({ error: 'No winners in this giveaway' });
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–º—É –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
        const notificationResults = [];

        for (const winner of giveaway.winners) {
            try {
                const result = await sendWinnerNotification(winner, giveaway);
                notificationResults.push({
                    userId: winner.userId,
                    success: result.success,
                    error: result.error
                });
            } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${winner.userId}:`, error);
                notificationResults.push({
                    userId: winner.userId,
                    success: false,
                    error: error.message
                });
            }
        }

        const successCount = notificationResults.filter(r => r.success).length;

        console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successCount}/${giveaway.winners.length} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`);

        res.json({
            success: true,
            notified: successCount,
            total: giveaway.winners.length,
            results: notificationResults
        });

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤ /api/notify-winners:', error);
        res.status(500).json({ error: error.message });
    }
});

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
async function sendWinnerNotification(winner, giveaway) {
    try {
        const placeEmojis = ['ü•á', 'ü•à', 'ü•â'];
        const placeEmoji = placeEmojis[winner.place - 1] || 'üèÖ';

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–∏–∑
        let prizeText = '';
        const prize = winner.prize;

        if (typeof prize === 'number') {
            prizeText = `${prize.toLocaleString()} AR`;
        } else if (prize.amount !== undefined) {
            prizeText = `${prize.amount.toLocaleString()} ${prize.currency || 'AR'}`;
        } else if (prize.description) {
            prizeText = prize.description;
        } else {
            prizeText = prize.toString();
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const message = `
üéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! üéâ

–í—ã –∑–∞–Ω—è–ª–∏ ${placeEmoji} ${winner.place} –º–µ—Å—Ç–æ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ:
"${giveaway.title}"

üéÅ –í–∞—à –ø—Ä–∏–∑: ${prizeText}
üé´ –í—ã–∏–≥—Ä—ã—à–Ω—ã–π –±–∏–ª–µ—Ç: #${String(winner.ticketNumber).padStart(5, '0')}

${giveaway.type === 'money' ? 'üí∞ –ü—Ä–∏–∑ —É–∂–µ –∑–∞—á–∏—Å–ª–µ–Ω –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å!' : 'üìß –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞!'}

–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π! üéä
        `.trim();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await bot.telegram.sendMessage(winner.userId, message, {
            parse_mode: 'HTML',
            reply_markup: {
                inline_keyboard: [
                    [{
                        text: 'üéÆ –û—Ç–∫—Ä—ã—Ç—å AR ARENA',
                        web_app: { url: `https://ararena.pro/index.html?v=${Date.now()}` }
                    }],
                    [{
                        text: 'üèÜ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
                        web_app: { url: `https://ararena.pro/giveaway-detail.html?id=${giveaway.id}` }
                    }]
                ]
            }
        });

        console.log(`‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${winner.userId}`);

        return { success: true };

    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${winner.userId}:`, error);
        return { success: false, error: error.message };
    }
}

// ============================================
// LAVUTOP PAYMENT WEBHOOK
// ============================================

// –õ–∞–≤—É–¢–û–ü API Key
const LAVUTOP_API_KEY = process.env.LAVUTOP_API_KEY || 'zB6gEepcNeys6kwRR2Kkg2UbDRtMG3uLAjZSbJIPDAbpTpCtHwXPefwUqZFsGWyA';

// –ú–∞–ø–ø–∏–Ω–≥ Product ID ‚Üí AR amount (–õ–∞–≤—É–¢–û–ü –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã)
const LAVUTOP_PRODUCTS = {
    '836adba6-5365-40f6-a646-aef9621f3af4': { ar: 100, price: 100, bonus: '' },                    // –¢–ï–°–¢-–î–†–ê–ô–í
    '71de99f8-fa1c-4208-8ca8-959584c8c2ba': { ar: 600, price: 499, bonus: '(+20% –ë–û–ù–£–°)' },      // –°–¢–ê–†–¢
    'ee216776-d686-4144-b568-5df9dc03fa92': { ar: 1400, price: 999, bonus: '(+40% –ë–û–ù–£–°)' },     // –ü–†–û–î–í–ò–ù–£–¢–´–ô
    '2db41119-95f8-4487-8df0-f6050f53ae84': { ar: 5200, price: 2999, bonus: '(+80% –ë–û–ù–£–°)' },    // –≠–ö–°–ü–ï–†–¢
    'c9c9c7d0-8d36-4fe9-801d-b1f05053512f': { ar: 20000, price: 9999, bonus: '(+100% –ë–û–ù–£–°)' }   // –ú–ê–°–¢–ï–†
};

// Fallback –º–∞–ø–ø–∏–Ω–≥ –ø–æ —Ü–µ–Ω–µ (–µ—Å–ª–∏ product_id –Ω–µ –Ω–∞–π–¥–µ–Ω)
const LAVUTOP_PRICE_TO_AR = {
    100: { ar: 100, bonus: '' },
    499: { ar: 600, bonus: '(+20% –ë–û–ù–£–°)' },
    999: { ar: 1400, bonus: '(+40% –ë–û–ù–£–°)' },
    2999: { ar: 5200, bonus: '(+80% –ë–û–ù–£–°)' },
    9999: { ar: 20000, bonus: '(+100% –ë–û–ù–£–°)' }
};

app.post('/api/webhook/lavutop', async (req, res) => {
    try {
        const payload = req.body;
        const authHeader = req.headers['authorization'];

        console.log('üì• LavuTOP Webhook received:', JSON.stringify(payload, null, 2));
        console.log('üîê Authorization header:', authHeader);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ API Key
        if (authHeader) {
            const providedKey = authHeader.replace('Bearer ', '').trim();
            if (providedKey !== LAVUTOP_API_KEY) {
                console.error('‚ùå Invalid API Key!');
                return res.status(403).json({ error: 'Unauthorized' });
            }
            console.log('‚úÖ API Key verified');
        } else {
            console.warn('‚ö†Ô∏è No authorization header provided');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if (!payload || !payload.status || !payload.order_id) {
            console.error('‚ùå Invalid webhook payload');
            return res.status(400).json({ error: 'Invalid payload' });
        }

        const {
            order_id,      // ID –∑–∞–∫–∞–∑–∞
            status,        // success / fail / pending
            amount,        // –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
            product_id,    // ID –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –õ–∞–≤—É–¢–û–ü
            user_id,       // Telegram User ID –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
            invoice_id     // ID —Å—á–µ—Ç–∞ –≤ LavuTOP
        } = payload;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
        if (status !== 'success') {
            console.log(`‚ö†Ô∏è Payment ${order_id} status: ${status}`);
            return res.status(200).json({ message: 'Payment not successful' });
        }

        // –ü–æ–ª—É—á–∞–µ–º telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const telegramId = user_id;

        if (!telegramId) {
            console.error('‚ùå Missing user_id (telegram_id)');
            return res.status(400).json({ error: 'Missing user_id' });
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ AR –ø–æ product_id
        let arAmount = 0;
        let bonusText = '';
        let price = amount;

        if (product_id && LAVUTOP_PRODUCTS[product_id]) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–ø–ø–∏–Ω–≥ –ø–æ Product ID
            const productConfig = LAVUTOP_PRODUCTS[product_id];
            arAmount = productConfig.ar;
            bonusText = productConfig.bonus;
            console.log(`‚úÖ Product found: ${product_id} ‚Üí ${arAmount} AR ${bonusText}`);
        } else if (amount && LAVUTOP_PRICE_TO_AR[amount]) {
            // Fallback: –º–∞–ø–ø–∏–Ω–≥ –ø–æ —Ü–µ–Ω–µ
            const priceConfig = LAVUTOP_PRICE_TO_AR[amount];
            arAmount = priceConfig.ar;
            bonusText = priceConfig.bonus;
            console.log(`‚úÖ Price matched: ${amount}‚ÇΩ ‚Üí ${arAmount} AR ${bonusText}`);
        } else {
            console.error(`‚ùå Unknown product_id (${product_id}) and price (${amount})`);
            return res.status(400).json({ error: 'Unknown product or price' });
        }

        console.log(`‚úÖ Processing payment for telegram_id: ${telegramId}, AR: ${arAmount}`);

        // 1. –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ RPC
        const { data: rpcResult, error: updateError } = await supabase.rpc('increment_balance', {
            user_id_input: telegramId,
            amount_input: arAmount
        });

        if (updateError) {
            console.error('‚ö†Ô∏è RPC failed, trying direct update:', updateError);

            // Fallback: –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
            const { data: user, error: fetchError } = await supabase
                .from('users')
                .select('balance_ar, id')
                .eq('telegram_id', telegramId)
                .single();

            if (fetchError) {
                console.error('‚ùå Error fetching user:', fetchError);
                return res.status(500).json({ error: 'User not found' });
            }

            const currentBalance = user ? (user.balance_ar || 0) : 0;
            const newBalance = currentBalance + arAmount;

            const { error: directUpdateError } = await supabase
                .from('users')
                .update({ balance_ar: newBalance })
                .eq('telegram_id', telegramId);

            if (directUpdateError) {
                console.error('‚ùå Direct update failed:', directUpdateError);
                return res.status(500).json({ error: 'Database error' });
            }

            console.log(`‚úÖ Direct update: ${currentBalance} ‚Üí ${newBalance} AR`);
        } else {
            console.log(`‚úÖ RPC result:`, rpcResult);
        }

        // 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        try {
            await supabase.rpc('record_purchase_transaction', {
                user_telegram_id: telegramId,
                amount_ar: arAmount,
                price_usd: parseFloat(amount),
                package_name: `LavuTOP Package ${arAmount} AR`
            });
            console.log(`üìù Transaction recorded`);
        } catch (txError) {
            console.error('‚ö†Ô∏è Failed to record transaction:', txError);
        }

        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        try {
            const bonusText = LAVUTOP_PRICE_TO_AR[parseFloat(amount)]?.bonus || '';
            await bot.telegram.sendMessage(telegramId,
                `üí≥ <b>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</b>\n\n` +
                `–ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –∑–∞—á–∏—Å–ª–µ–Ω–æ: <b>${arAmount.toLocaleString()} AR</b> ${bonusText}\n\n` +
                `–ü—Ä–∏—è—Ç–Ω–æ–π –∏–≥—Ä—ã! üöÄ`,
                { parse_mode: 'HTML' }
            );
            console.log(`‚úÖ Notification sent to user ${telegramId}`);
        } catch (notifyError) {
            console.error('‚ö†Ô∏è Failed to send notification:', notifyError.message);
        }

        return res.status(200).json({
            success: true,
            message: 'Payment processed'
        });

    } catch (error) {
        console.error('‚ùå LavuTOP Webhook processing error:', error);
        return res.status(500).json({ error: 'Internal server error' });
    }
});

// ============================================
// TRIBUTE PAYMENT WEBHOOK
// ============================================

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ HMAC-SHA256 –ø–æ–¥–ø–∏—Å–∏ –æ—Ç Tribute
function verifyTributeSignature(payload, signature, apiKey) {
    if (!apiKey) {
        console.warn('‚ö†Ô∏è TRIBUTE_API_KEY not set, skipping signature verification');
        return true; // –í dev —Ä–µ–∂–∏–º–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    }

    const hmac = crypto.createHmac('sha256', apiKey);
    hmac.update(payload);
    const expectedSignature = hmac.digest('hex');

    return signature === expectedSignature;
}

// –ú–∞–ø–ø–∏–Ω–≥ —Ü–µ–Ω –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ AR
const PRICE_TO_AR = {
    0.99: { ar: 100, bonus: '' },
    4.99: { ar: 600, bonus: '(+20% Bonus)' },
    9.99: { ar: 1400, bonus: '(+40% Bonus)' },
    29.00: { ar: 5200, bonus: '(+80% Bonus)' },
    99.00: { ar: 20000, bonus: '(x2 Bonus)' }
};

app.post('/api/webhook/tribute', async (req, res) => {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å—å –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        const signature = req.headers['trbt-signature'];
        const rawBody = JSON.stringify(req.body);

        console.log('üí∞ Received Tribute Webhook:');
        console.log('   Headers:', req.headers);
        console.log('   Body:', rawBody);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å (–µ—Å–ª–∏ API key –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
        if (signature && !verifyTributeSignature(rawBody, signature, TRIBUTE_API_KEY)) {
            console.error('‚ùå Invalid signature!');
            return res.status(403).send('Invalid signature');
        }

        const { name, payload } = req.body;

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–µ –ø–æ–∫—É–ø–∫–∏ digital product
        if (name !== 'new_digital_product') {
            console.log(`‚ÑπÔ∏è Ignored event type: ${name}`);
            return res.status(200).send('Ignored');
        }

        // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ payload —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Tribute
        const { product_id, amount, currency, user_id, telegram_user_id } = payload || {};

        if (!amount || !telegram_user_id) {
            console.error('‚ùå Invalid payload structure:', payload);
            return res.status(400).send('Invalid payload');
        }

        const userId = telegram_user_id; // Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const price = parseFloat(amount);

        console.log(`üë§ Processing payment for User ${userId}:`);
        console.log(`   Product ID: ${product_id}`);
        console.log(`   Amount: ${price} ${currency}`);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ AR –º–æ–Ω–µ—Ç –ø–æ —Ü–µ–Ω–µ
        const priceConfig = PRICE_TO_AR[price];
        let arAmount = 0;
        let bonusText = '';

        if (priceConfig) {
            arAmount = priceConfig.ar;
            bonusText = priceConfig.bonus;
        } else {
            // Fallback: 100 AR per $1
            arAmount = Math.floor(price * 100);
            console.warn(`‚ö†Ô∏è Unknown price point ${price}, using default rate: ${arAmount} AR`);
        }

        if (arAmount > 0) {
            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ Supabase —á–µ—Ä–µ–∑ RPC
            console.log(`üìä Crediting ${arAmount} AR to user ${userId}...`);

            const { data: rpcResult, error: updateError } = await supabase.rpc('increment_balance', {
                user_id_input: userId,
                amount_input: arAmount
            });

            if (updateError) {
                console.error('‚ö†Ô∏è RPC failed, trying direct update:', updateError);

                // Fallback: –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
                const { data: user, error: fetchError } = await supabase
                    .from('users')
                    .select('balance_ar')
                    .eq('telegram_id', userId)
                    .single();

                if (fetchError) {
                    console.error('‚ùå Error fetching user:', fetchError);
                    return res.status(500).send('User not found');
                }

                const currentBalance = user ? (user.balance_ar || 0) : 0;
                const newBalance = currentBalance + arAmount;

                const { error: directUpdateError } = await supabase
                    .from('users')
                    .update({ balance_ar: newBalance })
                    .eq('telegram_id', userId);

                if (directUpdateError) {
                    console.error('‚ùå Direct update failed:', directUpdateError);
                    return res.status(500).send('Database error');
                }

                console.log(`‚úÖ Direct update: ${currentBalance} ‚Üí ${newBalance} AR`);
            } else {
                console.log(`‚úÖ RPC result:`, rpcResult);
            }

            // 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            try {
                await supabase.rpc('record_purchase_transaction', {
                    user_telegram_id: userId,
                    amount_ar: arAmount,
                    price_usd: price,
                    package_name: `Package $${price}`
                });
                console.log(`üìù Transaction recorded`);
            } catch (txError) {
                console.error('‚ö†Ô∏è Failed to record transaction:', txError);
            }

            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
            try {
                await bot.telegram.sendMessage(userId,
                    `üí≥ <b>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</b>\n\n` +
                    `–ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –∑–∞—á–∏—Å–ª–µ–Ω–æ: <b>${arAmount.toLocaleString()} AR</b> ${bonusText}\n\n` +
                    `–ü—Ä–∏—è—Ç–Ω–æ–π –∏–≥—Ä—ã! üöÄ`,
                    { parse_mode: 'HTML' }
                );
                console.log(`‚úÖ Notification sent to user ${userId}`);
            } catch (notifyError) {
                console.error('‚ö†Ô∏è Failed to send notification:', notifyError.message);
            }
        }

        res.status(200).send('OK');

    } catch (error) {
        console.error('‚ùå Webhook Error:', error);
        res.status(500).send('Server Error');
    }
});

// ============================================
// LAVA PAYMENT API
// ============================================

const LAVA_API_KEY = 'OZiQUDFJAz5eunrbUrUjA2ToAYjCgXWqaxzK7ibQA23uk3VoR6ijcGEO9Y9lfPjM';
const LAVA_OFFER_ID = '836adba6-5365-40f6-a646-aef9621f3af4';
const LAVA_API_URL = 'https://gate.lava.top/api/v2/invoice';

app.post('/api/lava-create-invoice', async (req, res) => {
  // CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  try {
    const { email, telegramId, amount, currency = 'RUB' } = req.body;

    if (!email || !amount) {
      return res.status(400).json({
        error: 'Missing required fields',
        required: ['email', 'amount']
      });
    }

    if (amount < 1) {
      return res.status(400).json({ error: 'Amount must be at least 1' });
    }

    const clientUTM = telegramId ? `telegram_id=${telegramId}` : undefined;

    console.log('üí≥ Creating Lava invoice:', { email, telegramId, amount, currency });

    const response = await fetch(LAVA_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Api-Key': LAVA_API_KEY
      },
      body: JSON.stringify({
        email,
        offerId: LAVA_OFFER_ID,
        currency,
        buyerLanguage: 'RU',
        amount: parseFloat(amount),
        clientUTM
      })
    });

    const data = await response.json();

    if (!response.ok) {
      console.error('‚ùå Lava API error:', data);
      return res.status(response.status).json({
        error: 'Failed to create invoice',
        details: data
      });
    }

    console.log('‚úÖ Invoice created:', {
      email,
      telegramId,
      amount,
      contractId: data.contractId,
      paymentUrl: data.paymentUrl
    });

    return res.status(200).json({
      ok: true,
      paymentUrl: data.paymentUrl,
      contractId: data.contractId,
      amount: data.amount,
      currency: data.currency
    });

  } catch (error) {
    console.error('‚ùå Invoice creation error:', error);
    return res.status(500).json({
      error: 'Internal server error',
      message: error.message
    });
  }
});

// Health check endpoint
app.get('/api/health', (req, res) => {
    res.json({ status: 'ok', bot: 'running', timestamp: new Date().toISOString() });
});

// –ó–∞–ø—É—Å–∫ Express —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
    console.log(`üåê HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    console.log(`üì° Endpoint –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: http://localhost:${PORT}/api/notify-winners`);
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
(async () => {
    try {
        // –£–¥–∞–ª—è–µ–º webhook –µ—Å–ª–∏ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        await bot.telegram.deleteWebhook({ drop_pending_updates: true });
        console.log('‚úÖ Webhook —É–¥–∞–ª—ë–Ω, pending updates –æ—á–∏—â–µ–Ω—ã');

        // –ó–∞–ø—É—Å–∫–∞–µ–º polling
        await bot.launch({
            dropPendingUpdates: true,
            allowedUpdates: ['message', 'callback_query']
        });

        console.log('‚úÖ –ë–æ—Ç AR ARENA –∑–∞–ø—É—â–µ–Ω!');
        console.log('–†–µ–∂–∏–º: Long Polling');
        console.log('–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:', new Date().toISOString());
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);
        process.exit(1);
    }
})();

// –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));